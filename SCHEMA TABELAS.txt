-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.saas_activity_log (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  client_id uuid NOT NULL,
  action text NOT NULL,
  details jsonb DEFAULT '{}'::jsonb,
  source text DEFAULT 'portal'::text CHECK (source = ANY (ARRAY['portal'::text, 'whatsapp'::text, 'api'::text, 'system'::text])),
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_activity_log_pkey PRIMARY KEY (id),
  CONSTRAINT saas_activity_log_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_appointments (
  id bigint NOT NULL DEFAULT nextval('saas_appointments_id_seq'::regclass),
  client_id uuid NOT NULL,
  title text NOT NULL,
  description text,
  location text,
  start_at timestamp with time zone NOT NULL,
  end_at timestamp with time zone NOT NULL,
  all_day boolean DEFAULT false,
  notify_before integer DEFAULT 30,
  priority text DEFAULT 'media'::text CHECK (priority = ANY (ARRAY['baixa'::text, 'media'::text, 'alta'::text])),
  status text DEFAULT 'scheduled'::text CHECK (status = ANY (ARRAY['scheduled'::text, 'completed'::text, 'cancelled'::text])),
  color text DEFAULT '#3B82F6'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  notified_at timestamp with time zone,
  CONSTRAINT saas_appointments_pkey PRIMARY KEY (id),
  CONSTRAINT saas_appointments_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_chat_messages (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  client_id uuid NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['user'::text, 'assistant'::text])),
  content text NOT NULL,
  message_type text DEFAULT 'text'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_chat_messages_pkey PRIMARY KEY (id),
  CONSTRAINT saas_chat_messages_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_client_category_preferences (
  id integer NOT NULL DEFAULT nextval('saas_client_category_preferences_id_seq'::regclass),
  client_id uuid NOT NULL,
  descricao_original text NOT NULL,
  categoria_escolhida text NOT NULL,
  tipo text NOT NULL,
  frequencia integer DEFAULT 1,
  ultima_vez timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_client_category_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT saas_client_category_preferences_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_client_notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid NOT NULL,
  title text NOT NULL DEFAULT 'Sem tÃ­tulo'::text,
  content text,
  color text DEFAULT '#FFFFFF'::text,
  tags ARRAY DEFAULT '{}'::text[],
  is_pinned boolean DEFAULT false,
  is_archived boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_client_notes_pkey PRIMARY KEY (id),
  CONSTRAINT saas_client_notes_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_client_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid NOT NULL UNIQUE,
  theme text DEFAULT 'light'::text CHECK (theme = ANY (ARRAY['light'::text, 'dark'::text, 'auto'::text])),
  language text DEFAULT 'pt-BR'::text,
  notifications_email boolean DEFAULT true,
  notifications_push boolean DEFAULT true,
  notifications_whatsapp boolean DEFAULT true,
  morning_summary_enabled boolean DEFAULT true,
  morning_summary_time time without time zone DEFAULT '07:00:00'::time without time zone,
  dashboard_widgets jsonb DEFAULT '["finance_summary", "upcoming_reminders", "recent_transactions", "quick_actions"]'::jsonb,
  show_balance_on_dashboard boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_client_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT saas_client_preferences_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_client_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid NOT NULL,
  auth_user_id uuid NOT NULL,
  device_info jsonb DEFAULT '{}'::jsonb,
  user_agent text,
  ip_address inet,
  last_active_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  ended_at timestamp with time zone,
  CONSTRAINT saas_client_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT saas_client_sessions_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id),
  CONSTRAINT saas_client_sessions_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.saas_clients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  whatsapp_id text UNIQUE,
  name text NOT NULL,
  email text,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'suspended'::text, 'trial'::text, 'cancelled'::text])),
  plan text DEFAULT 'free'::text CHECK (plan = ANY (ARRAY['free'::text, 'trial'::text, 'starter'::text, 'pro'::text, 'enterprise'::text])),
  trial_ends_at timestamp with time zone,
  bot_name text DEFAULT 'Sara'::text,
  bot_personality text DEFAULT 'formal'::text CHECK (bot_personality = ANY (ARRAY['formal'::text, 'casual'::text, 'tecnico'::text, 'amigavel'::text])),
  custom_instructions text,
  timezone text DEFAULT 'America/Sao_Paulo'::text,
  response_mode text DEFAULT 'text'::text CHECK (response_mode = ANY (ARRAY['text'::text, 'audio'::text, 'both'::text])),
  max_reminders integer DEFAULT 50,
  max_lists integer DEFAULT 10,
  max_list_items integer DEFAULT 100,
  max_transactions_month integer DEFAULT 200,
  reminders_count integer DEFAULT 0,
  lists_count integer DEFAULT 0,
  transactions_month integer DEFAULT 0,
  transactions_month_reset date DEFAULT CURRENT_DATE,
  onboarding_completed boolean DEFAULT false,
  first_interaction_at timestamp with time zone,
  apelido text,
  lgpd_accepted_at timestamp with time zone,
  onboarding_step text DEFAULT 'lgpd'::text CHECK (onboarding_step = ANY (ARRAY['welcome'::text, 'lgpd'::text, 'name'::text, 'apelido'::text, 'cidade'::text, 'email'::text, 'plans'::text, 'completed'::text])),
  cidade text,
  uf text DEFAULT 'SP'::text,
  asaas_customer_id text,
  asaas_subscription_id text,
  payment_method text DEFAULT 'pending'::text CHECK (payment_method = ANY (ARRAY['pending'::text, 'credit_card'::text, 'pix'::text])),
  last_payment_at timestamp with time zone,
  next_payment_at timestamp with time zone,
  payment_status text DEFAULT 'pending'::text CHECK (payment_status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'overdue'::text, 'cancelled'::text])),
  morning_summary_enabled boolean DEFAULT true,
  morning_summary_last_sent date,
  current_balance numeric DEFAULT 0,
  balance_updated_at timestamp with time zone DEFAULT now(),
  max_rag_queries_month integer DEFAULT 10,
  rag_queries_month integer DEFAULT 0,
  max_documents integer DEFAULT 50,
  documents_count integer DEFAULT 0,
  max_web_searches_month integer DEFAULT 10,
  web_searches_month integer DEFAULT 0,
  billing_name text,
  billing_cpf_cnpj text,
  billing_email text,
  billing_phone text,
  billing_address text,
  billing_address_number text,
  billing_complement text,
  billing_neighborhood text,
  billing_city text,
  billing_state text,
  billing_postal_code text,
  subscription_flow_step text,
  subscription_flow_plan text,
  subscription_flow_data jsonb,
  subscription_flow_started_at timestamp with time zone,
  first_payment_confirmed boolean DEFAULT false,
  auth_user_id uuid UNIQUE,
  appointments_month integer DEFAULT 0,
  CONSTRAINT saas_clients_pkey PRIMARY KEY (id),
  CONSTRAINT saas_clients_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.saas_documents (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  content text NOT NULL,
  embedding USER-DEFINED,
  titulo text,
  categoria text DEFAULT 'geral'::text,
  fonte text DEFAULT 'whatsapp'::text,
  file_id text,
  file_type text,
  autor text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  active boolean DEFAULT true,
  content_hash text,
  whatsapp_id text,
  document_hash text,
  CONSTRAINT saas_documents_pkey PRIMARY KEY (id)
);
CREATE TABLE public.saas_feedback (
  id integer NOT NULL DEFAULT nextval('saas_feedback_id_seq'::regclass),
  client_id uuid NOT NULL,
  score integer NOT NULL CHECK (score >= 0 AND score <= 10),
  comment text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_feedback_pkey PRIMARY KEY (id),
  CONSTRAINT saas_feedback_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_finance_categories (
  id integer NOT NULL DEFAULT nextval('saas_finance_categories_id_seq'::regclass),
  nome text NOT NULL UNIQUE,
  tipo text NOT NULL CHECK (tipo = ANY (ARRAY['receita'::text, 'despesa'::text, 'ambos'::text])),
  icone text,
  palavras_chave ARRAY,
  ativa boolean DEFAULT true,
  ordem integer DEFAULT 0,
  CONSTRAINT saas_finance_categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.saas_finance_context (
  client_id uuid NOT NULL,
  last_transaction_id bigint,
  last_transaction_type text,
  last_transaction_description text,
  last_transaction_value numeric,
  last_transaction_date date,
  last_action text,
  updated_at timestamp with time zone DEFAULT now(),
  whatsapp_id character varying NOT NULL,
  last_transaction_amount numeric,
  CONSTRAINT saas_finance_context_pkey PRIMARY KEY (client_id)
);
CREATE TABLE public.saas_finance_monthly_cache (
  id integer NOT NULL DEFAULT nextval('saas_finance_monthly_cache_id_seq'::regclass),
  client_id uuid NOT NULL,
  ano integer NOT NULL,
  mes integer NOT NULL,
  receitas numeric NOT NULL DEFAULT 0,
  despesas numeric NOT NULL DEFAULT 0,
  saldo numeric NOT NULL DEFAULT 0,
  transacoes_count integer NOT NULL DEFAULT 0,
  top_categorias jsonb DEFAULT '[]'::jsonb,
  maior_despesa jsonb,
  cached_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_finance_monthly_cache_pkey PRIMARY KEY (id),
  CONSTRAINT saas_finance_monthly_cache_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_finance_recent_context (
  id integer NOT NULL DEFAULT nextval('saas_finance_recent_context_id_seq'::regclass),
  client_id uuid NOT NULL,
  transaction_id bigint NOT NULL,
  transaction_type text NOT NULL CHECK (transaction_type = ANY (ARRAY['income'::text, 'expense'::text])),
  transaction_description text NOT NULL,
  transaction_amount numeric NOT NULL,
  transaction_date date NOT NULL,
  transaction_category text,
  transaction_payment_method text,
  action text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_finance_recent_context_pkey PRIMARY KEY (id),
  CONSTRAINT saas_finance_recent_context_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_finance_transactions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  client_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['income'::text, 'expense'::text])),
  description text NOT NULL,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  category text,
  payment_method text,
  date date DEFAULT CURRENT_DATE,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_finance_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT saas_finance_transactions_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_lists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid NOT NULL,
  title text NOT NULL,
  items jsonb DEFAULT '[]'::jsonb,
  is_archived boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_lists_pkey PRIMARY KEY (id),
  CONSTRAINT saas_lists_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_n8n_chat_histories (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  client_id uuid,
  session_id text NOT NULL,
  message jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_n8n_chat_histories_pkey PRIMARY KEY (id),
  CONSTRAINT saas_n8n_chat_histories_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_plans (
  id text NOT NULL,
  name text NOT NULL,
  description text,
  price_monthly numeric NOT NULL DEFAULT 0,
  price_yearly numeric,
  max_reminders integer DEFAULT 50,
  max_lists integer DEFAULT 10,
  max_list_items integer DEFAULT 100,
  max_transactions_month integer DEFAULT 200,
  features jsonb DEFAULT '[]'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  max_rag_queries_month integer DEFAULT 10,
  max_documents integer DEFAULT 50,
  max_web_searches_month integer DEFAULT 10,
  max_appointments_month integer DEFAULT 3,
  CONSTRAINT saas_plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.saas_reminders (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  client_id uuid NOT NULL,
  title text NOT NULL,
  description text,
  remind_at timestamp with time zone NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sent'::text, 'completed'::text, 'cancelled'::text])),
  priority text DEFAULT 'media'::text CHECK (priority = ANY (ARRAY['alta'::text, 'media'::text, 'baixa'::text])),
  type text DEFAULT 'unico'::text CHECK (type = ANY (ARRAY['unico'::text, 'diario'::text, 'semanal'::text, 'mensal'::text, 'anual'::text])),
  created_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  snooze_count integer DEFAULT 0,
  CONSTRAINT saas_reminders_pkey PRIMARY KEY (id),
  CONSTRAINT saas_reminders_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid,
  type character varying NOT NULL,
  period_start date NOT NULL,
  period_end date NOT NULL,
  file_url text,
  file_type character varying DEFAULT 'pdf'::character varying,
  status character varying DEFAULT 'generating'::character varying,
  insights_summary text,
  full_insights jsonb,
  created_at timestamp with time zone DEFAULT now(),
  file_key text,
  is_public boolean DEFAULT false,
  file_size bigint,
  CONSTRAINT saas_reports_pkey PRIMARY KEY (id),
  CONSTRAINT saas_reports_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_security_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid,
  client_name text,
  message text NOT NULL,
  violation_type text NOT NULL,
  confidence_score numeric,
  source text DEFAULT 'portal'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_security_logs_pkey PRIMARY KEY (id),
  CONSTRAINT saas_security_logs_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id)
);
CREATE TABLE public.saas_verification_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  client_id uuid,
  auth_user_id uuid,
  code text NOT NULL,
  purpose text NOT NULL CHECK (purpose = ANY (ARRAY['link_whatsapp'::text, 'verify_email'::text, 'verify_phone'::text])),
  target_value text NOT NULL,
  expires_at timestamp with time zone NOT NULL,
  used_at timestamp with time zone,
  attempts integer DEFAULT 0,
  max_attempts integer DEFAULT 3,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT saas_verification_codes_pkey PRIMARY KEY (id),
  CONSTRAINT saas_verification_codes_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.saas_clients(id),
  CONSTRAINT saas_verification_codes_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id)
);