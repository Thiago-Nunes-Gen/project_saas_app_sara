{
  "name": "SARA SaaS - Agente Especialista Pesquisa v2.0",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "query"
            },
            {
              "name": "localizacao"
            },
            {
              "name": "whatsapp_id"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -560,
        640
      ],
      "id": "d33ef8f8-c978-48ab-b978-519b872e27e8",
      "name": "Trigger Pesquisa"
    },
    {
      "parameters": {
        "content": "## üîç SARA SaaS - Agente Especialista Pesquisa v2.0\n\n### FLUXO:\n1. Recebe query + localiza√ß√£o\n2. Detecta tipo de pesquisa automaticamente\n3. Monta prompt especializado\n4. Chama OpenAI Search\n5. Formata resposta para WhatsApp\n6. Retorna mensagem PRONTA\n\n### ENTRADA:\n- query: Pergunta do usu√°rio\n- localizacao: Cidade/Estado (default: Araraquara, SP)\n\n### SA√çDA:\n```json\n{\n  \"mensagem_formatada\": \"Texto pronto para WhatsApp\",\n  \"tipo\": \"precos|locais|clima|cotacoes|geral\",\n  \"sucesso\": true\n}\n```\n\n**SARA s√≥ precisa repassar a mensagem_formatada!**",
        "height": 640,
        "width": 560,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -576,
        -80
      ],
      "typeVersion": 1,
      "id": "dbe61ae0-3948-4eeb-8bf8-8bfc9f1f3651",
      "name": "Documentacao"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// DETECTOR DE TIPO + MONTADOR DE PROMPT v3.0\n// SIMPLIFICADO: Pede s√≥ dados, formata√ß√£o vai pro final\n// ============================================\n\nconst triggerData = $('Trigger Pesquisa').first().json;\nconst query = triggerData.query || '';\nconst localizacao = triggerData.localizacao || 'Araraquara, SP';\nconst msg = query.toLowerCase();\n\n// Detecta tipo de pesquisa\nlet tipo = 'geral';\nlet promptEspecifico = '';\n\n// PRE√áOS\nif (/quanto\\s*custa|pre[√ßc]o|mais\\s*barato|onde\\s*comprar|comparar?\\s*pre[√ßc]o|valor\\s*(de|do|da)/.test(msg)) {\n  tipo = 'precos';\n  promptEspecifico = `Busque pre√ßos ATUAIS do produto/servi√ßo em lojas e sites brasileiros.\nCompare entre 3-5 op√ß√µes.\n\nRetorne em formato estruturado:\nPRODUTO: [nome completo do produto]\nMELHOR_PRECO: [valor] na [nome da loja] [link se tiver]\nOUTRAS_OPCOES:\n- [loja 1]: [pre√ßo]\n- [loja 2]: [pre√ßo]  \n- [loja 3]: [pre√ßo]\nDICA: [dica de economia ou observa√ß√£o relevante]`;\n}\n\n// LOCAIS (restaurantes, bares, sorveterias, etc)\nelse if (/restaurante|onde\\s*(jantar|almo[√ßc]ar|comer)|lugar\\s*para|bar\\s|cafeteria|farm[a√°]cia|mercado|hotel|indica[√ßc][a√£]o|sorveteri|pizzari|padari|lanchonete|hamburgue|sushi|comida|estabelecimento/i.test(msg)) {\n  tipo = 'locais';\n  promptEspecifico = `Busque os melhores estabelecimentos em ${localizacao}.\nListe at√© 5 op√ß√µes com informa√ß√µes completas.\n\nPara cada local retorne:\nNOME: [nome do estabelecimento]\nNOTA: [avalia√ß√£o] ([quantidade] avalia√ß√µes)\nESPECIALIDADE: [tipo de comida/servi√ßo]\nPRECO: [faixa de pre√ßo: $ a $$$]\nENDERECO: [endere√ßo completo]\nTELEFONE: [telefone com DDD]\nHORARIO: [hor√°rio de funcionamento]\nDESTAQUE: [por que vale a pena ir]`;\n}\n\n// CLIMA\nelse if (/clima|temperatura|previs[a√£]o|vai\\s*chover|tempo\\s*(em|hoje|amanh)/.test(msg)) {\n  tipo = 'clima';\n  const cidadeMatch = msg.match(/(?:em|de|para)\\s+([a-z√°√©√≠√≥√∫√†√¢√™√¥√£√µ√ß\\s]+)/i);\n  const cidade = cidadeMatch ? cidadeMatch[1].trim() : localizacao;\n  \n  promptEspecifico = `Busque clima ATUAL e previs√£o para ${cidade}.\n\nRetorne em formato estruturado:\nCIDADE: ${cidade}\nAGORA:\n- Temperatura: [X]¬∞C\n- Sensacao: [Y]¬∞C\n- Condicao: [sol/nublado/chuva/etc]\n- Umidade: [X]%\n- Vento: [X] km/h\n\nPROXIMAS_HORAS:\n- [HH:00]: [temp]¬∞C | [condi√ß√£o] | [chance chuva]\n- [HH:00]: [temp]¬∞C | [condi√ß√£o] | [chance chuva]\n\nPROXIMOS_DIAS:\n- [Dia da semana]: [min]¬∞ a [max]¬∞ | [condi√ß√£o]\n- [Dia da semana]: [min]¬∞ a [max]¬∞ | [condi√ß√£o]\n\nRECOMENDACAO: [dica pr√°tica baseada no clima]\n\nPara condi√ß√µes use: sol, parcialmente nublado, nublado, chuva, tempestade`;\n}\n\n// COTA√á√ïES\nelse if (/dolar|d[o√≥]lar|euro|bitcoin|btc|ethereum|ibovespa|cota[√ßc][a√£]o|c[a√¢]mbio/.test(msg)) {\n  tipo = 'cotacoes';\n  promptEspecifico = `Busque cota√ß√µes ATUAIS dos ativos solicitados.\n\nPara cada ativo retorne:\nATIVO: [nome do ativo]\nVALOR: R$ [valor atual]\nVARIACAO_DIA: [+/-][X]%\nVARIACAO_SEMANA: [+/-][X]%\nHORARIO: [hor√°rio da cota√ß√£o]\nTENDENCIA: alta/baixa/est√°vel\n\nANALISE: [breve contexto sobre o movimento do mercado]`;\n}\n\n// GERAL\nelse {\n  tipo = 'geral';\n  promptEspecifico = `Pesquise sobre: ${query}\n\nRetorne em formato estruturado:\nRESPOSTA: [resposta direta e clara]\n\nDETALHES:\n- [ponto importante 1]\n- [ponto importante 2]\n- [ponto importante 3]\n\nFONTE: [fonte da informa√ß√£o]`;\n}\n\nconst systemPrompt = `Voc√™ √© um assistente de pesquisa especializado.\n\nCONSULTA: ${query}\nLOCALIZA√á√ÉO: ${localizacao}\n\nINSTRU√á√ïES:\n${promptEspecifico}\n\nREGRAS CR√çTICAS:\n- Retorne APENAS os dados estruturados\n- N√ÉO use emojis, markdown ou formata√ß√£o visual\n- Seja PRECISO com dados atuais\n- Use o formato estruturado exato que foi pedido\n- Responda em portugu√™s do Brasil\n- A formata√ß√£o visual ser√° aplicada depois`;\n\nreturn {\n  query: query,\n  localizacao: localizacao,\n  tipo: tipo,\n  system_prompt: systemPrompt\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        544
      ],
      "id": "526faa0e-6b1b-4637-a4fb-49db874b6ace",
      "name": "Detecta Tipo e Monta Prompt"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini-search-preview-2025-03-11",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI-SEARCH-PREVIEW-2025-03-11"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.system_prompt }}",
              "role": "system"
            },
            {
              "content": "={{ $json.query }}"
            }
          ]
        },
        "options": {
          "maxTokens": 1500
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        272,
        544
      ],
      "id": "081a26c2-75c4-45d3-8253-6c8d4da875dd",
      "name": "OpenAI Search",
      "credentials": {
        "openAiApi": {
          "id": "rd7lfGY1RwqFs6Kg",
          "name": "OpenAi G√™nesis"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// FORMATADOR PARA WHATSAPP v3.2 - SIMPLIFICADO\n// N√ÉO QUEBRA o conte√∫do! S√≥ adiciona cabe√ßalho e rodap√©\n// ============================================\n\n// ‚úÖ BUSCAR DO NODE CORRETO: OpenAI Search\nconst openaiResponse = $('OpenAI Search').first().json;\nconst anterior = $('Detecta Tipo e Monta Prompt').first().json;\nconst tipo = anterior.tipo;\n\n// Extrai o conte√∫do da resposta da OpenAI\nlet conteudo = '';\nif (openaiResponse.message?.content) {\n  conteudo = openaiResponse.message.content;\n} else if (openaiResponse.text) {\n  conteudo = openaiResponse.text;\n} else if (openaiResponse.content) {\n  conteudo = openaiResponse.content;\n} else if (typeof openaiResponse === 'string') {\n  conteudo = openaiResponse;\n} else {\n  conteudo = JSON.stringify(openaiResponse, null, 2);\n}\n\n// Limpa APENAS links markdown e excesso de linhas\nconteudo = conteudo\n  .replace(/```json|```/g, '')\n  .replace(/\\[([^\\]]+)\\]\\([^)]+\\)/g, '$1') // Remove links [texto](url) ‚Üí texto\n  .replace(/\\n{4,}/g, '\\n\\n') // Max 2 quebras\n  .trim();\n\n// ============================================\n// APLICAR TEMPLATES SIMPLES\n// S√≥ cabe√ßalho + conte√∫do + rodap√©\n// SEM PARSERS! SEM QUEBRAR!\n// ============================================\n\nlet mensagem_formatada = '';\nlet icone = 'üîç';\nlet titulo = 'RESULTADO';\nlet rodape = 'üí¨ _Precisa de mais detalhes? √â s√≥ perguntar!_';\n\nswitch(tipo) {\n  case 'precos':\n    icone = 'üí∞';\n    titulo = 'COMPARATIVO DE PRE√áOS';\n    rodape = 'üïê _Pesquisado agora_';\n    break;\n    \n  case 'locais':\n    icone = 'üìç';\n    titulo = 'MELHORES OP√á√ïES';\n    rodape = 'üí° _Sempre confirme disponibilidade antes de ir!_';\n    break;\n    \n  case 'clima':\n    icone = 'üå§Ô∏è';\n    titulo = 'PREVIS√ÉO DO TEMPO';\n    rodape = 'üïê _Atualizado agora_';\n    break;\n    \n  case 'cotacoes':\n    icone = 'üìà';\n    titulo = 'COTA√á√ïES';\n    rodape = 'üíπ _Valores em tempo real_';\n    break;\n    \n  default:\n    icone = 'üîç';\n    titulo = 'RESULTADO DA PESQUISA';\n    rodape = 'üí¨ _Precisa de mais detalhes? √â s√≥ perguntar!_';\n}\n\n// Monta mensagem: cabe√ßalho + conte√∫do TODO + rodap√©\nmensagem_formatada = `${icone} *${titulo}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n${conteudo}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n${rodape}`;\n\nreturn {\n  mensagem_formatada: mensagem_formatada,\n  tipo: tipo,\n  sucesso: true,\n  conteudo_original: conteudo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        544
      ],
      "id": "f1f60917-ebb9-4b06-861e-19b5a093463e",
      "name": "Formata para WhatsApp"
    },
    {
      "parameters": {
        "content": "## üí° Como usar\n\n**No agente SARA, chame este workflow:**\n```\nagente_especialista_pesquisa(\n  query: \"mensagem do usu√°rio\",\n  localizacao: \"Araraquara, SP\"\n)\n```\n\n**Retorno:**\n```json\n{\n  \"mensagem_formatada\": \"Texto pronto!\",\n  \"tipo\": \"precos\",\n  \"sucesso\": true\n}\n```\n\n**SARA s√≥ precisa fazer:**\n`resultado.mensagem_formatada`\n\nNada mais! A mensagem j√° vem formatada.",
        "height": 504,
        "width": 540,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1072,
        368
      ],
      "typeVersion": 1,
      "id": "c260cc6f-6cbd-473d-9eb8-48683171ea4f",
      "name": "Como Usar"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT verificar_limite_pesquisa('{{ $json.whatsapp_id }}') as resultado;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -368,
        640
      ],
      "id": "053d22e7-6ee7-49ba-a257-4407069dac07",
      "name": "Verificar Limite Pesquisa",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "2xQBC6Q6FS0TLYyI",
          "name": "Postgres_Zero"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f548b670-c4aa-4ce6-b10f-311cb3e1ad32",
              "leftValue": "={{ $json.resultado.permitido }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -192,
        640
      ],
      "id": "09908d25-7d33-4746-80ea-3e78521de47f",
      "name": "Pode Pesquisar?"
    },
    {
      "parameters": {
        "jsCode": "const limite = $('Verificar Limite Pesquisa').first().json.resultado;\nconst triggerData = $('Trigger Pesquisa').first().json;\n\nreturn [{\n  json: {\n    whatsapp_id: triggerData.whatsapp_id,\n    mensagem_formatada: `üö´ *LIMITE DE PESQUISAS ATINGIDO!*\\n\\n` +\n                       `Voc√™ atingiu o limite de ${limite.limite} pesquisas web/m√™s.\\n\\n` +\n                       `Para continuar pesquisando:\\n` +\n                       `Digite *#planos* para fazer upgrade! üöÄ`,\n    tipo: 'erro_limite',\n    sucesso: false\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        752
      ],
      "id": "a13059bf-2b4e-4322-a9f7-53ba219c87f9",
      "name": "Erro Limite Pesquisa"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT incrementar_pesquisa('{{ $('Trigger Pesquisa').first().json.whatsapp_id }}') as resultado;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        608,
        544
      ],
      "id": "1a88685f-925e-4291-bf94-5c7623b5ca4c",
      "name": "Incrementar Contador Pesquisa",
      "credentials": {
        "postgres": {
          "id": "2xQBC6Q6FS0TLYyI",
          "name": "Postgres_Zero"
        }
      }
    }
  ],
  "pinData": {
    "Trigger Pesquisa": [
      {
        "json": {
          "query": "previs√£o do tempo para hoje",
          "localizacao": "Araraquara, SP",
          "whatsapp_id": "5516997515087"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Trigger Pesquisa": {
      "main": [
        [
          {
            "node": "Verificar Limite Pesquisa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detecta Tipo e Monta Prompt": {
      "main": [
        [
          {
            "node": "OpenAI Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Search": {
      "main": [
        [
          {
            "node": "Incrementar Contador Pesquisa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Limite Pesquisa": {
      "main": [
        [
          {
            "node": "Pode Pesquisar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pode Pesquisar?": {
      "main": [
        [
          {
            "node": "Detecta Tipo e Monta Prompt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erro Limite Pesquisa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Incrementar Contador Pesquisa": {
      "main": [
        [
          {
            "node": "Formata para WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "22a3cb6e-a57e-46f9-b7a7-b69fe5940ab4",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2162172325255cd265a19f3178f77abb9ab7ec9c7a1d869ba2d2925c11389625"
  },
  "id": "FHY1oY-4L1wHKc-DJ9mX7",
  "tags": []
}