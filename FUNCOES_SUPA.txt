[
  {
    "function_name": "aplicar_acao_inadimplencia",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\n  v_plano_free RECORD;\r\nBEGIN\r\n  SELECT * INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  \r\n  CASE p_acao\r\n    -- Apenas registra (para lembrete e aviso)\r\n    WHEN 'lembrete', 'aviso' THEN\r\n      -- N√£o faz nada no banco, s√≥ retorna dados\r\n      NULL;\r\n    \r\n    -- Limitar recursos pela metade\r\n    WHEN 'limitar' THEN\r\n      UPDATE saas_clients\r\n      SET \r\n        max_reminders = GREATEST(max_reminders / 2, 5),\r\n        max_lists = GREATEST(max_lists / 2, 2),\r\n        max_transactions_month = GREATEST(max_transactions_month / 2, 10),\r\n        max_web_searches_month = GREATEST(max_web_searches_month / 2, 1),\r\n        max_rag_queries_month = GREATEST(max_rag_queries_month / 2, 0),\r\n        status = 'limited',\r\n        updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n    \r\n    -- Downgrade para FREE\r\n    WHEN 'downgrade' THEN\r\n      SELECT * INTO v_plano_free FROM saas_plans WHERE id = 'free';\r\n      \r\n      UPDATE saas_clients\r\n      SET \r\n        plan = 'free',\r\n        status = 'active',\r\n        payment_status = 'cancelled',\r\n        asaas_subscription_id = NULL,\r\n        max_reminders = v_plano_free.max_reminders,\r\n        max_lists = v_plano_free.max_lists,\r\n        max_list_items = v_plano_free.max_list_items,\r\n        max_transactions_month = v_plano_free.max_transactions_month,\r\n        max_rag_queries_month = v_plano_free.max_rag_queries_month,\r\n        max_documents = v_plano_free.max_documents,\r\n        max_web_searches_month = v_plano_free.max_web_searches_month,\r\n        updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n    \r\n    ELSE\r\n      RETURN json_build_object('status', 'erro', 'msg', 'A√ß√£o n√£o reconhecida');\r\n  END CASE;\r\n  \r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'acao', p_acao,\r\n    'whatsapp_id', v_client.whatsapp_id,\r\n    'cliente_nome', COALESCE(v_client.apelido, v_client.name)\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "array_to_halfvec",
    "function_code": "array_to_halfvec"
  },
  {
    "function_name": "array_to_halfvec",
    "function_code": "array_to_halfvec"
  },
  {
    "function_name": "array_to_halfvec",
    "function_code": "array_to_halfvec"
  },
  {
    "function_name": "array_to_halfvec",
    "function_code": "array_to_halfvec"
  },
  {
    "function_name": "array_to_sparsevec",
    "function_code": "array_to_sparsevec"
  },
  {
    "function_name": "array_to_sparsevec",
    "function_code": "array_to_sparsevec"
  },
  {
    "function_name": "array_to_sparsevec",
    "function_code": "array_to_sparsevec"
  },
  {
    "function_name": "array_to_sparsevec",
    "function_code": "array_to_sparsevec"
  },
  {
    "function_name": "array_to_vector",
    "function_code": "array_to_vector"
  },
  {
    "function_name": "array_to_vector",
    "function_code": "array_to_vector"
  },
  {
    "function_name": "array_to_vector",
    "function_code": "array_to_vector"
  },
  {
    "function_name": "array_to_vector",
    "function_code": "array_to_vector"
  },
  {
    "function_name": "atualizar_cache_mensal",
    "function_code": "\r\nDECLARE\r\n  v_data_inicio DATE;\r\n  v_data_fim DATE;\r\n  v_receitas NUMERIC;\r\n  v_despesas NUMERIC;\r\n  v_saldo NUMERIC;\r\n  v_count INTEGER;\r\n  v_top_categorias JSONB;\r\n  v_maior_despesa JSONB;\r\nBEGIN\r\n  -- Define per√≠odo\r\n  v_data_inicio := make_date(p_ano, p_mes, 1);\r\n  v_data_fim := (v_data_inicio + INTERVAL '1 month - 1 day')::date;\r\n  \r\n  -- Calcula valores\r\n  SELECT \r\n    COALESCE(SUM(amount) FILTER (WHERE type = 'income'), 0),\r\n    COALESCE(SUM(amount) FILTER (WHERE type = 'expense'), 0),\r\n    COUNT(*)\r\n  INTO v_receitas, v_despesas, v_count\r\n  FROM saas_finance_transactions\r\n  WHERE client_id = p_client_id\r\n    AND date BETWEEN v_data_inicio AND v_data_fim;\r\n  \r\n  v_saldo := v_receitas - v_despesas;\r\n  \r\n  -- Top 5 categorias\r\n  SELECT json_agg(cat ORDER BY total DESC)\r\n  INTO v_top_categorias\r\n  FROM (\r\n    SELECT \r\n      category,\r\n      SUM(amount) as total\r\n    FROM saas_finance_transactions\r\n    WHERE client_id = p_client_id\r\n      AND date BETWEEN v_data_inicio AND v_data_fim\r\n      AND type = 'expense'\r\n      AND category IS NOT NULL\r\n    GROUP BY category\r\n    ORDER BY total DESC\r\n    LIMIT 5\r\n  ) cat;\r\n  \r\n  -- Maior despesa\r\n  SELECT json_build_object(\r\n    'descricao', description,\r\n    'valor', amount,\r\n    'categoria', category,\r\n    'data', TO_CHAR(date, 'DD/MM/YYYY')\r\n  )\r\n  INTO v_maior_despesa\r\n  FROM saas_finance_transactions\r\n  WHERE client_id = p_client_id\r\n    AND date BETWEEN v_data_inicio AND v_data_fim\r\n    AND type = 'expense'\r\n  ORDER BY amount DESC\r\n  LIMIT 1;\r\n  \r\n  -- Salva cache\r\n  INSERT INTO saas_finance_monthly_cache (\r\n    client_id, ano, mes, receitas, despesas, saldo, \r\n    transacoes_count, top_categorias, maior_despesa\r\n  )\r\n  VALUES (\r\n    p_client_id, p_ano, p_mes, v_receitas, v_despesas, v_saldo,\r\n    v_count, COALESCE(v_top_categorias, '[]'::jsonb), v_maior_despesa\r\n  )\r\n  ON CONFLICT (client_id, ano, mes) DO UPDATE\r\n  SET \r\n    receitas = EXCLUDED.receitas,\r\n    despesas = EXCLUDED.despesas,\r\n    saldo = EXCLUDED.saldo,\r\n    transacoes_count = EXCLUDED.transacoes_count,\r\n    top_categorias = EXCLUDED.top_categorias,\r\n    maior_despesa = EXCLUDED.maior_despesa,\r\n    cached_at = NOW();\r\nEND;\r\n"
  },
  {
    "function_name": "atualizar_endereco_cep",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\n  v_data jsonb;\r\nBEGIN\r\n  SELECT * INTO v_client\r\n  FROM saas_clients\r\n  WHERE id = p_client_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  \r\n  v_data := COALESCE(v_client.subscription_flow_data, '{}');\r\n  \r\n  IF p_cep_encontrado THEN\r\n    v_data := v_data || jsonb_build_object(\r\n      'endereco', p_logradouro,\r\n      'bairro', p_bairro,\r\n      'cidade', p_cidade,\r\n      'estado', p_estado\r\n    );\r\n    \r\n    UPDATE saas_clients\r\n    SET \r\n      subscription_flow_step = 'numero_cep',\r\n      subscription_flow_data = v_data,\r\n      updated_at = NOW()\r\n    WHERE id = p_client_id;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'cep_encontrado',\r\n      'step', 'numero_cep',\r\n      'endereco', p_logradouro,\r\n      'bairro', p_bairro,\r\n      'cidade', p_cidade,\r\n      'estado', p_estado,\r\n      'msg', '‚úÖ Encontrei o endere√ßo:\\nüìç ' || p_logradouro || ', ' || p_bairro || ' - ' || p_cidade || '/' || p_estado || '\\n\\nQual o *n√∫mero*?\\n\\n_Se o endere√ßo estiver errado, digite *corrigir*_'\r\n    );\r\n  ELSE\r\n    UPDATE saas_clients\r\n    SET \r\n      subscription_flow_step = 'endereco_completo',\r\n      subscription_flow_data = v_data,\r\n      updated_at = NOW()\r\n    WHERE id = p_client_id;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'cep_nao_encontrado',\r\n      'step', 'endereco_completo',\r\n      'msg', '‚ùå N√£o encontrei esse CEP.\\n\\nPor favor, informe o endere√ßo completo:\\n*Rua/Av Nome, N√∫mero, Bairro, Cidade UF*\\n\\nExemplo: Rua das Flores, 123, Centro, Araraquara SP'\r\n    );\r\n  END IF;\r\nEND;\r\n"
  },
  {
    "function_name": "binary_quantize",
    "function_code": "halfvec_binary_quantize"
  },
  {
    "function_name": "binary_quantize",
    "function_code": "binary_quantize"
  },
  {
    "function_name": "buscar_inadimplentes",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    c.id as client_id,\r\n    c.whatsapp_id,\r\n    COALESCE(c.apelido, c.name) as nome,\r\n    c.plan,\r\n    c.payment_status,\r\n    c.next_payment_at,\r\n    EXTRACT(DAY FROM NOW() - c.next_payment_at)::integer as dias_atraso,\r\n    c.asaas_subscription_id\r\n  FROM saas_clients c\r\n  WHERE \r\n    c.plan != 'free'\r\n    AND c.next_payment_at IS NOT NULL\r\n    AND c.next_payment_at < NOW()\r\n    AND c.status IN ('active', 'limited')\r\n  ORDER BY c.next_payment_at ASC;\r\nEND;\r\n"
  },
  {
    "function_name": "buscar_transacao_por_data",
    "function_code": "\r\nDECLARE\r\n  v_data_busca DATE;\r\nBEGIN\r\n  v_data_busca := CURRENT_DATE - p_dias_atras;\r\n  \r\n  RETURN QUERY\r\n  SELECT \r\n    frc.transaction_id,\r\n    frc.transaction_description,\r\n    frc.transaction_amount,\r\n    frc.transaction_date,\r\n    CASE WHEN frc.transaction_type = 'income' THEN 'receita' ELSE 'despesa' END\r\n  FROM saas_finance_recent_context frc\r\n  WHERE frc.client_id = p_client_id\r\n    AND frc.transaction_date = v_data_busca\r\n  ORDER BY frc.created_at DESC;\r\nEND;\r\n"
  },
  {
    "function_name": "buscar_transacao_por_descricao",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    frc.transaction_id,\r\n    frc.transaction_description,\r\n    frc.transaction_amount,\r\n    frc.transaction_date,\r\n    CASE WHEN frc.transaction_type = 'income' THEN 'receita' ELSE 'despesa' END,\r\n    frc.transaction_category\r\n  FROM saas_finance_recent_context frc\r\n  WHERE frc.client_id = p_client_id\r\n    AND LOWER(unaccent(frc.transaction_description)) \r\n        LIKE '%' || LOWER(unaccent(p_descricao)) || '%'\r\n  ORDER BY frc.created_at DESC\r\n  LIMIT p_limite;\r\nEND;\r\n"
  },
  {
    "function_name": "cancelar_assinatura_asaas",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\n  v_plano_free RECORD;\r\nBEGIN\r\n  SELECT * INTO v_client\r\n  FROM saas_clients\r\n  WHERE asaas_customer_id = p_asaas_customer_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  \r\n  -- Buscar limites do plano FREE\r\n  SELECT * INTO v_plano_free FROM saas_plans WHERE id = 'free';\r\n  \r\n  -- Fazer downgrade para FREE\r\n  UPDATE saas_clients\r\n  SET \r\n    plan = 'free',\r\n    status = 'active',\r\n    payment_status = 'cancelled',\r\n    asaas_subscription_id = NULL,\r\n    -- Aplicar limites do FREE\r\n    max_reminders = v_plano_free.max_reminders,\r\n    max_lists = v_plano_free.max_lists,\r\n    max_list_items = v_plano_free.max_list_items,\r\n    max_transactions_month = v_plano_free.max_transactions_month,\r\n    max_rag_queries_month = v_plano_free.max_rag_queries_month,\r\n    max_documents = v_plano_free.max_documents,\r\n    max_web_searches_month = v_plano_free.max_web_searches_month,\r\n    updated_at = NOW()\r\n  WHERE id = v_client.id;\r\n  \r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'whatsapp_id', v_client.whatsapp_id,\r\n    'cliente_nome', COALESCE(v_client.apelido, v_client.name),\r\n    'plano_anterior', v_client.plan\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "cancelar_fluxo_assinatura",
    "function_code": "\r\nBEGIN\r\n  UPDATE saas_clients\r\n  SET \r\n    subscription_flow_step = NULL,\r\n    subscription_flow_plan = NULL,\r\n    subscription_flow_data = NULL,\r\n    updated_at = NOW()\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'msg', 'Fluxo de assinatura cancelado. Quando quiser, digite #assinar [plano] para recome√ßar.'\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "check_appointments_limit",
    "function_code": "\r\nDECLARE\r\n  current_count INTEGER;\r\n  max_allowed INTEGER;\r\nBEGIN\r\n  -- Busca contagem atual e limite do plano\r\n  SELECT \r\n    c.appointments_month,\r\n    p.max_appointments_month\r\n  INTO current_count, max_allowed\r\n  FROM saas_clients c\r\n  JOIN saas_plans p ON LOWER(p.name) = LOWER(c.plan)\r\n  WHERE c.id = NEW.client_id;\r\n\r\n  -- Se limite √© -1 (ilimitado), permite\r\n  IF max_allowed = -1 THEN\r\n    RETURN NEW;\r\n  END IF;\r\n\r\n  -- Se atingiu o limite, bloqueia\r\n  IF COALESCE(current_count, 0) >= max_allowed THEN\r\n    RAISE EXCEPTION 'Limite de agendamentos atingido (% de %)', current_count, max_allowed;\r\n  END IF;\r\n\r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "compare_periods",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\n    v_period1 JSONB;\r\n    v_period2 JSONB;\r\nBEGIN\r\n    v_client_id := get_current_client_id();\r\n    \r\n    -- Valores padr√£o: m√™s anterior\r\n    IF p_year2 IS NULL THEN\r\n        IF p_month1 = 1 THEN\r\n            p_year2 := p_year1 - 1;\r\n            p_month2 := 12;\r\n        ELSE\r\n            p_year2 := p_year1;\r\n            p_month2 := p_month1 - 1;\r\n        END IF;\r\n    END IF;\r\n    \r\n    -- Per√≠odo 1\r\n    SELECT jsonb_build_object(\r\n        'year', p_year1,\r\n        'month', p_month1,\r\n        'income', COALESCE(SUM(CASE WHEN type = 'income' THEN amount END), 0),\r\n        'expense', COALESCE(SUM(CASE WHEN type = 'expense' THEN amount END), 0)\r\n    ) INTO v_period1\r\n    FROM saas_finance_transactions\r\n    WHERE client_id = v_client_id\r\n      AND EXTRACT(YEAR FROM date) = p_year1\r\n      AND EXTRACT(MONTH FROM date) = p_month1;\r\n    \r\n    -- Per√≠odo 2\r\n    SELECT jsonb_build_object(\r\n        'year', p_year2,\r\n        'month', p_month2,\r\n        'income', COALESCE(SUM(CASE WHEN type = 'income' THEN amount END), 0),\r\n        'expense', COALESCE(SUM(CASE WHEN type = 'expense' THEN amount END), 0)\r\n    ) INTO v_period2\r\n    FROM saas_finance_transactions\r\n    WHERE client_id = v_client_id\r\n      AND EXTRACT(YEAR FROM date) = p_year2\r\n      AND EXTRACT(MONTH FROM date) = p_month2;\r\n    \r\n    RETURN jsonb_build_object(\r\n        'current', v_period1,\r\n        'previous', v_period2,\r\n        'variation', jsonb_build_object(\r\n            'income_diff', (v_period1->>'income')::NUMERIC - (v_period2->>'income')::NUMERIC,\r\n            'expense_diff', (v_period1->>'expense')::NUMERIC - (v_period2->>'expense')::NUMERIC,\r\n            'income_pct', CASE \r\n                WHEN (v_period2->>'income')::NUMERIC > 0 \r\n                THEN ROUND(((v_period1->>'income')::NUMERIC - (v_period2->>'income')::NUMERIC) * 100.0 / (v_period2->>'income')::NUMERIC, 2)\r\n                ELSE NULL \r\n            END,\r\n            'expense_pct', CASE \r\n                WHEN (v_period2->>'expense')::NUMERIC > 0 \r\n                THEN ROUND(((v_period1->>'expense')::NUMERIC - (v_period2->>'expense')::NUMERIC) * 100.0 / (v_period2->>'expense')::NUMERIC, 2)\r\n                ELSE NULL \r\n            END\r\n        )\r\n    );\r\nEND;\r\n"
  },
  {
    "function_name": "confirmar_assinatura_asaas",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\n  v_plano RECORD;\r\nBEGIN\r\n  -- Buscar cliente pelo asaas_customer_id\r\n  SELECT * INTO v_client\r\n  FROM saas_clients\r\n  WHERE asaas_customer_id = p_asaas_customer_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object(\r\n      'status', 'erro',\r\n      'msg', 'Cliente n√£o encontrado com este asaas_customer_id.'\r\n    );\r\n  END IF;\r\n  \r\n  -- Buscar plano\r\n  SELECT * INTO v_plano FROM saas_plans WHERE id = p_plano;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object(\r\n      'status', 'erro',\r\n      'msg', 'Plano n√£o encontrado: ' || p_plano\r\n    );\r\n  END IF;\r\n  \r\n  -- Atualizar cliente com novo plano e limites\r\n  UPDATE saas_clients\r\n  SET \r\n    plan = p_plano,\r\n    status = 'active',\r\n    asaas_subscription_id = p_asaas_subscription_id,\r\n    payment_method = p_payment_method,\r\n    payment_status = 'confirmed',\r\n    last_payment_at = NOW(),\r\n    next_payment_at = COALESCE(p_next_payment_at, NOW() + INTERVAL '30 days'),\r\n    -- Atualizar limites do novo plano\r\n    max_reminders = v_plano.max_reminders,\r\n    max_lists = v_plano.max_lists,\r\n    max_list_items = v_plano.max_list_items,\r\n    max_transactions_month = v_plano.max_transactions_month,\r\n    max_rag_queries_month = v_plano.max_rag_queries_month,\r\n    max_documents = v_plano.max_documents,\r\n    max_web_searches_month = v_plano.max_web_searches_month,\r\n    -- Limpar fluxo de assinatura\r\n    subscription_flow_step = NULL,\r\n    subscription_flow_plan = NULL,\r\n    subscription_flow_data = NULL,\r\n    updated_at = NOW()\r\n  WHERE id = v_client.id;\r\n  \r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'msg', 'Assinatura confirmada com sucesso!',\r\n    'whatsapp_id', v_client.whatsapp_id,\r\n    'plano', p_plano,\r\n    'plano_nome', v_plano.name,\r\n    'cliente_nome', COALESCE(v_client.apelido, v_client.name)\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "cosine_distance",
    "function_code": "sparsevec_cosine_distance"
  },
  {
    "function_name": "cosine_distance",
    "function_code": "halfvec_cosine_distance"
  },
  {
    "function_name": "cosine_distance",
    "function_code": "cosine_distance"
  },
  {
    "function_name": "decrementar_contador",
    "function_code": "\r\nDECLARE\r\n  v_novo_valor int;\r\nBEGIN\r\n  \r\n  CASE p_tipo_acao\r\n    \r\n    -- Decrementa contador de lembretes\r\n    WHEN 'lembrete' THEN\r\n      UPDATE saas_clients\r\n      SET reminders_count = GREATEST(0, reminders_count - 1),\r\n          updated_at = NOW()\r\n      WHERE whatsapp_id = p_whatsapp_id\r\n      RETURNING reminders_count INTO v_novo_valor;\r\n    \r\n    -- Decrementa contador de listas\r\n    WHEN 'lista' THEN\r\n      UPDATE saas_clients\r\n      SET lists_count = GREATEST(0, lists_count - 1),\r\n          updated_at = NOW()\r\n      WHERE whatsapp_id = p_whatsapp_id\r\n      RETURNING lists_count INTO v_novo_valor;\r\n    \r\n    -- Transa√ß√µes n√£o decrementam (hist√≥rico)\r\n    WHEN 'transacao' THEN\r\n      RETURN jsonb_build_object(\r\n        'sucesso', false,\r\n        'erro', 'Transa√ß√µes n√£o podem ser decrementadas'\r\n      );\r\n    \r\n    ELSE\r\n      RETURN jsonb_build_object(\r\n        'sucesso', false,\r\n        'erro', 'Tipo de a√ß√£o inv√°lido'\r\n      );\r\n  END CASE;\r\n  \r\n  -- Retorna sucesso\r\n  RETURN jsonb_build_object(\r\n    'sucesso', true,\r\n    'tipo', p_tipo_acao,\r\n    'novo_valor', v_novo_valor\r\n  );\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "desativar_documento",
    "function_code": "\r\nDECLARE\r\n  affected integer;\r\nBEGIN\r\n  UPDATE zero_documents_thiago \r\n  SET active = false, updated_at = NOW()\r\n  WHERE file_id = p_file_id;\r\n  \r\n  GET DIAGNOSTICS affected = ROW_COUNT;\r\n  RETURN affected;\r\nEND;\r\n"
  },
  {
    "function_name": "end_portal_session",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\nBEGIN\r\n    v_client_id := get_current_client_id();\r\n    \r\n    IF p_session_id IS NOT NULL THEN\r\n        -- Encerra sess√£o espec√≠fica\r\n        UPDATE saas_client_sessions\r\n        SET is_active = false, ended_at = NOW()\r\n        WHERE id = p_session_id\r\n          AND auth_user_id = auth.uid();\r\n    ELSE\r\n        -- Encerra todas as sess√µes do usu√°rio\r\n        UPDATE saas_client_sessions\r\n        SET is_active = false, ended_at = NOW()\r\n        WHERE auth_user_id = auth.uid()\r\n          AND is_active = true;\r\n    END IF;\r\n    \r\n    -- Log\r\n    IF v_client_id IS NOT NULL THEN\r\n        INSERT INTO saas_activity_log (client_id, action, details, source)\r\n        VALUES (\r\n            v_client_id,\r\n            'logout',\r\n            jsonb_build_object('session_id', p_session_id),\r\n            'portal'\r\n        );\r\n    END IF;\r\nEND;\r\n"
  },
  {
    "function_name": "export_transactions",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\nBEGIN\r\n    v_client_id := get_current_client_id();\r\n    \r\n    RETURN QUERY\r\n    SELECT \r\n        t.date as data,\r\n        CASE t.type WHEN 'income' THEN 'Receita' ELSE 'Despesa' END as tipo,\r\n        t.description as descricao,\r\n        t.amount as valor,\r\n        t.category as categoria,\r\n        COALESCE(t.payment_method, '-') as forma_pagamento\r\n    FROM saas_finance_transactions t\r\n    WHERE t.client_id = v_client_id\r\n      AND t.date BETWEEN p_start_date AND p_end_date\r\n    ORDER BY t.date DESC, t.created_at DESC;\r\n    \r\n    -- Log da exporta√ß√£o\r\n    INSERT INTO saas_activity_log (client_id, action, details, source)\r\n    VALUES (\r\n        v_client_id,\r\n        'export_transactions',\r\n        jsonb_build_object('start_date', p_start_date, 'end_date', p_end_date),\r\n        'portal'\r\n    );\r\nEND;\r\n"
  },
  {
    "function_name": "extrair_metadados",
    "function_code": "\r\nBEGIN\r\n  -- Extrair titulo\r\n  IF NEW.titulo IS NULL AND NEW.metadata->>'titulo' IS NOT NULL THEN\r\n    NEW.titulo := NEW.metadata->>'titulo';\r\n  END IF;\r\n  \r\n  -- Extrair categoria\r\n  IF NEW.categoria IS NULL OR NEW.categoria = 'geral' THEN\r\n    NEW.categoria := COALESCE(NEW.metadata->>'categoria', 'geral');\r\n  END IF;\r\n  \r\n  -- Extrair fonte\r\n  IF NEW.fonte IS NULL OR NEW.fonte = 'manual' THEN\r\n    NEW.fonte := COALESCE(NEW.metadata->>'fonte', 'manual');\r\n  END IF;\r\n  \r\n  -- Extrair file_id\r\n  IF NEW.file_id IS NULL THEN\r\n    NEW.file_id := NEW.metadata->>'file_id';\r\n  END IF;\r\n  \r\n  -- Extrair file_type\r\n  IF NEW.file_type IS NULL THEN\r\n    NEW.file_type := NEW.metadata->>'file_type';\r\n  END IF;\r\n  \r\n  -- Extrair autor\r\n  IF NEW.autor IS NULL THEN\r\n    NEW.autor := NEW.metadata->>'autor';\r\n  END IF;\r\n  \r\n  -- Extrair content_hash\r\n  IF NEW.content_hash IS NULL THEN\r\n    NEW.content_hash := NEW.metadata->>'content_hash';\r\n  END IF;\r\n  \r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "fill_client_id_on_chat_history",
    "function_code": "\r\nBEGIN\r\n  -- Busca o client_id baseado no session_id (com ou sem sufixo)\r\n  SELECT id INTO NEW.client_id\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = NEW.session_id\r\n     OR whatsapp_id = NEW.session_id || '@s.whatsapp.net'\r\n     OR REPLACE(whatsapp_id, '@s.whatsapp.net', '') = NEW.session_id;\r\n  \r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "generate_verification_code",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\n    v_code TEXT;\r\nBEGIN\r\n    -- Busca client_id\r\n    SELECT id INTO v_client_id\r\n    FROM saas_clients\r\n    WHERE auth_user_id = p_auth_user_id;\r\n    \r\n    IF v_client_id IS NULL THEN\r\n        RAISE EXCEPTION 'Cliente n√£o encontrado para auth_user_id %', p_auth_user_id;\r\n    END IF;\r\n    \r\n    -- Invalida c√≥digos anteriores do mesmo tipo\r\n    UPDATE saas_verification_codes\r\n    SET used_at = NOW()\r\n    WHERE client_id = v_client_id\r\n      AND purpose = p_purpose\r\n      AND used_at IS NULL;\r\n    \r\n    -- Gera c√≥digo de 6 d√≠gitos\r\n    v_code := LPAD(FLOOR(RANDOM() * 1000000)::TEXT, 6, '0');\r\n    \r\n    -- Insere novo c√≥digo\r\n    INSERT INTO saas_verification_codes (\r\n        client_id,\r\n        auth_user_id,\r\n        code,\r\n        purpose,\r\n        target_value,\r\n        expires_at\r\n    ) VALUES (\r\n        v_client_id,\r\n        p_auth_user_id,\r\n        v_code,\r\n        p_purpose,\r\n        p_target_value,\r\n        NOW() + (p_expires_in_minutes || ' minutes')::INTERVAL\r\n    );\r\n    \r\n    RETURN v_code;\r\nEND;\r\n"
  },
  {
    "function_name": "get_current_client",
    "function_code": "\r\n    SELECT * \r\n    FROM saas_clients \r\n    WHERE auth_user_id = auth.uid()\r\n"
  },
  {
    "function_name": "get_current_client_id",
    "function_code": "\r\n    SELECT id \r\n    FROM saas_clients \r\n    WHERE auth_user_id = auth.uid()\r\n"
  },
  {
    "function_name": "get_monthly_report",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\n    v_result JSONB;\r\nBEGIN\r\n    v_client_id := get_current_client_id();\r\n    \r\n    IF v_client_id IS NULL THEN\r\n        RETURN jsonb_build_object('error', 'N√£o autenticado');\r\n    END IF;\r\n    \r\n    SELECT jsonb_build_object(\r\n        'period', jsonb_build_object(\r\n            'year', p_year,\r\n            'month', p_month,\r\n            'month_name', TO_CHAR(MAKE_DATE(p_year, p_month, 1), 'TMMonth')\r\n        ),\r\n        'summary', (\r\n            SELECT jsonb_build_object(\r\n                'total_income', COALESCE(SUM(CASE WHEN type = 'income' THEN amount END), 0),\r\n                'total_expense', COALESCE(SUM(CASE WHEN type = 'expense' THEN amount END), 0),\r\n                'balance', COALESCE(SUM(CASE WHEN type = 'income' THEN amount ELSE -amount END), 0),\r\n                'transaction_count', COUNT(*)\r\n            )\r\n            FROM saas_finance_transactions\r\n            WHERE client_id = v_client_id\r\n              AND EXTRACT(YEAR FROM date) = p_year\r\n              AND EXTRACT(MONTH FROM date) = p_month\r\n        ),\r\n        'by_category', (\r\n            SELECT COALESCE(jsonb_agg(\r\n                jsonb_build_object(\r\n                    'category', category,\r\n                    'type', type,\r\n                    'total', total,\r\n                    'count', count\r\n                )\r\n            ), '[]'::jsonb)\r\n            FROM (\r\n                SELECT \r\n                    category,\r\n                    type,\r\n                    SUM(amount) as total,\r\n                    COUNT(*) as count\r\n                FROM saas_finance_transactions\r\n                WHERE client_id = v_client_id\r\n                  AND EXTRACT(YEAR FROM date) = p_year\r\n                  AND EXTRACT(MONTH FROM date) = p_month\r\n                GROUP BY category, type\r\n                ORDER BY type, total DESC\r\n            ) sub\r\n        ),\r\n        'by_payment_method', (\r\n            SELECT COALESCE(jsonb_agg(\r\n                jsonb_build_object(\r\n                    'method', payment_method,\r\n                    'total', total,\r\n                    'count', count\r\n                )\r\n            ), '[]'::jsonb)\r\n            FROM (\r\n                SELECT \r\n                    COALESCE(payment_method, 'n√£o informado') as payment_method,\r\n                    SUM(amount) as total,\r\n                    COUNT(*) as count\r\n                FROM saas_finance_transactions\r\n                WHERE client_id = v_client_id\r\n                  AND EXTRACT(YEAR FROM date) = p_year\r\n                  AND EXTRACT(MONTH FROM date) = p_month\r\n                  AND type = 'expense'\r\n                GROUP BY payment_method\r\n                ORDER BY total DESC\r\n            ) sub\r\n        ),\r\n        'top_expenses', (\r\n            SELECT COALESCE(jsonb_agg(\r\n                jsonb_build_object(\r\n                    'description', description,\r\n                    'amount', amount,\r\n                    'category', category,\r\n                    'date', date\r\n                )\r\n            ), '[]'::jsonb)\r\n            FROM (\r\n                SELECT description, amount, category, date\r\n                FROM saas_finance_transactions\r\n                WHERE client_id = v_client_id\r\n                  AND EXTRACT(YEAR FROM date) = p_year\r\n                  AND EXTRACT(MONTH FROM date) = p_month\r\n                  AND type = 'expense'\r\n                ORDER BY amount DESC\r\n                LIMIT 10\r\n            ) sub\r\n        ),\r\n        'daily_totals', (\r\n            SELECT COALESCE(jsonb_agg(\r\n                jsonb_build_object(\r\n                    'date', date,\r\n                    'income', income,\r\n                    'expense', expense\r\n                ) ORDER BY date\r\n            ), '[]'::jsonb)\r\n            FROM (\r\n                SELECT \r\n                    date,\r\n                    SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as income,\r\n                    SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as expense\r\n                FROM saas_finance_transactions\r\n                WHERE client_id = v_client_id\r\n                  AND EXTRACT(YEAR FROM date) = p_year\r\n                  AND EXTRACT(MONTH FROM date) = p_month\r\n                GROUP BY date\r\n            ) sub\r\n        )\r\n    ) INTO v_result;\r\n    \r\n    RETURN v_result;\r\nEND;\r\n"
  },
  {
    "function_name": "get_transactions",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\nBEGIN\r\n    v_client_id := get_current_client_id();\r\n    \r\n    IF v_client_id IS NULL THEN\r\n        RETURN;\r\n    END IF;\r\n    \r\n    RETURN QUERY\r\n    WITH filtered AS (\r\n        SELECT \r\n            t.id,\r\n            t.date,\r\n            t.type,\r\n            t.description,\r\n            t.amount,\r\n            t.category,\r\n            t.payment_method,\r\n            t.created_at\r\n        FROM saas_finance_transactions t\r\n        WHERE t.client_id = v_client_id\r\n          AND (p_type IS NULL OR t.type = p_type)\r\n          AND (p_category IS NULL OR t.category = p_category)\r\n          AND (p_start_date IS NULL OR t.date >= p_start_date)\r\n          AND (p_end_date IS NULL OR t.date <= p_end_date)\r\n          AND (p_search IS NULL OR t.description ILIKE '%' || p_search || '%')\r\n    )\r\n    SELECT \r\n        f.id,\r\n        f.date,\r\n        f.type,\r\n        f.description,\r\n        f.amount,\r\n        f.category,\r\n        f.payment_method,\r\n        f.created_at,\r\n        COUNT(*) OVER () as total_count\r\n    FROM filtered f\r\n    ORDER BY f.date DESC, f.created_at DESC\r\n    LIMIT p_limit\r\n    OFFSET p_offset;\r\nEND;\r\n"
  },
  {
    "function_name": "halfvec",
    "function_code": "halfvec"
  },
  {
    "function_name": "halfvec_accum",
    "function_code": "halfvec_accum"
  },
  {
    "function_name": "halfvec_add",
    "function_code": "halfvec_add"
  },
  {
    "function_name": "halfvec_avg",
    "function_code": "halfvec_avg"
  },
  {
    "function_name": "halfvec_cmp",
    "function_code": "halfvec_cmp"
  },
  {
    "function_name": "halfvec_combine",
    "function_code": "vector_combine"
  },
  {
    "function_name": "halfvec_concat",
    "function_code": "halfvec_concat"
  },
  {
    "function_name": "halfvec_eq",
    "function_code": "halfvec_eq"
  },
  {
    "function_name": "halfvec_ge",
    "function_code": "halfvec_ge"
  },
  {
    "function_name": "halfvec_gt",
    "function_code": "halfvec_gt"
  },
  {
    "function_name": "halfvec_in",
    "function_code": "halfvec_in"
  },
  {
    "function_name": "halfvec_l2_squared_distance",
    "function_code": "halfvec_l2_squared_distance"
  },
  {
    "function_name": "halfvec_le",
    "function_code": "halfvec_le"
  },
  {
    "function_name": "halfvec_lt",
    "function_code": "halfvec_lt"
  },
  {
    "function_name": "halfvec_mul",
    "function_code": "halfvec_mul"
  },
  {
    "function_name": "halfvec_ne",
    "function_code": "halfvec_ne"
  },
  {
    "function_name": "halfvec_negative_inner_product",
    "function_code": "halfvec_negative_inner_product"
  },
  {
    "function_name": "halfvec_out",
    "function_code": "halfvec_out"
  },
  {
    "function_name": "halfvec_recv",
    "function_code": "halfvec_recv"
  },
  {
    "function_name": "halfvec_send",
    "function_code": "halfvec_send"
  },
  {
    "function_name": "halfvec_spherical_distance",
    "function_code": "halfvec_spherical_distance"
  },
  {
    "function_name": "halfvec_sub",
    "function_code": "halfvec_sub"
  },
  {
    "function_name": "halfvec_to_float4",
    "function_code": "halfvec_to_float4"
  },
  {
    "function_name": "halfvec_to_sparsevec",
    "function_code": "halfvec_to_sparsevec"
  },
  {
    "function_name": "halfvec_to_vector",
    "function_code": "halfvec_to_vector"
  },
  {
    "function_name": "halfvec_typmod_in",
    "function_code": "halfvec_typmod_in"
  },
  {
    "function_name": "hamming_distance",
    "function_code": "hamming_distance"
  },
  {
    "function_name": "handle_new_auth_user",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\n    v_email TEXT;\r\n    v_name TEXT;\r\n    v_existing_auth UUID;\r\nBEGIN\r\n    v_email := LOWER(TRIM(NEW.email));\r\n    v_name := COALESCE(\r\n        NEW.raw_user_meta_data->>'name',\r\n        NEW.raw_user_meta_data->>'full_name',\r\n        split_part(v_email, '@', 1)\r\n    );\r\n    \r\n    -- Verifica se j√° existe cliente com este auth_user_id\r\n    SELECT id INTO v_client_id\r\n    FROM saas_clients\r\n    WHERE auth_user_id = NEW.id;\r\n    \r\n    IF v_client_id IS NOT NULL THEN\r\n        RETURN NEW;\r\n    END IF;\r\n    \r\n    -- Tenta encontrar cliente existente pelo email\r\n    SELECT id, auth_user_id INTO v_client_id, v_existing_auth\r\n    FROM saas_clients\r\n    WHERE LOWER(email) = v_email \r\n       OR LOWER(COALESCE(billing_email, '')) = v_email\r\n    ORDER BY \r\n        CASE WHEN whatsapp_id IS NOT NULL THEN 0 ELSE 1 END,\r\n        created_at ASC\r\n    LIMIT 1;\r\n    \r\n    IF v_client_id IS NOT NULL THEN\r\n        IF v_existing_auth IS NOT NULL THEN\r\n            RETURN NEW;\r\n        END IF;\r\n        \r\n        UPDATE saas_clients\r\n        SET \r\n            auth_user_id = NEW.id,\r\n            updated_at = NOW()\r\n        WHERE id = v_client_id;\r\n        \r\n        INSERT INTO saas_client_preferences (client_id)\r\n        VALUES (v_client_id)\r\n        ON CONFLICT (client_id) DO NOTHING;\r\n        \r\n    ELSE\r\n        INSERT INTO saas_clients (\r\n            name,\r\n            email,\r\n            auth_user_id,\r\n            status,\r\n            plan\r\n        ) VALUES (\r\n            v_name,\r\n            v_email,\r\n            NEW.id,\r\n            'active',\r\n            'free'\r\n        )\r\n        RETURNING id INTO v_client_id;\r\n        \r\n        INSERT INTO saas_client_preferences (client_id)\r\n        VALUES (v_client_id)\r\n        ON CONFLICT (client_id) DO NOTHING;\r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEXCEPTION WHEN OTHERS THEN\r\n    RAISE LOG 'Erro no handle_new_auth_user: %', SQLERRM;\r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "hnsw_bit_support",
    "function_code": "hnsw_bit_support"
  },
  {
    "function_name": "hnsw_halfvec_support",
    "function_code": "hnsw_halfvec_support"
  },
  {
    "function_name": "hnsw_sparsevec_support",
    "function_code": "hnsw_sparsevec_support"
  },
  {
    "function_name": "hnswhandler",
    "function_code": "hnswhandler"
  },
  {
    "function_name": "increment_appointments_count",
    "function_code": "\r\nBEGIN\r\n  UPDATE saas_clients \r\n  SET appointments_month = COALESCE(appointments_month, 0) + 1\r\n  WHERE id = NEW.client_id;\r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "incrementar_contador",
    "function_code": "\r\nDECLARE\r\n  v_novo_valor int;\r\nBEGIN\r\n  \r\n  CASE p_tipo_acao\r\n    \r\n    -- Incrementa contador de lembretes\r\n    WHEN 'lembrete' THEN\r\n      UPDATE saas_clients\r\n      SET reminders_count = reminders_count + 1,\r\n          updated_at = NOW()\r\n      WHERE whatsapp_id = p_whatsapp_id\r\n      RETURNING reminders_count INTO v_novo_valor;\r\n    \r\n    -- Incrementa contador de listas\r\n    WHEN 'lista' THEN\r\n      UPDATE saas_clients\r\n      SET lists_count = lists_count + 1,\r\n          updated_at = NOW()\r\n      WHERE whatsapp_id = p_whatsapp_id\r\n      RETURNING lists_count INTO v_novo_valor;\r\n    \r\n    -- Incrementa contador de transa√ß√µes\r\n    WHEN 'transacao' THEN\r\n      UPDATE saas_clients\r\n      SET transactions_month = transactions_month + 1,\r\n          updated_at = NOW()\r\n      WHERE whatsapp_id = p_whatsapp_id\r\n      RETURNING transactions_month INTO v_novo_valor;\r\n    \r\n    ELSE\r\n      RETURN jsonb_build_object(\r\n        'sucesso', false,\r\n        'erro', 'Tipo de a√ß√£o inv√°lido'\r\n      );\r\n  END CASE;\r\n  \r\n  -- Retorna sucesso\r\n  RETURN jsonb_build_object(\r\n    'sucesso', true,\r\n    'tipo', p_tipo_acao,\r\n    'novo_valor', v_novo_valor\r\n  );\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "incrementar_pesquisa",
    "function_code": "\r\nDECLARE\r\n  v_novo_valor INTEGER;\r\nBEGIN\r\n  -- Incrementa contador\r\n  UPDATE saas_clients\r\n  SET web_searches_month = web_searches_month + 1\r\n  WHERE whatsapp_id = p_whatsapp_id\r\n  RETURNING web_searches_month INTO v_novo_valor;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object('sucesso', false, 'motivo', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  \r\n  RETURN jsonb_build_object(\r\n    'sucesso', true,\r\n    'novo_valor', v_novo_valor\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "incrementar_rag",
    "function_code": "\r\nDECLARE\r\n  v_novo_valor INTEGER;\r\nBEGIN\r\n  -- Incrementa contador\r\n  UPDATE saas_clients\r\n  SET rag_queries_month = rag_queries_month + 1\r\n  WHERE whatsapp_id = p_whatsapp_id\r\n  RETURNING rag_queries_month INTO v_novo_valor;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object('sucesso', false, 'motivo', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  \r\n  RETURN jsonb_build_object(\r\n    'sucesso', true,\r\n    'novo_valor', v_novo_valor\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "iniciar_fluxo_assinatura",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\n  v_plano RECORD;\r\nBEGIN\r\n  -- Buscar cliente\r\n  SELECT * INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  \r\n  -- Se n√£o informou plano, ir para escolha por n√∫mero\r\n  IF p_plano_escolhido IS NULL OR p_plano_escolhido = '' THEN\r\n    \r\n    UPDATE saas_clients\r\n    SET \r\n      subscription_flow_step = 'escolher_plano',\r\n      subscription_flow_plan = NULL,\r\n      subscription_flow_started_at = NOW(),\r\n      subscription_flow_data = '{}',\r\n      updated_at = NOW()\r\n    WHERE id = v_client.id;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'escolher_plano',\r\n      'step', 'escolher_plano',\r\n      'client_id', v_client.id\r\n    );\r\n  END IF;\r\n  \r\n  -- Verificar se plano existe\r\n  SELECT id, name, price_monthly INTO v_plano\r\n  FROM saas_plans\r\n  WHERE id = p_plano_escolhido AND is_active = true;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('status', 'erro', 'msg', 'Plano n√£o encontrado: ' || p_plano_escolhido);\r\n  END IF;\r\n  \r\n  -- Verificar se j√° tem dados completos de billing\r\n  IF v_client.billing_name IS NOT NULL \r\n     AND v_client.billing_cpf_cnpj IS NOT NULL \r\n     AND v_client.billing_email IS NOT NULL THEN\r\n    \r\n    UPDATE saas_clients\r\n    SET \r\n      subscription_flow_step = 'confirmar_assinatura',\r\n      subscription_flow_plan = p_plano_escolhido,\r\n      subscription_flow_started_at = NOW(),\r\n      subscription_flow_data = jsonb_build_object(\r\n        'plano_id', v_plano.id,\r\n        'plano_nome', v_plano.name,\r\n        'plano_preco', v_plano.price_monthly\r\n      ),\r\n      updated_at = NOW()\r\n    WHERE id = v_client.id;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'dados_completos',\r\n      'client_id', v_client.id,\r\n      'subscription_flow_step', 'confirmar_assinatura',\r\n      'plano', json_build_object(\r\n        'id', v_plano.id,\r\n        'nome', v_plano.name,\r\n        'preco', v_plano.price_monthly\r\n      ),\r\n      'billing', json_build_object(\r\n        'nome', v_client.billing_name,\r\n        'cpf', v_client.billing_cpf_cnpj,\r\n        'email', v_client.billing_email,\r\n        'cep', v_client.billing_postal_code,\r\n        'endereco', v_client.billing_address,\r\n        'numero', v_client.billing_address_number,\r\n        'bairro', v_client.billing_neighborhood,\r\n        'cidade', v_client.billing_city,\r\n        'estado', v_client.billing_state\r\n      )\r\n    );\r\n    \r\n  ELSE\r\n    UPDATE saas_clients\r\n    SET \r\n      subscription_flow_step = 'nome',\r\n      subscription_flow_plan = p_plano_escolhido,\r\n      subscription_flow_started_at = NOW(),\r\n      subscription_flow_data = jsonb_build_object(\r\n        'plano_id', v_plano.id,\r\n        'plano_nome', v_plano.name,\r\n        'plano_preco', v_plano.price_monthly\r\n      ),\r\n      updated_at = NOW()\r\n    WHERE id = v_client.id;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'iniciar_coleta',\r\n      'client_id', v_client.id,\r\n      'subscription_flow_step', 'nome',\r\n      'plano', json_build_object(\r\n        'id', v_plano.id,\r\n        'nome', v_plano.name,\r\n        'preco', v_plano.price_monthly\r\n      )\r\n    );\r\n  END IF;\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "inner_product",
    "function_code": "halfvec_inner_product"
  },
  {
    "function_name": "inner_product",
    "function_code": "sparsevec_inner_product"
  },
  {
    "function_name": "inner_product",
    "function_code": "inner_product"
  },
  {
    "function_name": "ivfflat_bit_support",
    "function_code": "ivfflat_bit_support"
  },
  {
    "function_name": "ivfflat_halfvec_support",
    "function_code": "ivfflat_halfvec_support"
  },
  {
    "function_name": "ivfflathandler",
    "function_code": "ivfflathandler"
  },
  {
    "function_name": "jaccard_distance",
    "function_code": "jaccard_distance"
  },
  {
    "function_name": "l1_distance",
    "function_code": "l1_distance"
  },
  {
    "function_name": "l1_distance",
    "function_code": "halfvec_l1_distance"
  },
  {
    "function_name": "l1_distance",
    "function_code": "sparsevec_l1_distance"
  },
  {
    "function_name": "l2_distance",
    "function_code": "halfvec_l2_distance"
  },
  {
    "function_name": "l2_distance",
    "function_code": "l2_distance"
  },
  {
    "function_name": "l2_distance",
    "function_code": "sparsevec_l2_distance"
  },
  {
    "function_name": "l2_norm",
    "function_code": "halfvec_l2_norm"
  },
  {
    "function_name": "l2_norm",
    "function_code": "sparsevec_l2_norm"
  },
  {
    "function_name": "l2_normalize",
    "function_code": "l2_normalize"
  },
  {
    "function_name": "l2_normalize",
    "function_code": "halfvec_l2_normalize"
  },
  {
    "function_name": "l2_normalize",
    "function_code": "sparsevec_l2_normalize"
  },
  {
    "function_name": "limpar_historico_deleted",
    "function_code": "\r\nBEGIN\r\n  -- Remove do hist√≥rico quando transa√ß√£o √© deletada\r\n  DELETE FROM saas_finance_recent_context\r\n  WHERE client_id = OLD.client_id\r\n    AND transaction_id = OLD.id;\r\n  \r\n  RETURN OLD;\r\nEND;\r\n"
  },
  {
    "function_name": "listar_lembretes_rpc",
    "function_code": "\r\nDECLARE\r\n  v_hoje DATE := CURRENT_DATE;\r\n  v_amanha DATE := CURRENT_DATE + 1;\r\n  v_lembretes_hoje JSON;\r\n  v_lembretes_amanha JSON;\r\n  v_lembretes_proximos JSON;\r\n  v_total INT;\r\n  v_total_hoje INT;\r\n  v_total_amanha INT;\r\n  v_total_proximos INT;\r\nBEGIN\r\n\r\n  -- ========================================\r\n  -- LEMBRETES DE HOJE\r\n  -- ========================================\r\n  SELECT json_agg(\r\n    json_build_object(\r\n      'id', id,\r\n      'titulo', titulo,\r\n      'descricao', descricao,\r\n      'hora', TO_CHAR(hora_lembrete, 'HH24:MI'),\r\n      'prioridade', prioridade,\r\n      'tipo', tipo\r\n    ) ORDER BY hora_lembrete\r\n  )\r\n  INTO v_lembretes_hoje\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND status = 'ativo'\r\n    AND data_lembrete = v_hoje;\r\n\r\n  SELECT COUNT(*) INTO v_total_hoje\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND status = 'ativo'\r\n    AND data_lembrete = v_hoje;\r\n\r\n  -- ========================================\r\n  -- LEMBRETES DE AMANH√É\r\n  -- ========================================\r\n  SELECT json_agg(\r\n    json_build_object(\r\n      'id', id,\r\n      'titulo', titulo,\r\n      'descricao', descricao,\r\n      'hora', TO_CHAR(hora_lembrete, 'HH24:MI'),\r\n      'prioridade', prioridade,\r\n      'tipo', tipo\r\n    ) ORDER BY hora_lembrete\r\n  )\r\n  INTO v_lembretes_amanha\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND status = 'ativo'\r\n    AND data_lembrete = v_amanha;\r\n\r\n  SELECT COUNT(*) INTO v_total_amanha\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND status = 'ativo'\r\n    AND data_lembrete = v_amanha;\r\n\r\n  -- ========================================\r\n  -- PR√ìXIMOS LEMBRETES (depois de amanh√£)\r\n  -- ========================================\r\n  SELECT json_agg(\r\n    json_build_object(\r\n      'id', id,\r\n      'titulo', titulo,\r\n      'descricao', descricao,\r\n      'data', TO_CHAR(data_lembrete, 'DD/MM'),\r\n      'dia_semana', TO_CHAR(data_lembrete, 'TMDy'),\r\n      'hora', TO_CHAR(hora_lembrete, 'HH24:MI'),\r\n      'prioridade', prioridade,\r\n      'tipo', tipo\r\n    ) ORDER BY data_lembrete, hora_lembrete\r\n  )\r\n  INTO v_lembretes_proximos\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND status = 'ativo'\r\n    AND data_lembrete > v_amanha;\r\n\r\n  SELECT COUNT(*) INTO v_total_proximos\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND status = 'ativo'\r\n    AND data_lembrete > v_amanha;\r\n\r\n  -- ========================================\r\n  -- TOTAL GERAL\r\n  -- ========================================\r\n  v_total := COALESCE(v_total_hoje, 0) + COALESCE(v_total_amanha, 0) + COALESCE(v_total_proximos, 0);\r\n\r\n  -- ========================================\r\n  -- RETORNO\r\n  -- ========================================\r\n  IF v_total = 0 THEN\r\n    RETURN json_build_object(\r\n      'status', 'vazio',\r\n      'mensagem', 'Voc√™ n√£o tem lembretes ativos no momento.',\r\n      'total', 0\r\n    );\r\n  END IF;\r\n\r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'data_consulta', TO_CHAR(NOW(), 'DD/MM/YYYY HH24:MI'),\r\n    'total', v_total,\r\n    'resumo', json_build_object(\r\n      'hoje', COALESCE(v_total_hoje, 0),\r\n      'amanha', COALESCE(v_total_amanha, 0),\r\n      'proximos', COALESCE(v_total_proximos, 0)\r\n    ),\r\n    'hoje', COALESCE(v_lembretes_hoje, '[]'::JSON),\r\n    'amanha', COALESCE(v_lembretes_amanha, '[]'::JSON),\r\n    'proximos', COALESCE(v_lembretes_proximos, '[]'::JSON)\r\n  );\r\n\r\nEND;\r\n"
  },
  {
    "function_name": "manter_historico_recente",
    "function_code": "\r\nBEGIN\r\n  -- Insere nova entrada no hist√≥rico\r\n  INSERT INTO saas_finance_recent_context (\r\n    client_id,\r\n    transaction_id,\r\n    transaction_type,\r\n    transaction_description,\r\n    transaction_amount,\r\n    transaction_date,\r\n    transaction_category,\r\n    transaction_payment_method,\r\n    action,\r\n    created_at\r\n  )\r\n  VALUES (\r\n    NEW.client_id,\r\n    NEW.id,\r\n    NEW.type,\r\n    NEW.description,\r\n    NEW.amount,\r\n    NEW.date,\r\n    NEW.category,\r\n    NEW.payment_method,\r\n    CASE \r\n      WHEN TG_OP = 'INSERT' THEN 'registrar'\r\n      WHEN TG_OP = 'UPDATE' THEN 'editar'\r\n      ELSE 'unknown'\r\n    END,\r\n    NOW()\r\n  );\r\n  \r\n  -- Remove entradas antigas (mant√©m s√≥ √∫ltimas 10)\r\n  DELETE FROM saas_finance_recent_context\r\n  WHERE client_id = NEW.client_id\r\n    AND id NOT IN (\r\n      SELECT id \r\n      FROM saas_finance_recent_context\r\n      WHERE client_id = NEW.client_id\r\n      ORDER BY created_at DESC\r\n      LIMIT 10\r\n    );\r\n  \r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "marcar_pagamento_atrasado",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\nBEGIN\r\n  SELECT * INTO v_client\r\n  FROM saas_clients\r\n  WHERE asaas_customer_id = p_asaas_customer_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  \r\n  UPDATE saas_clients\r\n  SET \r\n    payment_status = 'overdue',\r\n    updated_at = NOW()\r\n  WHERE id = v_client.id;\r\n  \r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'whatsapp_id', v_client.whatsapp_id,\r\n    'cliente_nome', COALESCE(v_client.apelido, v_client.name),\r\n    'plano', v_client.plan\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "match_documents",
    "function_code": "\r\nDECLARE\r\n  v_whatsapp_id text;\r\nBEGIN\r\n  -- Extrai o whatsapp_id do filtro, se existir\r\n  v_whatsapp_id := filter->>'whatsapp_id';\r\n  \r\n  RETURN QUERY\r\n  SELECT\r\n    d.id,\r\n    d.content,\r\n    jsonb_build_object(\r\n      'titulo', d.titulo,\r\n      'categoria', d.categoria,\r\n      'fonte', d.fonte,\r\n      'file_type', d.file_type\r\n    ) as metadata,\r\n    1 - (d.embedding <=> query_embedding) as similarity\r\n  FROM saas_documents d\r\n  WHERE d.active = true\r\n    AND (v_whatsapp_id IS NULL OR d.whatsapp_id = v_whatsapp_id) -- Filtro por WhatsApp se enviado\r\n    AND d.embedding IS NOT NULL\r\n  ORDER BY d.embedding <=> query_embedding\r\n  LIMIT match_count;\r\nEND;\r\n"
  },
  {
    "function_name": "match_documents_multitenant",
    "function_code": "\r\nDECLARE\r\n  whatsapp_filter text;\r\nBEGIN\r\n  -- Extrair whatsapp_id lidando com poss√≠veis caminhos n8n\r\n  whatsapp_filter := COALESCE(filter->>'whatsapp_id', filter->'filter'->>'whatsapp_id');\r\n  \r\n  IF whatsapp_filter IS NULL OR whatsapp_filter = '' THEN\r\n    RAISE EXCEPTION 'whatsapp_id √© obrigat√≥rio no filtro. Recebido: %', filter;\r\n  END IF;\r\n  \r\n  RETURN QUERY\r\n  SELECT\r\n    d.id,\r\n    d.content,\r\n    d.metadata, -- Retorna tudo para garantir cita√ß√µes perfeitas\r\n    1 - (d.embedding <=> query_embedding) as similarity\r\n  FROM saas_documents d\r\n  WHERE d.whatsapp_id = whatsapp_filter\r\n    AND d.active = true\r\n    AND 1 - (d.embedding <=> query_embedding) > 0.3 -- Threshold mais amig√°vel\r\n  ORDER BY d.embedding <=> query_embedding\r\n  LIMIT match_count;\r\nEND;\r\n"
  },
  {
    "function_name": "obter_info_planos",
    "function_code": "\r\nDECLARE\r\n  v_client_record RECORD;\r\n  v_planos_disponiveis json;\r\n  v_plano_atual json;\r\n  v_uso_atual json;\r\nBEGIN\r\n  -- Buscar dados do cliente\r\n  SELECT \r\n    c.id,\r\n    c.name,\r\n    c.apelido,\r\n    c.plan,\r\n    c.status,\r\n    c.payment_status,\r\n    c.next_payment_at,\r\n    c.trial_ends_at,\r\n    c.reminders_count,\r\n    c.lists_count,\r\n    c.transactions_month,\r\n    c.rag_queries_month,\r\n    c.documents_count,\r\n    c.web_searches_month,\r\n    c.max_reminders,\r\n    c.max_lists,\r\n    c.max_list_items,\r\n    c.max_transactions_month,\r\n    c.max_rag_queries_month,\r\n    c.max_documents,\r\n    c.max_web_searches_month\r\n  INTO v_client_record\r\n  FROM saas_clients c\r\n  WHERE c.whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object(\r\n      'status', 'erro',\r\n      'msg', 'Cliente n√£o encontrado. Complete o cadastro primeiro.'\r\n    );\r\n  END IF;\r\n  \r\n  -- Montar dados do plano atual\r\n  SELECT json_build_object(\r\n    'id', sp.id,\r\n    'nome', sp.name,\r\n    'preco', sp.price_monthly,\r\n    'descricao', sp.description,\r\n    'features', sp.features\r\n  )\r\n  INTO v_plano_atual\r\n  FROM saas_plans sp\r\n  WHERE sp.id = v_client_record.plan;\r\n  \r\n  -- Montar uso atual com percentuais\r\n  v_uso_atual := json_build_object(\r\n    'lembretes', json_build_object(\r\n      'usado', COALESCE(v_client_record.reminders_count, 0),\r\n      'limite', COALESCE(v_client_record.max_reminders, 0),\r\n      'percentual', CASE \r\n        WHEN COALESCE(v_client_record.max_reminders, 0) <= 0 THEN 0\r\n        ELSE ROUND((COALESCE(v_client_record.reminders_count, 0)::numeric / v_client_record.max_reminders) * 100)\r\n      END\r\n    ),\r\n    'listas', json_build_object(\r\n      'usado', COALESCE(v_client_record.lists_count, 0),\r\n      'limite', COALESCE(v_client_record.max_lists, 0),\r\n      'percentual', CASE \r\n        WHEN COALESCE(v_client_record.max_lists, 0) <= 0 THEN 0\r\n        ELSE ROUND((COALESCE(v_client_record.lists_count, 0)::numeric / v_client_record.max_lists) * 100)\r\n      END\r\n    ),\r\n    'transacoes', json_build_object(\r\n      'usado', COALESCE(v_client_record.transactions_month, 0),\r\n      'limite', COALESCE(v_client_record.max_transactions_month, 0),\r\n      'percentual', CASE \r\n        WHEN COALESCE(v_client_record.max_transactions_month, 0) <= 0 THEN 0\r\n        ELSE ROUND((COALESCE(v_client_record.transactions_month, 0)::numeric / v_client_record.max_transactions_month) * 100)\r\n      END\r\n    ),\r\n    'pesquisas_web', json_build_object(\r\n      'usado', COALESCE(v_client_record.web_searches_month, 0),\r\n      'limite', COALESCE(v_client_record.max_web_searches_month, 0),\r\n      'percentual', CASE \r\n        WHEN COALESCE(v_client_record.max_web_searches_month, 0) <= 0 THEN 0\r\n        ELSE ROUND((COALESCE(v_client_record.web_searches_month, 0)::numeric / v_client_record.max_web_searches_month) * 100)\r\n      END\r\n    ),\r\n    'rag', json_build_object(\r\n      'usado', COALESCE(v_client_record.rag_queries_month, 0),\r\n      'limite', COALESCE(v_client_record.max_rag_queries_month, 0),\r\n      'percentual', CASE \r\n        WHEN COALESCE(v_client_record.max_rag_queries_month, 0) <= 0 THEN 0\r\n        ELSE ROUND((COALESCE(v_client_record.rag_queries_month, 0)::numeric / v_client_record.max_rag_queries_month) * 100)\r\n      END\r\n    ),\r\n    'documentos', json_build_object(\r\n      'usado', COALESCE(v_client_record.documents_count, 0),\r\n      'limite', COALESCE(v_client_record.max_documents, 0),\r\n      'percentual', CASE \r\n        WHEN COALESCE(v_client_record.max_documents, 0) <= 0 THEN 0\r\n        ELSE ROUND((COALESCE(v_client_record.documents_count, 0)::numeric / v_client_record.max_documents) * 100)\r\n      END\r\n    )\r\n  );\r\n  \r\n  -- Buscar planos dispon√≠veis para upgrade\r\n  SELECT json_agg(\r\n    json_build_object(\r\n      'id', sp.id,\r\n      'nome', sp.name,\r\n      'preco', sp.price_monthly,\r\n      'descricao', sp.description,\r\n      'max_lembretes', sp.max_reminders,\r\n      'max_listas', sp.max_lists,\r\n      'max_itens_lista', sp.max_list_items,\r\n      'max_transacoes', sp.max_transactions_month,\r\n      'max_pesquisas_web', sp.max_web_searches_month,\r\n      'max_rag_queries', sp.max_rag_queries_month,\r\n      'max_documentos', sp.max_documents,\r\n      'features', sp.features,\r\n      'is_upgrade', sp.price_monthly > COALESCE(\r\n        (SELECT price_monthly FROM saas_plans WHERE id = v_client_record.plan), 0\r\n      ),\r\n      'is_atual', sp.id = v_client_record.plan\r\n    )\r\n    ORDER BY sp.price_monthly\r\n  )\r\n  INTO v_planos_disponiveis\r\n  FROM saas_plans sp\r\n  WHERE sp.is_active = true;\r\n  \r\n  -- Retornar resultado completo\r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'cliente', json_build_object(\r\n      'nome', COALESCE(v_client_record.apelido, v_client_record.name),\r\n      'status', v_client_record.status,\r\n      'payment_status', v_client_record.payment_status,\r\n      'trial_ends_at', v_client_record.trial_ends_at,\r\n      'next_payment_at', v_client_record.next_payment_at\r\n    ),\r\n    'plano_atual', v_plano_atual,\r\n    'uso_atual', v_uso_atual,\r\n    'planos_disponiveis', v_planos_disponiveis\r\n  );\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "obter_info_uso",
    "function_code": "\r\nDECLARE\r\n  v_client record;\r\n  v_percentual_lembretes numeric;\r\n  v_percentual_listas numeric;\r\n  v_percentual_transacoes numeric;\r\n  v_percentual_rag numeric;\r\n  v_percentual_pesquisa numeric;\r\n  v_dias_ate_renovacao integer;\r\n  v_data_renovacao date;\r\n  v_plano_nome text;\r\n  v_status_texto text;\r\n  v_alerta_nivel text;\r\nBEGIN\r\n  -- ============================================\r\n  -- 1. BUSCAR DADOS DO CLIENTE\r\n  -- ============================================\r\n  SELECT \r\n    status,\r\n    plan,\r\n    trial_ends_at,\r\n    max_reminders,\r\n    max_lists,\r\n    max_transactions_month,\r\n    max_rag_queries_month,\r\n    max_web_searches_month,\r\n    max_documents,\r\n    reminders_count,\r\n    lists_count,\r\n    transactions_month,\r\n    rag_queries_month,\r\n    web_searches_month,\r\n    documents_count,\r\n    transactions_month_reset,\r\n    created_at\r\n  INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  -- Cliente n√£o encontrado\r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object(\r\n      'status', 'erro',\r\n      'mensagem', 'Cliente n√£o encontrado'\r\n    );\r\n  END IF;\r\n  \r\n  -- ============================================\r\n  -- 2. CALCULAR PERCENTUAIS DE USO\r\n  -- ============================================\r\n  \r\n  -- Lembretes\r\n  IF v_client.max_reminders > 0 THEN\r\n    v_percentual_lembretes := ROUND((v_client.reminders_count::numeric / v_client.max_reminders::numeric) * 100);\r\n  ELSE\r\n    v_percentual_lembretes := 0;\r\n  END IF;\r\n  \r\n  -- Listas\r\n  IF v_client.max_lists > 0 THEN\r\n    v_percentual_listas := ROUND((v_client.lists_count::numeric / v_client.max_lists::numeric) * 100);\r\n  ELSE\r\n    v_percentual_listas := 0;\r\n  END IF;\r\n  \r\n  -- Transa√ß√µes\r\n  IF v_client.max_transactions_month > 0 THEN\r\n    v_percentual_transacoes := ROUND((v_client.transactions_month::numeric / v_client.max_transactions_month::numeric) * 100);\r\n  ELSE\r\n    v_percentual_transacoes := 0;\r\n  END IF;\r\n  \r\n  -- RAG (Consultas em Documentos)\r\n  IF v_client.max_rag_queries_month > 0 THEN\r\n    v_percentual_rag := ROUND((v_client.rag_queries_month::numeric / v_client.max_rag_queries_month::numeric) * 100);\r\n  ELSE\r\n    v_percentual_rag := 0;\r\n  END IF;\r\n  \r\n  -- Pesquisa Web\r\n  IF v_client.max_web_searches_month > 0 THEN\r\n    v_percentual_pesquisa := ROUND((v_client.web_searches_month::numeric / v_client.max_web_searches_month::numeric) * 100);\r\n  ELSE\r\n    v_percentual_pesquisa := 0;\r\n  END IF;\r\n  \r\n  -- ============================================\r\n  -- 3. CALCULAR DATA DE RENOVA√á√ÉO\r\n  -- ============================================\r\n  \r\n  IF v_client.status = 'trial' THEN\r\n    v_data_renovacao := v_client.trial_ends_at::date;\r\n    v_dias_ate_renovacao := (v_client.trial_ends_at::date - CURRENT_DATE);\r\n  ELSE\r\n    v_data_renovacao := DATE_TRUNC('month', CURRENT_DATE + INTERVAL '1 month')::date;\r\n    v_dias_ate_renovacao := (v_data_renovacao - CURRENT_DATE);\r\n  END IF;\r\n  \r\n  -- ============================================\r\n  -- 4. DEFINIR NOME DO PLANO E STATUS\r\n  -- ============================================\r\n  \r\n  CASE v_client.plan\r\n    WHEN 'free' THEN v_plano_nome := 'FREE';\r\n    WHEN 'starter' THEN v_plano_nome := 'STARTER';\r\n    WHEN 'pro' THEN v_plano_nome := 'PRO';\r\n    WHEN 'enterprise' THEN v_plano_nome := 'ENTERPRISE';\r\n    ELSE v_plano_nome := UPPER(v_client.plan);\r\n  END CASE;\r\n  \r\n  CASE v_client.status\r\n    WHEN 'active' THEN v_status_texto := 'Ativo';\r\n    WHEN 'trial' THEN v_status_texto := 'Trial (Teste Gr√°tis)';\r\n    WHEN 'suspended' THEN v_status_texto := 'Suspenso';\r\n    WHEN 'cancelled' THEN v_status_texto := 'Cancelado';\r\n    ELSE v_status_texto := v_client.status;\r\n  END CASE;\r\n  \r\n  -- ============================================\r\n  -- 5. DEFINIR N√çVEL DE ALERTA\r\n  -- ============================================\r\n  \r\n  -- Verifica se algum recurso est√° em n√≠vel cr√≠tico (>= 90%)\r\n  IF v_percentual_lembretes >= 90 OR \r\n     v_percentual_listas >= 90 OR \r\n     v_percentual_transacoes >= 90 OR\r\n     v_percentual_rag >= 90 OR\r\n     v_percentual_pesquisa >= 90 THEN\r\n    v_alerta_nivel := 'critico';\r\n    \r\n  -- Verifica se algum recurso est√° em aten√ß√£o (>= 80%)\r\n  ELSIF v_percentual_lembretes >= 80 OR \r\n        v_percentual_listas >= 80 OR \r\n        v_percentual_transacoes >= 80 OR\r\n        v_percentual_rag >= 80 OR\r\n        v_percentual_pesquisa >= 80 THEN\r\n    v_alerta_nivel := 'atencao';\r\n    \r\n  ELSE\r\n    v_alerta_nivel := 'ok';\r\n  END IF;\r\n  \r\n  -- ============================================\r\n  -- 6. RETORNAR JSON ESTRUTURADO\r\n  -- ============================================\r\n  \r\n  RETURN jsonb_build_object(\r\n    'status', 'sucesso',\r\n    'plano', jsonb_build_object(\r\n      'nome', v_plano_nome,\r\n      'status', v_status_texto,\r\n      'status_code', v_client.status\r\n    ),\r\n    'uso', jsonb_build_object(\r\n      'lembretes', jsonb_build_object(\r\n        'usado', v_client.reminders_count,\r\n        'limite', v_client.max_reminders,\r\n        'percentual', v_percentual_lembretes,\r\n        'disponivel', GREATEST(0, v_client.max_reminders - v_client.reminders_count),\r\n        'ilimitado', v_client.max_reminders <= 0\r\n      ),\r\n      'listas', jsonb_build_object(\r\n        'usado', v_client.lists_count,\r\n        'limite', v_client.max_lists,\r\n        'percentual', v_percentual_listas,\r\n        'disponivel', GREATEST(0, v_client.max_lists - v_client.lists_count),\r\n        'ilimitado', v_client.max_lists <= 0\r\n      ),\r\n      'transacoes', jsonb_build_object(\r\n        'usado', v_client.transactions_month,\r\n        'limite', v_client.max_transactions_month,\r\n        'percentual', v_percentual_transacoes,\r\n        'disponivel', GREATEST(0, v_client.max_transactions_month - v_client.transactions_month),\r\n        'ilimitado', v_client.max_transactions_month <= 0\r\n      ),\r\n      'rag', jsonb_build_object(\r\n        'consultas_usado', v_client.rag_queries_month,\r\n        'consultas_limite', v_client.max_rag_queries_month,\r\n        'consultas_percentual', v_percentual_rag,\r\n        'consultas_disponivel', GREATEST(0, v_client.max_rag_queries_month - v_client.rag_queries_month),\r\n        'documentos_usado', v_client.documents_count,\r\n        'documentos_limite', v_client.max_documents,\r\n        'ilimitado', v_client.max_rag_queries_month <= 0\r\n      ),\r\n      'pesquisa', jsonb_build_object(\r\n        'usado', v_client.web_searches_month,\r\n        'limite', v_client.max_web_searches_month,\r\n        'percentual', v_percentual_pesquisa,\r\n        'disponivel', GREATEST(0, v_client.max_web_searches_month - v_client.web_searches_month),\r\n        'ilimitado', v_client.max_web_searches_month <= 0\r\n      )\r\n    ),\r\n    'renovacao', jsonb_build_object(\r\n      'data', TO_CHAR(v_data_renovacao, 'DD/MM/YYYY'),\r\n      'dias_restantes', v_dias_ate_renovacao\r\n    ),\r\n    'alerta', jsonb_build_object(\r\n      'nivel', v_alerta_nivel,\r\n      'mensagem', CASE \r\n        WHEN v_alerta_nivel = 'critico' THEN 'Voc√™ est√° pr√≥ximo do limite!'\r\n        WHEN v_alerta_nivel = 'atencao' THEN 'Aten√ß√£o ao seu uso'\r\n        ELSE 'Tudo certo com seu plano'\r\n      END\r\n    )\r\n  );\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "obter_status_plano",
    "function_code": "\r\nDECLARE\r\n  v_client record;\r\nBEGIN\r\n  \r\n  SELECT \r\n    name,\r\n    plan,\r\n    status,\r\n    trial_ends_at,\r\n    -- Lembretes\r\n    reminders_count,\r\n    max_reminders,\r\n    CASE \r\n      WHEN max_reminders > 0 THEN \r\n        ROUND((reminders_count::numeric / max_reminders::numeric) * 100, 1)\r\n      ELSE 0 \r\n    END as reminders_percentual,\r\n    -- Listas\r\n    lists_count,\r\n    max_lists,\r\n    CASE \r\n      WHEN max_lists > 0 THEN \r\n        ROUND((lists_count::numeric / max_lists::numeric) * 100, 1)\r\n      ELSE 0 \r\n    END as lists_percentual,\r\n    -- Transa√ß√µes\r\n    transactions_month,\r\n    max_transactions_month,\r\n    CASE \r\n      WHEN max_transactions_month > 0 THEN \r\n        ROUND((transactions_month::numeric / max_transactions_month::numeric) * 100, 1)\r\n      ELSE 0 \r\n    END as transactions_percentual\r\n  INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object(\r\n      'encontrado', false,\r\n      'erro', 'Cliente n√£o encontrado'\r\n    );\r\n  END IF;\r\n  \r\n  RETURN jsonb_build_object(\r\n    'encontrado', true,\r\n    'nome', v_client.name,\r\n    'plano', v_client.plan,\r\n    'status', v_client.status,\r\n    'trial_termina', v_client.trial_ends_at,\r\n    'lembretes', jsonb_build_object(\r\n      'usado', v_client.reminders_count,\r\n      'limite', v_client.max_reminders,\r\n      'percentual', v_client.reminders_percentual\r\n    ),\r\n    'listas', jsonb_build_object(\r\n      'usado', v_client.lists_count,\r\n      'limite', v_client.max_lists,\r\n      'percentual', v_client.lists_percentual\r\n    ),\r\n    'transacoes', jsonb_build_object(\r\n      'usado', v_client.transactions_month,\r\n      'limite', v_client.max_transactions_month,\r\n      'percentual', v_client.transactions_percentual\r\n    )\r\n  );\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "pegar_ultima_transacao",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    frc.transaction_id,\r\n    frc.transaction_description,\r\n    frc.transaction_amount,\r\n    frc.transaction_date,\r\n    CASE WHEN frc.transaction_type = 'income' THEN 'receita' ELSE 'despesa' END,\r\n    frc.transaction_category,\r\n    frc.action\r\n  FROM saas_finance_recent_context frc\r\n  WHERE frc.client_id = p_client_id\r\n  ORDER BY frc.created_at DESC\r\n  LIMIT 1;\r\nEND;\r\n"
  },
  {
    "function_name": "pegar_ultimas_transacoes",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    frc.transaction_id,\r\n    frc.transaction_description,\r\n    frc.transaction_amount,\r\n    frc.transaction_date,\r\n    CASE WHEN frc.transaction_type = 'income' THEN 'receita' ELSE 'despesa' END,\r\n    frc.transaction_category,\r\n    frc.action,\r\n    frc.created_at\r\n  FROM saas_finance_recent_context frc\r\n  WHERE frc.client_id = p_client_id\r\n  ORDER BY frc.created_at DESC\r\n  LIMIT p_quantidade;\r\nEND;\r\n"
  },
  {
    "function_name": "processar_etapa_assinatura",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\n  v_step text;\r\n  v_plan text;\r\n  v_data jsonb;\r\n  v_plano RECORD;\r\n  v_cpf_limpo text;\r\n  v_cep_limpo text;\r\n  v_resposta_lower text;\r\n  v_endereco_partes text[];\r\n  v_cpf_formatado text;\r\n  v_resumo text;\r\n  v_billing jsonb;\r\n  v_plano_escolhido text;\r\nBEGIN\r\n  SELECT * INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF NOT FOUND THEN\r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado.');\r\n  END IF;\r\n  \r\n  v_step := v_client.subscription_flow_step;\r\n  v_plan := v_client.subscription_flow_plan;\r\n  v_data := COALESCE(v_client.subscription_flow_data, '{}');\r\n  v_resposta_lower := LOWER(TRIM(p_resposta));\r\n  \r\n  IF v_step IS NULL THEN\r\n    RETURN json_build_object(\r\n      'status', 'sem_fluxo',\r\n      'msg', 'Voc√™ n√£o est√° em um fluxo de assinatura.'\r\n    );\r\n  END IF;\r\n  \r\n  -- Verificar se quer sair do fluxo (exceto no step cancelar_plano)\r\n  IF v_resposta_lower IN ('#cancelar', 'cancelar', 'sair', 'parar') AND v_step <> 'cancelar_plano' THEN\r\n    UPDATE saas_clients\r\n    SET \r\n      subscription_flow_step = NULL,\r\n      subscription_flow_plan = NULL,\r\n      subscription_flow_data = NULL,\r\n      updated_at = NOW()\r\n    WHERE id = v_client.id;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'cancelado',\r\n      'msg', 'Fluxo de assinatura cancelado. Quando quiser, digite *#assinar* para recome√ßar.'\r\n    );\r\n  END IF;\r\n  \r\n  -- Se j√° tem plano definido, buscar dados\r\n  IF v_plan IS NOT NULL THEN\r\n    SELECT * INTO v_plano FROM saas_plans WHERE id = v_plan;\r\n  END IF;\r\n  \r\n  CASE v_step\r\n\r\n    -- =====================================================\r\n    -- STEP: CANCELAR_PLANO (confirma√ß√£o de cancelamento)\r\n    -- =====================================================\r\n    WHEN 'cancelar_plano' THEN\r\n      IF v_resposta_lower IN ('confirmar', 'confirmo', 'sim', 's', 'pode', 'ok', 'quero') THEN\r\n        -- Cliente confirmou - retorna para o n8n fazer o DELETE no Asaas\r\n        RETURN json_build_object(\r\n          'status', 'cancelar_confirmado',\r\n          'msg', '‚úÖ Cancelando sua assinatura...',\r\n          'asaas_subscription_id', v_client.asaas_subscription_id,\r\n          'asaas_customer_id', v_client.asaas_customer_id,\r\n          'client_id', v_client.id,\r\n          'plano_atual', v_client.plan\r\n        );\r\n        \r\n      ELSIF v_resposta_lower IN ('n√£o', 'nao', 'n', 'n√£o quero', 'manter', 'fica', 'ficar', 'desisto') THEN\r\n        -- Cliente desistiu de cancelar\r\n        UPDATE saas_clients\r\n        SET \r\n          subscription_flow_step = NULL,\r\n          subscription_flow_plan = NULL,\r\n          subscription_flow_data = NULL,\r\n          updated_at = NOW()\r\n        WHERE id = v_client.id;\r\n        \r\n        RETURN json_build_object(\r\n          'status', 'cancelar_desistiu',\r\n          'msg', 'üéâ *√ìtimo! Que bom que voc√™ vai ficar!*\\n\\nSeu plano *' || UPPER(v_client.plan) || '* continua ativo normalmente.\\n\\nPosso ajudar em algo mais?'\r\n        );\r\n        \r\n      ELSE\r\n        -- Resposta n√£o reconhecida\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'cancelar_plano',\r\n          'msg', 'ü§î N√£o entendi...\\n\\nDigite *CONFIRMAR* para cancelar sua assinatura\\nOu *N√ÉO* para manter seu plano.'\r\n        );\r\n      END IF;\r\n\r\n    -- =====================================================\r\n    -- STEP: ESCOLHER_PLANO (sele√ß√£o por n√∫mero)\r\n    -- =====================================================\r\n    WHEN 'escolher_plano' THEN\r\n      v_plano_escolhido := CASE v_resposta_lower\r\n        WHEN '1' THEN 'starter'\r\n        WHEN '2' THEN 'pro'\r\n        WHEN '3' THEN 'enterprise'\r\n        WHEN 'starter' THEN 'starter'\r\n        WHEN 'pro' THEN 'pro'\r\n        WHEN 'enterprise' THEN 'enterprise'\r\n        ELSE NULL\r\n      END;\r\n      \r\n      IF v_plano_escolhido IS NULL THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'escolher_plano',\r\n          'msg', '‚ùå Op√ß√£o inv√°lida.\\n\\nDigite *1*, *2* ou *3* para escolher seu plano:\\n\\n1Ô∏è‚É£ Starter\\n2Ô∏è‚É£ Pro\\n3Ô∏è‚É£ Enterprise'\r\n        );\r\n      END IF;\r\n      \r\n      SELECT * INTO v_plano FROM saas_plans WHERE id = v_plano_escolhido;\r\n      \r\n      UPDATE saas_clients\r\n      SET \r\n        subscription_flow_plan = v_plano_escolhido,\r\n        subscription_flow_data = jsonb_build_object(\r\n          'plano_id', v_plano.id,\r\n          'plano_nome', v_plano.name,\r\n          'plano_preco', v_plano.price_monthly\r\n        ),\r\n        updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      IF v_client.billing_name IS NOT NULL \r\n         AND v_client.billing_cpf_cnpj IS NOT NULL \r\n         AND v_client.billing_email IS NOT NULL THEN\r\n        \r\n        UPDATE saas_clients\r\n        SET subscription_flow_step = 'confirmar_assinatura'\r\n        WHERE id = v_client.id;\r\n        \r\n        RETURN json_build_object(\r\n          'status', 'dados_completos',\r\n          'step', 'confirmar_assinatura',\r\n          'msg', '‚úÖ Seus dados j√° est√£o cadastrados!\\n\\nüì¶ Plano: *' || UPPER(v_plano.name) || '*\\nüí∞ Valor: *R$ ' || REPLACE(v_plano.price_monthly::text, '.', ',') || '*/m√™s\\n\\nDeseja continuar com a assinatura?\\nDigite *SIM* para confirmar ou *#cancelar* para desistir.'\r\n        );\r\n      ELSE\r\n        UPDATE saas_clients\r\n        SET subscription_flow_step = 'nome'\r\n        WHERE id = v_client.id;\r\n        \r\n        RETURN json_build_object(\r\n          'status', 'iniciar_coleta',\r\n          'step', 'nome',\r\n          'msg', 'üéâ *√ìtima escolha!*\\n\\nüì¶ Plano: *' || UPPER(v_plano.name) || '*\\nüí∞ Valor: *R$ ' || REPLACE(v_plano.price_monthly::text, '.', ',') || '*/m√™s\\n\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\nPara finalizar, preciso de alguns dados.\\n\\nQual seu *nome completo*?\\n\\n_Digite #cancelar a qualquer momento para sair._'\r\n        );\r\n      END IF;\r\n\r\n    -- =====================================================\r\n    -- STEP: CONFIRMAR_ASSINATURA\r\n    -- =====================================================\r\n    WHEN 'confirmar_assinatura' THEN\r\n      IF v_resposta_lower IN ('sim', 's', 'ok', 'confirmo', 'confirmar', 'certo', 'quero', 'pode', 'bora', 'vamos') THEN\r\n        \r\n        v_resumo := 'üìú *Termos do Servi√ßo*\\n\\n';\r\n        v_resumo := v_resumo || 'Voc√™ est√° contratando o plano *' || UPPER(v_plano.name) || '* por *R$ ' || REPLACE(v_plano.price_monthly::text, '.', ',') || '/m√™s*.\\n\\n';\r\n        v_resumo := v_resumo || 'üí≥ A cobran√ßa ser√° realizada *mensalmente* no seu cart√£o de cr√©dito.\\n\\n';\r\n        v_resumo := v_resumo || 'üîì *Sem fidelidade!*\\n';\r\n        v_resumo := v_resumo || '‚Ä¢ Sem tempo m√≠nimo de perman√™ncia\\n';\r\n        v_resumo := v_resumo || '‚Ä¢ Sem multas por cancelamento\\n';\r\n        v_resumo := v_resumo || '‚Ä¢ Cancele quando quiser com *#cancelarplano*\\n\\n';\r\n        v_resumo := v_resumo || 'Digite *ACEITO* para finalizar e receber o link de pagamento.';\r\n        \r\n        UPDATE saas_clients\r\n        SET subscription_flow_step = 'aceite', updated_at = NOW()\r\n        WHERE id = v_client.id;\r\n        \r\n        RETURN json_build_object('status', 'proximo', 'step', 'aceite', 'msg', v_resumo);\r\n        \r\n      ELSIF v_resposta_lower IN ('corrigir', 'alterar', 'mudar', 'editar', 'nao', 'n√£o', 'n') THEN\r\n        \r\n        UPDATE saas_clients\r\n        SET subscription_flow_step = 'nome', subscription_flow_data = v_data || '{}', updated_at = NOW()\r\n        WHERE id = v_client.id;\r\n        \r\n        RETURN json_build_object('status', 'proximo', 'step', 'nome', 'msg', 'Ok! Vamos atualizar seus dados.\\n\\nQual seu *nome completo*?');\r\n        \r\n      ELSE\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'confirmar_assinatura',\r\n          'msg', 'ü§î N√£o entendi sua resposta.\\n\\nDigite *SIM* para confirmar a assinatura\\nOu *CORRIGIR* para atualizar seus dados\\nOu *#cancelar* para desistir.'\r\n        );\r\n      END IF;\r\n  \r\n    -- ETAPA: NOME\r\n    WHEN 'nome' THEN\r\n      IF LENGTH(TRIM(p_resposta)) < 5 THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'nome',\r\n          'msg', 'Por favor, informe seu *nome completo* (m√≠nimo 5 caracteres).\\n\\n_Digite #cancelar para sair._'\r\n        );\r\n      END IF;\r\n      \r\n      v_data := v_data || jsonb_build_object('nome', TRIM(p_resposta));\r\n      \r\n      UPDATE saas_clients\r\n      SET subscription_flow_step = 'cpf', subscription_flow_data = v_data, updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      RETURN json_build_object(\r\n        'status', 'proximo',\r\n        'step', 'cpf',\r\n        'msg', 'Agora informe seu *CPF* (apenas n√∫meros):\\n\\n_Se for empresa, informe o CNPJ._'\r\n      );\r\n    \r\n    -- ETAPA: CPF/CNPJ (COM VALIDA√á√ÉO)\r\n    WHEN 'cpf' THEN\r\n      v_cpf_limpo := REGEXP_REPLACE(p_resposta, '[^0-9]', '', 'g');\r\n      \r\n      IF LENGTH(v_cpf_limpo) <> 11 AND LENGTH(v_cpf_limpo) <> 14 THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'cpf',\r\n          'msg', '‚ùå CPF/CNPJ inv√°lido.\\n\\nDigite os *11 n√∫meros* do CPF ou *14 n√∫meros* do CNPJ:'\r\n        );\r\n      END IF;\r\n      \r\n      IF LENGTH(v_cpf_limpo) = 11 THEN\r\n        IF NOT validar_cpf(v_cpf_limpo) THEN\r\n          RETURN json_build_object(\r\n            'status', 'retry',\r\n            'step', 'cpf',\r\n            'msg', '‚ùå CPF inv√°lido!\\n\\nOs d√≠gitos verificadores n√£o conferem.\\nVerifique e digite novamente:'\r\n          );\r\n        END IF;\r\n      END IF;\r\n      \r\n      IF LENGTH(v_cpf_limpo) = 14 THEN\r\n        IF NOT validar_cnpj(v_cpf_limpo) THEN\r\n          RETURN json_build_object(\r\n            'status', 'retry',\r\n            'step', 'cpf',\r\n            'msg', '‚ùå CNPJ inv√°lido!\\n\\nOs d√≠gitos verificadores n√£o conferem.\\nVerifique e digite novamente:'\r\n          );\r\n        END IF;\r\n      END IF;\r\n      \r\n      v_data := v_data || jsonb_build_object('cpf', v_cpf_limpo);\r\n      \r\n      UPDATE saas_clients\r\n      SET subscription_flow_step = 'email', subscription_flow_data = v_data, updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      RETURN json_build_object(\r\n        'status', 'proximo',\r\n        'step', 'email',\r\n        'msg', '‚úÖ CPF/CNPJ v√°lido!\\n\\nAgora seu *e-mail*:\\n\\n_Enviaremos a nota fiscal para este e-mail._'\r\n      );\r\n    \r\n    -- ETAPA: EMAIL\r\n    WHEN 'email' THEN\r\n      IF NOT p_resposta ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$' THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'email',\r\n          'msg', '‚ùå E-mail inv√°lido.\\n\\nPor favor, digite um e-mail v√°lido:'\r\n        );\r\n      END IF;\r\n      \r\n      v_data := v_data || jsonb_build_object('email', LOWER(TRIM(p_resposta)));\r\n      \r\n      UPDATE saas_clients\r\n      SET subscription_flow_step = 'cep', subscription_flow_data = v_data, updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      RETURN json_build_object(\r\n        'status', 'proximo',\r\n        'step', 'cep',\r\n        'msg', '√ìtimo! Agora seu *CEP* (apenas n√∫meros):\\n\\n_Vamos buscar seu endere√ßo automaticamente!_\\n_Se n√£o sabe, digite *n√£o sei*_'\r\n      );\r\n    \r\n    -- ETAPA: CEP\r\n    WHEN 'cep' THEN\r\n      IF v_resposta_lower IN ('n√£o sei', 'nao sei', 'n√£o lembro', 'nao lembro', 'pular', 'skip', 'n', 'nsei', 'n√£o', 'nao') THEN\r\n        UPDATE saas_clients\r\n        SET subscription_flow_step = 'endereco_completo', updated_at = NOW()\r\n        WHERE id = v_client.id;\r\n        \r\n        RETURN json_build_object(\r\n          'status', 'proximo',\r\n          'step', 'endereco_completo',\r\n          'msg', 'Sem problema! Informe o endere√ßo completo:\\n*Rua/Av Nome, N√∫mero, Bairro, Cidade UF*\\n\\nExemplo: Rua das Flores, 123, Centro, Araraquara SP'\r\n        );\r\n      END IF;\r\n      \r\n      v_cep_limpo := REGEXP_REPLACE(p_resposta, '[^0-9]', '', 'g');\r\n      \r\n      IF LENGTH(v_cep_limpo) <> 8 THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'cep',\r\n          'msg', '‚ùå CEP inv√°lido.\\n\\nDigite os *8 n√∫meros* do CEP:\\n\\n_Se n√£o sabe o CEP, digite *n√£o sei*_'\r\n        );\r\n      END IF;\r\n      \r\n      v_data := v_data || jsonb_build_object('cep', v_cep_limpo);\r\n      \r\n      UPDATE saas_clients\r\n      SET subscription_flow_data = v_data, updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      RETURN json_build_object(\r\n        'status', 'buscar_cep',\r\n        'step', 'cep',\r\n        'cep', v_cep_limpo,\r\n        'client_id', v_client.id,\r\n        'msg', 'üîç Buscando seu endere√ßo...'\r\n      );\r\n    \r\n    -- ETAPA: N√öMERO (ap√≥s CEP encontrado)\r\n    WHEN 'numero_cep' THEN\r\n      IF v_resposta_lower IN ('corrigir', 'errado', 'incorreto', 'mudar', 'outro') THEN\r\n        UPDATE saas_clients\r\n        SET subscription_flow_step = 'endereco_completo', updated_at = NOW()\r\n        WHERE id = v_client.id;\r\n        \r\n        RETURN json_build_object(\r\n          'status', 'proximo',\r\n          'step', 'endereco_completo',\r\n          'msg', 'Ok! Informe o endere√ßo completo:\\n*Rua/Av Nome, N√∫mero, Bairro, Cidade UF*'\r\n        );\r\n      END IF;\r\n      \r\n      IF LENGTH(TRIM(p_resposta)) < 1 THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'numero_cep',\r\n          'msg', 'Por favor, informe o *n√∫mero* do endere√ßo:\\n\\n_Se o endere√ßo estiver errado, digite *corrigir*_'\r\n        );\r\n      END IF;\r\n      \r\n      v_data := v_data || jsonb_build_object('numero', TRIM(p_resposta));\r\n      \r\n      v_cpf_formatado := CASE \r\n        WHEN LENGTH(v_data->>'cpf') = 11 THEN\r\n          SUBSTRING(v_data->>'cpf', 1, 3) || '.' || \r\n          SUBSTRING(v_data->>'cpf', 4, 3) || '.' || \r\n          SUBSTRING(v_data->>'cpf', 7, 3) || '-' || \r\n          SUBSTRING(v_data->>'cpf', 10, 2)\r\n        ELSE v_data->>'cpf'\r\n      END;\r\n      \r\n      v_resumo := 'üìã *Confirme seus dados:*\\n\\n';\r\n      v_resumo := v_resumo || 'üë§ Nome: ' || (v_data->>'nome') || '\\n';\r\n      v_resumo := v_resumo || 'üìÑ CPF/CNPJ: ' || v_cpf_formatado || '\\n';\r\n      v_resumo := v_resumo || 'üìß Email: ' || (v_data->>'email') || '\\n';\r\n      v_resumo := v_resumo || 'üìç Endere√ßo: ' || (v_data->>'endereco') || ', ' || (v_data->>'numero') || '\\n';\r\n      v_resumo := v_resumo || 'üèòÔ∏è ' || (v_data->>'bairro') || ' - ' || (v_data->>'cidade') || '/' || (v_data->>'estado') || '\\n\\n';\r\n      v_resumo := v_resumo || 'Est√° tudo certo?\\n';\r\n      v_resumo := v_resumo || '‚úÖ Digite *SIM* para continuar\\n';\r\n      v_resumo := v_resumo || '‚úèÔ∏è Ou digite *nome*, *cpf*, *email* ou *endereco* para corrigir';\r\n      \r\n      UPDATE saas_clients\r\n      SET subscription_flow_step = 'confirmar', subscription_flow_data = v_data, updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      RETURN json_build_object('status', 'proximo', 'step', 'confirmar', 'msg', v_resumo);\r\n    \r\n    -- ETAPA: ENDERE√áO COMPLETO (fallback)\r\n    WHEN 'endereco_completo' THEN\r\n      v_endereco_partes := string_to_array(TRIM(p_resposta), ',');\r\n      \r\n      IF array_length(v_endereco_partes, 1) < 4 THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'endereco_completo',\r\n          'msg', '‚ùå Formato inv√°lido.\\n\\nPor favor, informe no formato:\\n*Rua/Av Nome, N√∫mero, Bairro, Cidade UF*\\n\\nExemplo: Rua das Flores, 123, Centro, Araraquara SP'\r\n        );\r\n      END IF;\r\n      \r\n      v_data := v_data || jsonb_build_object(\r\n        'endereco', TRIM(v_endereco_partes[1]),\r\n        'numero', TRIM(v_endereco_partes[2]),\r\n        'bairro', TRIM(v_endereco_partes[3]),\r\n        'cidade', TRIM(REGEXP_REPLACE(v_endereco_partes[4], '\\s+[A-Z]{2}$', '')),\r\n        'estado', UPPER(TRIM(COALESCE(\r\n          (SELECT (REGEXP_MATCHES(v_endereco_partes[4], '\\s+([A-Z]{2})$'))[1]),\r\n          'SP'\r\n        )))\r\n      );\r\n      \r\n      v_cpf_formatado := CASE \r\n        WHEN LENGTH(v_data->>'cpf') = 11 THEN\r\n          SUBSTRING(v_data->>'cpf', 1, 3) || '.' || \r\n          SUBSTRING(v_data->>'cpf', 4, 3) || '.' || \r\n          SUBSTRING(v_data->>'cpf', 7, 3) || '-' || \r\n          SUBSTRING(v_data->>'cpf', 10, 2)\r\n        ELSE v_data->>'cpf'\r\n      END;\r\n      \r\n      v_resumo := 'üìã *Confirme seus dados:*\\n\\n';\r\n      v_resumo := v_resumo || 'üë§ Nome: ' || (v_data->>'nome') || '\\n';\r\n      v_resumo := v_resumo || 'üìÑ CPF/CNPJ: ' || v_cpf_formatado || '\\n';\r\n      v_resumo := v_resumo || 'üìß Email: ' || (v_data->>'email') || '\\n';\r\n      v_resumo := v_resumo || 'üìç Endere√ßo: ' || (v_data->>'endereco') || ', ' || (v_data->>'numero') || '\\n';\r\n      v_resumo := v_resumo || 'üèòÔ∏è ' || (v_data->>'bairro') || ' - ' || (v_data->>'cidade') || '/' || (v_data->>'estado') || '\\n\\n';\r\n      v_resumo := v_resumo || 'Est√° tudo certo?\\n';\r\n      v_resumo := v_resumo || '‚úÖ Digite *SIM* para continuar\\n';\r\n      v_resumo := v_resumo || '‚úèÔ∏è Ou digite *nome*, *cpf*, *email* ou *endereco* para corrigir';\r\n      \r\n      UPDATE saas_clients\r\n      SET subscription_flow_step = 'confirmar', subscription_flow_data = v_data, updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      RETURN json_build_object('status', 'proximo', 'step', 'confirmar', 'msg', v_resumo);\r\n    \r\n    -- ETAPA: CONFIRMAR DADOS\r\n    WHEN 'confirmar' THEN\r\n      IF v_resposta_lower = 'nome' THEN\r\n        UPDATE saas_clients SET subscription_flow_step = 'nome', updated_at = NOW() WHERE id = v_client.id;\r\n        RETURN json_build_object('status', 'proximo', 'step', 'nome', 'msg', 'Ok! Digite seu *nome completo*:');\r\n      ELSIF v_resposta_lower = 'cpf' THEN\r\n        UPDATE saas_clients SET subscription_flow_step = 'cpf', updated_at = NOW() WHERE id = v_client.id;\r\n        RETURN json_build_object('status', 'proximo', 'step', 'cpf', 'msg', 'Ok! Digite seu *CPF/CNPJ*:');\r\n      ELSIF v_resposta_lower = 'email' THEN\r\n        UPDATE saas_clients SET subscription_flow_step = 'email', updated_at = NOW() WHERE id = v_client.id;\r\n        RETURN json_build_object('status', 'proximo', 'step', 'email', 'msg', 'Ok! Digite seu *e-mail*:');\r\n      ELSIF v_resposta_lower IN ('endereco', 'endere√ßo', 'end') THEN\r\n        UPDATE saas_clients SET subscription_flow_step = 'endereco_completo', updated_at = NOW() WHERE id = v_client.id;\r\n        RETURN json_build_object('status', 'proximo', 'step', 'endereco_completo', 'msg', 'Ok! Informe o endere√ßo completo:\\n*Rua/Av Nome, N√∫mero, Bairro, Cidade UF*');\r\n      END IF;\r\n      \r\n      IF v_resposta_lower NOT IN ('sim', 's', 'ok', 'confirmo', 'confirmar', 'certo', 'correto') THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'confirmar',\r\n          'msg', 'Por favor, digite *SIM* para confirmar ou o campo que deseja corrigir:\\n*nome*, *cpf*, *email* ou *endereco*'\r\n        );\r\n      END IF;\r\n      \r\n      v_resumo := 'üìú *Termos do Servi√ßo*\\n\\n';\r\n      v_resumo := v_resumo || 'Voc√™ est√° contratando o plano *' || UPPER(v_plano.name) || '* por *R$ ' || REPLACE(v_plano.price_monthly::text, '.', ',') || '/m√™s*.\\n\\n';\r\n      v_resumo := v_resumo || 'üí≥ A cobran√ßa ser√° realizada *mensalmente* no seu cart√£o de cr√©dito.\\n\\n';\r\n      v_resumo := v_resumo || 'üîì *Sem fidelidade!*\\n';\r\n      v_resumo := v_resumo || '‚Ä¢ Sem tempo m√≠nimo de perman√™ncia\\n';\r\n      v_resumo := v_resumo || '‚Ä¢ Sem multas por cancelamento\\n';\r\n      v_resumo := v_resumo || '‚Ä¢ Cancele quando quiser com *#cancelarplano*\\n\\n';\r\n      v_resumo := v_resumo || 'Digite *ACEITO* para finalizar e receber o link de pagamento.';\r\n      \r\n      UPDATE saas_clients\r\n      SET subscription_flow_step = 'aceite', updated_at = NOW()\r\n      WHERE id = v_client.id;\r\n      \r\n      RETURN json_build_object('status', 'proximo', 'step', 'aceite', 'msg', v_resumo);\r\n    \r\n    -- ETAPA: ACEITE DOS TERMOS\r\n    WHEN 'aceite' THEN\r\n      IF v_resposta_lower NOT IN ('aceito', 'aceitar', 'concordo', 'ok', 'sim', 's') THEN\r\n        RETURN json_build_object(\r\n          'status', 'retry',\r\n          'step', 'aceite',\r\n          'msg', 'Para continuar, digite *ACEITO* para concordar com os termos.\\n\\nOu digite *#cancelar* para sair.'\r\n        );\r\n      END IF;\r\n      \r\n      IF v_data->>'nome' IS NOT NULL THEN\r\n        UPDATE saas_clients\r\n        SET \r\n          billing_name = v_data->>'nome',\r\n          billing_cpf_cnpj = v_data->>'cpf',\r\n          billing_email = v_data->>'email',\r\n          billing_postal_code = v_data->>'cep',\r\n          billing_address = v_data->>'endereco',\r\n          billing_address_number = v_data->>'numero',\r\n          billing_neighborhood = v_data->>'bairro',\r\n          billing_city = v_data->>'cidade',\r\n          billing_state = v_data->>'estado',\r\n          billing_phone = p_whatsapp_id,\r\n          subscription_flow_step = 'concluido',\r\n          updated_at = NOW()\r\n        WHERE id = v_client.id;\r\n        \r\n        v_billing := v_data;\r\n      ELSE\r\n        UPDATE saas_clients\r\n        SET subscription_flow_step = 'concluido', updated_at = NOW()\r\n        WHERE id = v_client.id;\r\n        \r\n        v_billing := jsonb_build_object(\r\n          'nome', v_client.billing_name,\r\n          'cpf', v_client.billing_cpf_cnpj,\r\n          'email', v_client.billing_email,\r\n          'cep', v_client.billing_postal_code,\r\n          'endereco', v_client.billing_address,\r\n          'numero', v_client.billing_address_number,\r\n          'bairro', v_client.billing_neighborhood,\r\n          'cidade', v_client.billing_city,\r\n          'estado', v_client.billing_state\r\n        );\r\n      END IF;\r\n      \r\n      RETURN json_build_object(\r\n        'status', 'concluido',\r\n        'msg', '‚úÖ Perfeito! Gerando seu link de pagamento...',\r\n        'plano', json_build_object(\r\n          'id', v_plano.id,\r\n          'nome', v_plano.name,\r\n          'preco', v_plano.price_monthly\r\n        ),\r\n        'billing', v_billing,\r\n        'client_id', v_client.id,\r\n        'asaas_customer_id', v_client.asaas_customer_id,\r\n        'asaas_subscription_id', v_client.asaas_subscription_id,\r\n        'plano_atual', v_client.plan\r\n      );\r\n    \r\n    ELSE\r\n      RETURN json_build_object(\r\n        'status', 'erro',\r\n        'msg', 'Etapa desconhecida. Digite #cancelar para reiniciar.'\r\n      );\r\n  END CASE;\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "recalcular_saldo_cliente",
    "function_code": "\r\nDECLARE\r\n  v_receitas NUMERIC;\r\n  v_despesas NUMERIC;\r\n  v_saldo NUMERIC;\r\nBEGIN\r\n  -- Soma tudo desde o in√≠cio\r\n  SELECT \r\n    COALESCE(SUM(amount) FILTER (WHERE type = 'income'), 0),\r\n    COALESCE(SUM(amount) FILTER (WHERE type = 'expense'), 0)\r\n  INTO v_receitas, v_despesas\r\n  FROM saas_finance_transactions\r\n  WHERE client_id = p_client_id;\r\n  \r\n  v_saldo := v_receitas - v_despesas;\r\n  \r\n  -- Atualiza cache\r\n  UPDATE saas_clients\r\n  SET \r\n    current_balance = v_saldo,\r\n    balance_updated_at = NOW()\r\n  WHERE id = p_client_id;\r\n  \r\n  RETURN v_saldo;\r\nEND;\r\n"
  },
  {
    "function_name": "register_portal_session",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\n    v_session_id UUID;\r\nBEGIN\r\n    v_client_id := get_current_client_id();\r\n    \r\n    IF v_client_id IS NULL THEN\r\n        RAISE EXCEPTION 'Usu√°rio n√£o autenticado ou cliente n√£o encontrado';\r\n    END IF;\r\n    \r\n    -- Cria nova sess√£o\r\n    INSERT INTO saas_client_sessions (\r\n        client_id,\r\n        auth_user_id,\r\n        device_info,\r\n        user_agent,\r\n        ip_address\r\n    ) VALUES (\r\n        v_client_id,\r\n        auth.uid(),\r\n        p_device_info,\r\n        p_user_agent,\r\n        p_ip_address\r\n    )\r\n    RETURNING id INTO v_session_id;\r\n    \r\n    -- Log\r\n    INSERT INTO saas_activity_log (client_id, action, details, source, ip_address, user_agent)\r\n    VALUES (\r\n        v_client_id,\r\n        'login',\r\n        jsonb_build_object('session_id', v_session_id, 'device_info', p_device_info),\r\n        'portal',\r\n        p_ip_address,\r\n        p_user_agent\r\n    );\r\n    \r\n    RETURN v_session_id;\r\nEND;\r\n"
  },
  {
    "function_name": "registrar_preferencia_categoria",
    "function_code": "\r\nBEGIN\r\n  INSERT INTO saas_client_category_preferences (client_id, descricao_original, categoria_escolhida, tipo)\r\n  VALUES (p_client_id, LOWER(TRIM(p_descricao)), p_categoria, p_tipo)\r\n  ON CONFLICT (client_id, descricao_original) DO UPDATE\r\n  SET \r\n    categoria_escolhida = EXCLUDED.categoria_escolhida,\r\n    frequencia = saas_client_category_preferences.frequencia + 1,\r\n    ultima_vez = NOW();\r\nEND;\r\n"
  },
  {
    "function_name": "relatorio_lembretes_rpc",
    "function_code": "\r\nDECLARE\r\n  v_total INT;\r\n  v_ativos INT;\r\n  v_concluidos INT;\r\n  v_cancelados INT;\r\n  v_alta INT;\r\n  v_media INT;\r\n  v_baixa INT;\r\n  v_taxa_conclusao NUMERIC;\r\n  v_lembretes JSON;\r\nBEGIN\r\n\r\n  -- ========================================\r\n  -- CONTAGEM TOTAL\r\n  -- ========================================\r\n  SELECT COUNT(*) INTO v_total\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim;\r\n\r\n  IF v_total = 0 THEN\r\n    RETURN json_build_object(\r\n      'status', 'vazio',\r\n      'mensagem', 'Nenhum lembrete encontrado no per√≠odo de ' || \r\n                  TO_CHAR(p_data_inicio, 'DD/MM/YYYY') || ' a ' || \r\n                  TO_CHAR(p_data_fim, 'DD/MM/YYYY') || '.',\r\n      'periodo', json_build_object(\r\n        'inicio', TO_CHAR(p_data_inicio, 'DD/MM/YYYY'),\r\n        'fim', TO_CHAR(p_data_fim, 'DD/MM/YYYY')\r\n      ),\r\n      'total', 0\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- CONTAGEM POR STATUS\r\n  -- ========================================\r\n  SELECT COUNT(*) INTO v_ativos\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim\r\n    AND status = 'ativo';\r\n\r\n  SELECT COUNT(*) INTO v_concluidos\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim\r\n    AND status = 'concluido';\r\n\r\n  SELECT COUNT(*) INTO v_cancelados\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim\r\n    AND status = 'cancelado';\r\n\r\n  -- ========================================\r\n  -- CONTAGEM POR PRIORIDADE\r\n  -- ========================================\r\n  SELECT COUNT(*) INTO v_alta\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim\r\n    AND prioridade = 'alta';\r\n\r\n  SELECT COUNT(*) INTO v_media\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim\r\n    AND prioridade = 'media';\r\n\r\n  SELECT COUNT(*) INTO v_baixa\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim\r\n    AND prioridade = 'baixa';\r\n\r\n  -- ========================================\r\n  -- TAXA DE CONCLUS√ÉO\r\n  -- ========================================\r\n  IF v_total > 0 THEN\r\n    v_taxa_conclusao := ROUND((v_concluidos::NUMERIC / v_total::NUMERIC) * 100, 1);\r\n  ELSE\r\n    v_taxa_conclusao := 0;\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- LISTA DE LEMBRETES DO PER√çODO\r\n  -- ========================================\r\n  SELECT json_agg(\r\n    json_build_object(\r\n      'id', id,\r\n      'titulo', titulo,\r\n      'data', TO_CHAR(data_lembrete, 'DD/MM'),\r\n      'hora', TO_CHAR(hora_lembrete, 'HH24:MI'),\r\n      'prioridade', prioridade,\r\n      'status', status\r\n    ) ORDER BY data_lembrete, hora_lembrete\r\n  )\r\n  INTO v_lembretes\r\n  FROM zero_lembretes_thiago\r\n  WHERE user_id = p_user_id\r\n    AND DATE(criado_em) BETWEEN p_data_inicio AND p_data_fim;\r\n\r\n  -- ========================================\r\n  -- RETORNO COMPLETO\r\n  -- ========================================\r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'periodo', json_build_object(\r\n      'inicio', TO_CHAR(p_data_inicio, 'DD/MM/YYYY'),\r\n      'fim', TO_CHAR(p_data_fim, 'DD/MM/YYYY')\r\n    ),\r\n    'estatisticas', json_build_object(\r\n      'total', v_total,\r\n      'por_status', json_build_object(\r\n        'ativos', COALESCE(v_ativos, 0),\r\n        'concluidos', COALESCE(v_concluidos, 0),\r\n        'cancelados', COALESCE(v_cancelados, 0)\r\n      ),\r\n      'por_prioridade', json_build_object(\r\n        'alta', COALESCE(v_alta, 0),\r\n        'media', COALESCE(v_media, 0),\r\n        'baixa', COALESCE(v_baixa, 0)\r\n      ),\r\n      'taxa_conclusao', v_taxa_conclusao\r\n    ),\r\n    'lembretes', COALESCE(v_lembretes, '[]'::JSON)\r\n  );\r\n\r\nEND;\r\n"
  },
  {
    "function_name": "resetar_contadores_mensais",
    "function_code": "\r\nDECLARE\r\n  v_count INTEGER;\r\nBEGIN\r\n  -- Reseta contadores mensais de TODOS os clientes\r\n  UPDATE saas_clients\r\n  SET \r\n    transactions_month = 0,\r\n    rag_queries_month = 0,\r\n    web_searches_month = 0,\r\n    transactions_month_reset = CURRENT_DATE\r\n  WHERE transactions_month_reset < DATE_TRUNC('month', CURRENT_DATE)::date;\r\n  \r\n  GET DIAGNOSTICS v_count = ROW_COUNT;\r\n  \r\n  RETURN QUERY SELECT v_count, CURRENT_DATE;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_adiar_lembrete",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_client_record RECORD;\r\n  v_lembrete_record RECORD;\r\n  v_novo_remind_at timestamptz;\r\nBEGIN\r\n  -- ===========================================\r\n  -- 1. IDENTIFICA O CLIENTE\r\n  -- ===========================================\r\n  SELECT * INTO v_client_record \r\n  FROM saas_clients \r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF v_client_record IS NULL THEN \r\n    RETURN json_build_object(\r\n      'status', 'erro', \r\n      'msg', 'Cliente n√£o encontrado'\r\n    );\r\n  END IF;\r\n  v_client_id := v_client_record.id;\r\n\r\n  -- ===========================================\r\n  -- 2. BUSCA O LEMBRETE\r\n  -- Se p_lembrete_id for NULL, 0 ou negativo:\r\n  --   ‚Üí Busca automaticamente o √öLTIMO com status='sent'\r\n  -- Se p_lembrete_id for v√°lido:\r\n  --   ‚Üí Busca pelo ID espec√≠fico\r\n  -- ===========================================\r\n  IF p_lembrete_id IS NULL OR p_lembrete_id <= 0 THEN\r\n    -- Busca autom√°tica: √∫ltimo lembrete enviado\r\n    SELECT * INTO v_lembrete_record\r\n    FROM saas_reminders\r\n    WHERE client_id = v_client_id \r\n      AND status = 'sent'\r\n    ORDER BY remind_at DESC\r\n    LIMIT 1;\r\n  ELSE\r\n    -- Busca espec√≠fica pelo ID\r\n    SELECT * INTO v_lembrete_record\r\n    FROM saas_reminders\r\n    WHERE id = p_lembrete_id \r\n      AND client_id = v_client_id \r\n      AND status IN ('pending', 'sent');\r\n  END IF;\r\n  \r\n  -- Verifica se encontrou\r\n  IF v_lembrete_record IS NULL THEN\r\n    RETURN json_build_object(\r\n      'status', 'erro', \r\n      'msg', 'Nenhum lembrete recente encontrado para adiar. Use a edi√ß√£o para alterar lembretes futuros.'\r\n    );\r\n  END IF;\r\n  \r\n  -- ===========================================\r\n  -- 3. VERIFICA LIMITE DE SNOOZES (m√°ximo 3)\r\n  -- ===========================================\r\n  IF v_lembrete_record.snooze_count >= 3 THEN\r\n    RETURN json_build_object(\r\n      'status', 'erro', \r\n      'msg', 'Limite de adiamentos atingido (m√°ximo 3 vezes por lembrete)'\r\n    );\r\n  END IF;\r\n  \r\n  -- ===========================================\r\n  -- 4. CALCULA NOVO HOR√ÅRIO\r\n  -- Sempre a partir de AGORA + minutos\r\n  -- ===========================================\r\n  v_novo_remind_at := NOW() + (p_minutos || ' minutes')::interval;\r\n  \r\n  -- ===========================================\r\n  -- 5. VALIDA√á√ÉO: n√£o adiar mais de 24h do original\r\n  -- ===========================================\r\n  IF v_novo_remind_at > v_lembrete_record.remind_at + INTERVAL '24 hours' THEN\r\n    RETURN json_build_object(\r\n      'status', 'erro', \r\n      'msg', 'N√£o √© poss√≠vel adiar por mais de 24h do hor√°rio original'\r\n    );\r\n  END IF;\r\n  \r\n  -- ===========================================\r\n  -- 6. ATUALIZA O LEMBRETE\r\n  -- - Novo hor√°rio\r\n  -- - Volta status para 'pending'\r\n  -- - Incrementa contador de snooze\r\n  -- ===========================================\r\n  UPDATE saas_reminders\r\n  SET remind_at = v_novo_remind_at,\r\n      status = 'pending',\r\n      snooze_count = snooze_count + 1\r\n  WHERE id = v_lembrete_record.id;\r\n  \r\n  -- ===========================================\r\n  -- 7. RETORNA SUCESSO\r\n  -- ===========================================\r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'msg', 'Lembrete adiado com sucesso!',\r\n    'dados', json_build_object(\r\n      'lembrete_id', v_lembrete_record.id,\r\n      'titulo', v_lembrete_record.title,\r\n      'novo_horario', TO_CHAR(v_novo_remind_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'nova_data', TO_CHAR(v_novo_remind_at AT TIME ZONE v_client_record.timezone, 'DD/MM/YYYY'),\r\n      'snoozes_usados', v_lembrete_record.snooze_count + 1,\r\n      'snoozes_restantes', 3 - (v_lembrete_record.snooze_count + 1)\r\n    )\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "saas_agenda",
    "function_code": "\r\nDECLARE\r\n  v_client_id UUID;\r\n  v_client_record RECORD;\r\n  v_start_at TIMESTAMPTZ;\r\n  v_end_at TIMESTAMPTZ;\r\n  v_appointment_record RECORD;\r\n  v_conflito_agenda JSON;\r\n  v_conflito_lembretes JSON;\r\n  v_compromissos_hoje JSON;\r\n  v_compromissos_amanha JSON;\r\n  v_compromissos_semana JSON;\r\nBEGIN\r\n  -- 1. Identifica Cliente\r\n  SELECT * INTO v_client_record FROM saas_clients WHERE whatsapp_id = p_whatsapp_id;\r\n  IF v_client_record IS NULL THEN \r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  v_client_id := v_client_record.id;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: CRIAR\r\n  -- ============================================\r\n  IF p_acao = 'criar' THEN\r\n    -- Valida√ß√µes\r\n    IF p_titulo IS NULL OR p_titulo = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'T√≠tulo √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    IF p_data_inicio IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Data de in√≠cio √© obrigat√≥ria');\r\n    END IF;\r\n    \r\n    -- Monta timestamps\r\n    v_start_at := (p_data_inicio || ' ' || p_hora_inicio)::timestamp AT TIME ZONE v_client_record.timezone;\r\n    \r\n    -- Se n√£o informou hora de fim, assume 1 hora depois\r\n    IF p_hora_fim IS NULL THEN\r\n      v_end_at := v_start_at + INTERVAL '1 hour';\r\n    ELSE\r\n      IF p_data_fim IS NULL THEN\r\n        v_end_at := (p_data_inicio || ' ' || p_hora_fim)::timestamp AT TIME ZONE v_client_record.timezone;\r\n      ELSE\r\n        v_end_at := (p_data_fim || ' ' || p_hora_fim)::timestamp AT TIME ZONE v_client_record.timezone;\r\n      END IF;\r\n    END IF;\r\n    \r\n    -- Valida√ß√£o: N√£o pode criar no passado\r\n    IF v_start_at < NOW() - INTERVAL '5 minutes' THEN\r\n      RETURN json_build_object(\r\n        'status', 'erro', \r\n        'msg', 'N√£o √© poss√≠vel criar compromissos para datas no passado.'\r\n      );\r\n    END IF;\r\n    \r\n    -- Valida√ß√£o: Fim deve ser ap√≥s in√≠cio\r\n    IF v_end_at <= v_start_at THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Hor√°rio de t√©rmino deve ser ap√≥s o in√≠cio');\r\n    END IF;\r\n    \r\n    -- Verifica conflito com OUTROS COMPROMISSOS (bloqueia)\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'inicio', TO_CHAR(start_at AT TIME ZONE v_client_record.timezone, 'DD/MM HH24:MI'),\r\n      'fim', TO_CHAR(end_at AT TIME ZONE v_client_record.timezone, 'HH24:MI')\r\n    ))\r\n    INTO v_conflito_agenda\r\n    FROM saas_appointments\r\n    WHERE client_id = v_client_id\r\n    AND status = 'scheduled'\r\n    AND start_at < v_end_at \r\n    AND end_at > v_start_at;\r\n    \r\n    IF v_conflito_agenda IS NOT NULL THEN\r\n      RETURN json_build_object(\r\n        'status', 'conflito',\r\n        'msg', 'J√° existe um compromisso nesse hor√°rio!',\r\n        'tipo_conflito', 'compromisso',\r\n        'conflitos', v_conflito_agenda\r\n      );\r\n    END IF;\r\n    \r\n    -- Verifica conflito com LEMBRETES (avisa, mas permite)\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'hora', TO_CHAR(remind_at AT TIME ZONE v_client_record.timezone, 'HH24:MI')\r\n    ))\r\n    INTO v_conflito_lembretes\r\n    FROM saas_reminders\r\n    WHERE client_id = v_client_id\r\n    AND status = 'pending'\r\n    AND remind_at >= v_start_at \r\n    AND remind_at <= v_end_at;\r\n    \r\n    -- Cria o compromisso\r\n    INSERT INTO saas_appointments (\r\n      client_id, title, description, location, \r\n      start_at, end_at, all_day, notify_before, priority\r\n    )\r\n    VALUES (\r\n      v_client_id, p_titulo, p_descricao, p_local,\r\n      v_start_at, v_end_at, p_dia_inteiro, p_notificar_antes, p_prioridade\r\n    )\r\n    RETURNING * INTO v_appointment_record;\r\n    \r\n    -- Retorna com ou sem aviso de lembretes\r\n    IF v_conflito_lembretes IS NOT NULL THEN\r\n      RETURN json_build_object(\r\n        'status', 'sucesso_com_aviso',\r\n        'msg', 'Compromisso criado! Aten√ß√£o: h√° lembretes nesse hor√°rio.',\r\n        'lembretes_conflito', v_conflito_lembretes,\r\n        'dados', json_build_object(\r\n          'id', v_appointment_record.id,\r\n          'titulo', v_appointment_record.title,\r\n          'data', TO_CHAR(v_appointment_record.start_at AT TIME ZONE v_client_record.timezone, 'DD/MM/YYYY'),\r\n          'inicio', TO_CHAR(v_appointment_record.start_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n          'fim', TO_CHAR(v_appointment_record.end_at AT TIME ZONE v_client_record.timezone, 'HH24:MI')\r\n        )\r\n      );\r\n    ELSE\r\n      RETURN json_build_object(\r\n        'status', 'sucesso',\r\n        'msg', 'Compromisso criado!',\r\n        'dados', json_build_object(\r\n          'id', v_appointment_record.id,\r\n          'titulo', v_appointment_record.title,\r\n          'data', TO_CHAR(v_appointment_record.start_at AT TIME ZONE v_client_record.timezone, 'DD/MM/YYYY'),\r\n          'inicio', TO_CHAR(v_appointment_record.start_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n          'fim', TO_CHAR(v_appointment_record.end_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n          'local', v_appointment_record.location\r\n        )\r\n      );\r\n    END IF;\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: LISTAR\r\n  -- ============================================\r\n  IF p_acao = 'listar' THEN\r\n    -- Compromissos de hoje\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'descricao', description,\r\n      'local', location,\r\n      'inicio', TO_CHAR(start_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'fim', TO_CHAR(end_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'prioridade', priority\r\n    ) ORDER BY start_at)\r\n    INTO v_compromissos_hoje\r\n    FROM saas_appointments\r\n    WHERE client_id = v_client_id \r\n    AND status = 'scheduled' \r\n    AND (start_at AT TIME ZONE v_client_record.timezone)::date = CURRENT_DATE;\r\n    \r\n    -- Compromissos de amanh√£\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'inicio', TO_CHAR(start_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'fim', TO_CHAR(end_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'local', location\r\n    ) ORDER BY start_at)\r\n    INTO v_compromissos_amanha\r\n    FROM saas_appointments\r\n    WHERE client_id = v_client_id \r\n    AND status = 'scheduled' \r\n    AND (start_at AT TIME ZONE v_client_record.timezone)::date = CURRENT_DATE + 1;\r\n    \r\n    -- Pr√≥ximos 7 dias\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'data', TO_CHAR(start_at AT TIME ZONE v_client_record.timezone, 'DD/MM'),\r\n      'inicio', TO_CHAR(start_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'fim', TO_CHAR(end_at AT TIME ZONE v_client_record.timezone, 'HH24:MI')\r\n    ) ORDER BY start_at)\r\n    INTO v_compromissos_semana\r\n    FROM saas_appointments\r\n    WHERE client_id = v_client_id \r\n    AND status = 'scheduled' \r\n    AND (start_at AT TIME ZONE v_client_record.timezone)::date > CURRENT_DATE + 1\r\n    AND (start_at AT TIME ZONE v_client_record.timezone)::date <= CURRENT_DATE + 7;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'dados', json_build_object(\r\n        'hoje', COALESCE(v_compromissos_hoje, '[]'::json),\r\n        'amanha', COALESCE(v_compromissos_amanha, '[]'::json),\r\n        'semana', COALESCE(v_compromissos_semana, '[]'::json)\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: EDITAR\r\n  -- ============================================\r\n  IF p_acao = 'editar' THEN\r\n    IF p_compromisso_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID do compromisso √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    -- Monta novo timestamp se data foi fornecida\r\n    IF p_data_inicio IS NOT NULL THEN\r\n      v_start_at := (p_data_inicio || ' ' || COALESCE(p_hora_inicio, '09:00'))::timestamp AT TIME ZONE v_client_record.timezone;\r\n      \r\n      IF p_hora_fim IS NOT NULL THEN\r\n        v_end_at := (COALESCE(p_data_fim, p_data_inicio) || ' ' || p_hora_fim)::timestamp AT TIME ZONE v_client_record.timezone;\r\n      ELSE\r\n        v_end_at := v_start_at + INTERVAL '1 hour';\r\n      END IF;\r\n      \r\n      -- Valida√ß√£o: N√£o pode editar para passado\r\n      IF v_start_at < NOW() - INTERVAL '5 minutes' THEN\r\n        RETURN json_build_object('status', 'erro', 'msg', 'N√£o √© poss√≠vel alterar para uma data no passado.');\r\n      END IF;\r\n      \r\n      -- Verifica conflito (excluindo o pr√≥prio compromisso)\r\n      SELECT json_agg(json_build_object('id', id, 'titulo', title))\r\n      INTO v_conflito_agenda\r\n      FROM saas_appointments\r\n      WHERE client_id = v_client_id\r\n      AND id != p_compromisso_id\r\n      AND status = 'scheduled'\r\n      AND start_at < v_end_at \r\n      AND end_at > v_start_at;\r\n      \r\n      IF v_conflito_agenda IS NOT NULL THEN\r\n        RETURN json_build_object(\r\n          'status', 'conflito',\r\n          'msg', 'J√° existe um compromisso nesse hor√°rio!',\r\n          'conflitos', v_conflito_agenda\r\n        );\r\n      END IF;\r\n    END IF;\r\n    \r\n    UPDATE saas_appointments \r\n    SET \r\n      title = COALESCE(NULLIF(p_titulo, ''), title),\r\n      description = COALESCE(NULLIF(p_descricao, ''), description),\r\n      location = COALESCE(NULLIF(p_local, ''), location),\r\n      start_at = COALESCE(v_start_at, start_at),\r\n      end_at = COALESCE(v_end_at, end_at),\r\n      notify_before = COALESCE(p_notificar_antes, notify_before),\r\n      priority = COALESCE(NULLIF(p_prioridade, 'media'), priority)\r\n    WHERE id = p_compromisso_id AND client_id = v_client_id AND status = 'scheduled'\r\n    RETURNING * INTO v_appointment_record;\r\n    \r\n    IF v_appointment_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Compromisso n√£o encontrado ou j√° processado');\r\n    END IF;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', 'Compromisso atualizado!',\r\n      'dados', json_build_object(\r\n        'id', v_appointment_record.id,\r\n        'titulo', v_appointment_record.title,\r\n        'data', TO_CHAR(v_appointment_record.start_at AT TIME ZONE v_client_record.timezone, 'DD/MM/YYYY'),\r\n        'inicio', TO_CHAR(v_appointment_record.start_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n        'fim', TO_CHAR(v_appointment_record.end_at AT TIME ZONE v_client_record.timezone, 'HH24:MI')\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: CONCLUIR\r\n  -- ============================================\r\n  IF p_acao = 'concluir' THEN\r\n    IF p_compromisso_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID do compromisso √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    UPDATE saas_appointments \r\n    SET status = 'completed', completed_at = NOW()\r\n    WHERE id = p_compromisso_id AND client_id = v_client_id AND status = 'scheduled'\r\n    RETURNING * INTO v_appointment_record;\r\n    \r\n    IF v_appointment_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Compromisso n√£o encontrado ou j√° conclu√≠do');\r\n    END IF;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', 'Compromisso conclu√≠do! üéâ',\r\n      'dados', json_build_object('titulo', v_appointment_record.title)\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: CANCELAR\r\n  -- ============================================\r\n  IF p_acao = 'cancelar' THEN\r\n    IF p_compromisso_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID do compromisso √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    UPDATE saas_appointments \r\n    SET status = 'cancelled', cancelled_at = NOW()\r\n    WHERE id = p_compromisso_id AND client_id = v_client_id AND status = 'scheduled'\r\n    RETURNING * INTO v_appointment_record;\r\n    \r\n    IF v_appointment_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Compromisso n√£o encontrado ou j√° processado');\r\n    END IF;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', 'Compromisso cancelado!',\r\n      'dados', json_build_object('titulo', v_appointment_record.title)\r\n    );\r\n  END IF;\r\n\r\n  RETURN json_build_object('status', 'erro', 'msg', 'A√ß√£o inv√°lida. Use: criar, listar, editar, concluir, cancelar');\r\nEND;\r\n"
  },
  {
    "function_name": "saas_agenda_dia",
    "function_code": "\r\nDECLARE\r\n  v_client_record RECORD;\r\n  v_compromissos JSON;\r\n  v_lembretes JSON;\r\nBEGIN\r\n  SELECT * INTO v_client_record FROM saas_clients WHERE id = p_client_id;\r\n  \r\n  -- Compromissos do dia\r\n  SELECT json_agg(json_build_object(\r\n    'id', id,\r\n    'type', 'appointment',\r\n    'title', title,\r\n    'description', description,\r\n    'location', location,\r\n    'start', start_at,\r\n    'end', end_at,\r\n    'priority', priority,\r\n    'status', status,\r\n    'color', color\r\n  ) ORDER BY start_at)\r\n  INTO v_compromissos\r\n  FROM saas_appointments\r\n  WHERE client_id = p_client_id\r\n  AND (start_at AT TIME ZONE v_client_record.timezone)::date = p_data;\r\n  \r\n  -- Lembretes do dia\r\n  SELECT json_agg(json_build_object(\r\n    'id', id,\r\n    'type', 'reminder',\r\n    'title', title,\r\n    'description', description,\r\n    'start', remind_at,\r\n    'end', remind_at + INTERVAL '15 minutes',\r\n    'priority', priority,\r\n    'status', status,\r\n    'color', '#F59E0B'\r\n  ) ORDER BY remind_at)\r\n  INTO v_lembretes\r\n  FROM saas_reminders\r\n  WHERE client_id = p_client_id\r\n  AND (remind_at AT TIME ZONE v_client_record.timezone)::date = p_data;\r\n  \r\n  RETURN json_build_object(\r\n    'data', p_data,\r\n    'compromissos', COALESCE(v_compromissos, '[]'::json),\r\n    'lembretes', COALESCE(v_lembretes, '[]'::json)\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "saas_agenda_mes",
    "function_code": "\r\nDECLARE\r\n  v_client_record RECORD;\r\n  v_inicio DATE;\r\n  v_fim DATE;\r\n  v_eventos JSON;\r\nBEGIN\r\n  SELECT * INTO v_client_record FROM saas_clients WHERE id = p_client_id;\r\n  \r\n  v_inicio := make_date(p_ano, p_mes, 1);\r\n  v_fim := (v_inicio + INTERVAL '1 month')::date - 1;\r\n  \r\n  SELECT json_agg(evento ORDER BY start_time)\r\n  INTO v_eventos\r\n  FROM (\r\n    -- Compromissos\r\n    SELECT \r\n      id,\r\n      'appointment' as type,\r\n      title,\r\n      description,\r\n      location,\r\n      start_at as start_time,\r\n      end_at as end_time,\r\n      priority,\r\n      status,\r\n      color,\r\n      (start_at AT TIME ZONE v_client_record.timezone)::date as event_date\r\n    FROM saas_appointments\r\n    WHERE client_id = p_client_id\r\n    AND (start_at AT TIME ZONE v_client_record.timezone)::date BETWEEN v_inicio AND v_fim\r\n    \r\n    UNION ALL\r\n    \r\n    -- Lembretes\r\n    SELECT \r\n      id,\r\n      'reminder' as type,\r\n      title,\r\n      description,\r\n      NULL as location,\r\n      remind_at as start_time,\r\n      remind_at + INTERVAL '15 minutes' as end_time,\r\n      priority,\r\n      status,\r\n      '#F59E0B' as color,\r\n      (remind_at AT TIME ZONE v_client_record.timezone)::date as event_date\r\n    FROM saas_reminders\r\n    WHERE client_id = p_client_id\r\n    AND (remind_at AT TIME ZONE v_client_record.timezone)::date BETWEEN v_inicio AND v_fim\r\n  ) evento;\r\n  \r\n  RETURN json_build_object(\r\n    'ano', p_ano,\r\n    'mes', p_mes,\r\n    'eventos', COALESCE(v_eventos, '[]'::json)\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "saas_buscar_compromissos_pendentes",
    "function_code": "\r\nBEGIN\r\n    RETURN QUERY\r\n    SELECT \r\n        a.id as appointment_id,\r\n        a.client_id,\r\n        c.whatsapp_id,\r\n        c.name as client_name,\r\n        c.apelido as client_apelido,\r\n        a.title as appointment_title,\r\n        a.description as appointment_description,\r\n        a.location as appointment_location,\r\n        a.start_at,\r\n        a.end_at,\r\n        a.priority::text,\r\n        a.notify_before\r\n    FROM saas_appointments a\r\n    JOIN saas_clients c ON a.client_id = c.id\r\n    WHERE \r\n        a.status = 'scheduled'\r\n        AND a.notified_at IS NULL\r\n        AND c.status = 'active'\r\n        AND a.start_at > NOW()\r\n        AND a.start_at <= NOW() + (a.notify_before || ' minutes')::interval\r\n    ORDER BY a.start_at\r\n    LIMIT 30;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_buscar_documentos_similares",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    d.id,\r\n    d.titulo,\r\n    d.categoria,\r\n    d.content as conteudo,\r\n    1 - (d.embedding <=> p_query_embedding) as similaridade,\r\n    d.metadata\r\n  FROM saas_documents d\r\n  WHERE d.client_id = p_client_id\r\n    AND d.active = true\r\n    AND (1 - (d.embedding <=> p_query_embedding)) >= p_threshold\r\n  ORDER BY d.embedding <=> p_query_embedding\r\n  LIMIT p_limite;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_buscar_documentos_similares",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    d.id,\r\n    d.titulo,\r\n    d.categoria,\r\n    d.content as conteudo,\r\n    1 - (d.embedding <=> p_query_embedding) as similaridade,\r\n    d.metadata\r\n  FROM saas_documents d\r\n  WHERE d.whatsapp_id = p_whatsapp_id\r\n    AND d.active = true\r\n    AND (1 - (d.embedding <=> p_query_embedding)) >= p_threshold\r\n  ORDER BY d.embedding <=> p_query_embedding\r\n  LIMIT p_limite;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_buscar_pendentes",
    "function_code": "\r\nDECLARE\r\n  v_result JSON;\r\nBEGIN\r\n  SELECT json_agg(row_to_json(t))\r\n  INTO v_result\r\n  FROM (\r\n    SELECT \r\n      r.id,\r\n      r.title as titulo,\r\n      r.description as descricao,\r\n      TO_CHAR(r.remind_at AT TIME ZONE c.timezone, 'HH24:MI') as hora,\r\n      r.priority as prioridade,\r\n      r.type as tipo,\r\n      c.whatsapp_id,\r\n      c.name as cliente_nome,\r\n      c.bot_name as bot_nome\r\n    FROM saas_reminders r\r\n    JOIN saas_clients c ON r.client_id = c.id\r\n    WHERE r.status = 'pending'\r\n    AND c.active = true\r\n    AND r.remind_at <= NOW()\r\n    ORDER BY r.remind_at\r\n    LIMIT 30  -- ‚úÖ Processa no m√°ximo 30 por execu√ß√£o\r\n  ) t;\r\n\r\n  IF v_result IS NULL THEN\r\n    RETURN json_build_object('status', 'vazio', 'msg', 'Sem lembretes pendentes');\r\n  END IF;\r\n\r\n  RETURN json_build_object('status', 'sucesso', 'dados', v_result);\r\nEND;\r\n"
  },
  {
    "function_name": "saas_buscar_resumo_matinal",
    "function_code": "\r\nDECLARE\r\n  v_clientes json;\r\nBEGIN\r\n  SELECT json_agg(cliente_resumo)\r\n  INTO v_clientes\r\n  FROM (\r\n    SELECT json_build_object(\r\n      'client_id', c.id,\r\n      'whatsapp_id', c.whatsapp_id,\r\n      'apelido', COALESCE(c.apelido, split_part(c.name, ' ', 1)),\r\n      'bot_nome', c.bot_name,\r\n      'timezone', c.timezone,\r\n      \r\n      -- Lembretes do dia (incluindo anivers√°rios)\r\n      'lembretes_hoje', (\r\n        SELECT COALESCE(json_agg(json_build_object(\r\n          'id', r.id,\r\n          'titulo', r.title,\r\n          'descricao', r.description,\r\n          'hora', TO_CHAR(r.remind_at AT TIME ZONE c.timezone, 'HH24:MI'),\r\n          'prioridade', r.priority,\r\n          'tipo', r.type,\r\n          'is_aniversario', (r.type = 'anual' AND (LOWER(r.title) LIKE '%anivers√°rio%' OR LOWER(r.title) LIKE '%aniversario%'))\r\n        ) ORDER BY r.remind_at), '[]'::json)\r\n        FROM saas_reminders r\r\n        WHERE r.client_id = c.id\r\n        AND r.status = 'pending'\r\n        AND (r.remind_at AT TIME ZONE c.timezone)::date = CURRENT_DATE\r\n      ),\r\n      \r\n      -- Contagem de lembretes\r\n      'total_lembretes_hoje', (\r\n        SELECT COUNT(*)\r\n        FROM saas_reminders r\r\n        WHERE r.client_id = c.id\r\n        AND r.status = 'pending'\r\n        AND (r.remind_at AT TIME ZONE c.timezone)::date = CURRENT_DATE\r\n      ),\r\n      \r\n      -- Listas com itens pendentes\r\n      'listas_pendentes', (\r\n        SELECT COALESCE(json_agg(json_build_object(\r\n          'titulo', l.title,\r\n          'total_itens', jsonb_array_length(l.items),\r\n          'pendentes', (\r\n            SELECT COUNT(*) \r\n            FROM jsonb_array_elements(l.items) AS i \r\n            WHERE (i->>'feito')::boolean = false\r\n          )\r\n        )), '[]'::json)\r\n        FROM saas_lists l\r\n        WHERE l.client_id = c.id\r\n        AND l.is_archived = false\r\n        AND EXISTS (\r\n          SELECT 1 FROM jsonb_array_elements(l.items) AS i \r\n          WHERE (i->>'feito')::boolean = false\r\n        )\r\n      ),\r\n      \r\n      -- Contagem de listas pendentes\r\n      'total_listas_pendentes', (\r\n        SELECT COUNT(*)\r\n        FROM saas_lists l\r\n        WHERE l.client_id = c.id\r\n        AND l.is_archived = false\r\n        AND EXISTS (\r\n          SELECT 1 FROM jsonb_array_elements(l.items) AS i \r\n          WHERE (i->>'feito')::boolean = false\r\n        )\r\n      )\r\n      \r\n    ) as cliente_resumo\r\n    FROM saas_clients c\r\n    WHERE c.status IN ('active', 'trial')\r\n    AND c.morning_summary_enabled = true\r\n    AND (c.morning_summary_last_sent IS NULL OR c.morning_summary_last_sent < CURRENT_DATE)\r\n    -- S√≥ clientes onde s√£o 7h no timezone deles (margem de 5 min)\r\n    AND EXTRACT(HOUR FROM NOW() AT TIME ZONE c.timezone) = 7\r\n    AND EXTRACT(MINUTE FROM NOW() AT TIME ZONE c.timezone) < 5\r\n  ) sub\r\n  WHERE cliente_resumo IS NOT NULL;\r\n  \r\n  -- Se n√£o h√° clientes para enviar\r\n  IF v_clientes IS NULL THEN\r\n    RETURN json_build_object('status', 'vazio', 'dados', '[]'::json);\r\n  END IF;\r\n  \r\n  RETURN json_build_object('status', 'sucesso', 'dados', v_clientes);\r\nEND;\r\n"
  },
  {
    "function_name": "saas_desativar_documento",
    "function_code": "\r\nDECLARE\r\n  affected integer;\r\nBEGIN\r\n  UPDATE saas_documents \r\n  SET active = false, \r\n      updated_at = NOW()\r\n  WHERE whatsapp_id = p_whatsapp_id \r\n    AND file_id = p_file_id\r\n    AND active = true;\r\n  \r\n  GET DIAGNOSTICS affected = ROW_COUNT;\r\n  RETURN affected;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_desativar_documento",
    "function_code": "\r\nDECLARE\r\n  affected integer;\r\nBEGIN\r\n  UPDATE saas_documents \r\n  SET active = false, \r\n      updated_at = NOW()\r\n  WHERE client_id = p_client_id \r\n    AND file_id = p_file_id\r\n    AND active = true;\r\n  \r\n  GET DIAGNOSTICS affected = ROW_COUNT;\r\n  RETURN affected;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_desativar_documento_por_id",
    "function_code": "\r\nDECLARE\r\n  affected integer;\r\nBEGIN\r\n  UPDATE saas_documents \r\n  SET active = false,\r\n      updated_at = NOW()\r\n  WHERE whatsapp_id = p_whatsapp_id \r\n    AND id = p_documento_id\r\n    AND active = true;\r\n  \r\n  GET DIAGNOSTICS affected = ROW_COUNT;\r\n  RETURN (affected > 0);\r\nEND;\r\n"
  },
  {
    "function_name": "saas_desativar_documento_por_id",
    "function_code": "\r\nDECLARE\r\n  affected integer;\r\nBEGIN\r\n  UPDATE saas_documents \r\n  SET active = false,\r\n      updated_at = NOW()\r\n  WHERE client_id = p_client_id \r\n    AND id = p_documento_id\r\n    AND active = true;\r\n  \r\n  GET DIAGNOSTICS affected = ROW_COUNT;\r\n  RETURN (affected > 0);\r\nEND;\r\n"
  },
  {
    "function_name": "saas_estatisticas_documentos",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    COUNT(*) as total_documentos,\r\n    jsonb_object_agg(COALESCE(categoria, 'sem_categoria'), count_cat) as total_por_categoria,\r\n    jsonb_object_agg(COALESCE(file_type, 'desconhecido'), count_type) as total_por_tipo,\r\n    MAX(created_at) as ultimo_documento\r\n  FROM (\r\n    SELECT \r\n      categoria,\r\n      file_type,\r\n      created_at,\r\n      COUNT(*) OVER (PARTITION BY categoria) as count_cat,\r\n      COUNT(*) OVER (PARTITION BY file_type) as count_type\r\n    FROM saas_documents\r\n    WHERE whatsapp_id = p_whatsapp_id AND active = true\r\n  ) stats;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_estatisticas_documentos",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    COUNT(*) as total_documentos,\r\n    jsonb_object_agg(COALESCE(categoria, 'sem_categoria'), count_cat) as total_por_categoria,\r\n    jsonb_object_agg(COALESCE(file_type, 'desconhecido'), count_type) as total_por_tipo,\r\n    MAX(created_at) as ultimo_documento\r\n  FROM (\r\n    SELECT \r\n      categoria,\r\n      file_type,\r\n      created_at,\r\n      COUNT(*) OVER (PARTITION BY categoria) as count_cat,\r\n      COUNT(*) OVER (PARTITION BY file_type) as count_type\r\n    FROM saas_documents\r\n    WHERE client_id = p_client_id AND active = true\r\n  ) stats;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_extrair_metadados",
    "function_code": "\r\nBEGIN\r\n  -- Extrair titulo\r\n  IF NEW.titulo IS NULL AND NEW.metadata->>'titulo' IS NOT NULL THEN\r\n    NEW.titulo := NEW.metadata->>'titulo';\r\n  END IF;\r\n  \r\n  -- Extrair categoria\r\n  IF NEW.categoria IS NULL OR NEW.categoria = 'geral' THEN\r\n    NEW.categoria := COALESCE(NEW.metadata->>'categoria', 'geral');\r\n  END IF;\r\n  \r\n  -- Extrair fonte\r\n  IF NEW.fonte IS NULL OR NEW.fonte = 'whatsapp' THEN\r\n    NEW.fonte := COALESCE(NEW.metadata->>'fonte', 'whatsapp');\r\n  END IF;\r\n  \r\n  -- Extrair file_id\r\n  IF NEW.file_id IS NULL THEN\r\n    NEW.file_id := NEW.metadata->>'file_id';\r\n  END IF;\r\n  \r\n  -- Extrair file_type\r\n  IF NEW.file_type IS NULL THEN\r\n    NEW.file_type := NEW.metadata->>'file_type';\r\n  END IF;\r\n  \r\n  -- Extrair autor\r\n  IF NEW.autor IS NULL THEN\r\n    NEW.autor := NEW.metadata->>'autor';\r\n  END IF;\r\n  \r\n  -- Extrair content_hash\r\n  IF NEW.content_hash IS NULL THEN\r\n    NEW.content_hash := NEW.metadata->>'content_hash';\r\n  END IF;\r\n  \r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_financeiro",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_client_record RECORD;\r\n  v_saldo numeric;\r\n  v_receitas numeric;\r\n  v_despesas numeric;\r\n  v_extrato json;\r\n  v_transaction_record RECORD;\r\nBEGIN\r\n  -- ============================================\r\n  -- 1. IDENTIFICA√á√ÉO DO CLIENTE\r\n  -- ============================================\r\n  SELECT * INTO v_client_record FROM saas_clients WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF v_client_record IS NULL THEN \r\n    RETURN json_build_object(\r\n      'status', 'erro', \r\n      'msg', 'Cliente n√£o encontrado. Verifique se voc√™ j√° est√° cadastrado.'\r\n    );\r\n  END IF;\r\n  \r\n  v_client_id := v_client_record.id;\r\n  \r\n  -- ============================================\r\n  -- 2. RESET DO CONTADOR MENSAL (se necess√°rio)\r\n  -- ============================================\r\n  -- Se o √∫ltimo reset foi em um m√™s anterior, zera o contador\r\n  IF v_client_record.transactions_month_reset < DATE_TRUNC('month', CURRENT_DATE)::date THEN\r\n    UPDATE saas_clients \r\n    SET \r\n      transactions_month = 0, \r\n      transactions_month_reset = CURRENT_DATE\r\n    WHERE id = v_client_id;\r\n    \r\n    v_client_record.transactions_month := 0;\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: REGISTRAR RECEITA\r\n  -- ============================================\r\n  IF p_acao = 'registrar_receita' THEN\r\n    -- Valida√ß√µes de entrada\r\n    IF p_descricao IS NULL OR TRIM(p_descricao) = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Descri√ß√£o √© obrigat√≥ria para registrar receita');\r\n    END IF;\r\n    \r\n    IF p_valor IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Valor √© obrigat√≥rio para registrar receita');\r\n    END IF;\r\n    \r\n    IF p_valor <= 0 THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Valor deve ser maior que zero');\r\n    END IF;\r\n    \r\n    -- Verifica limite mensal do plano\r\n    IF v_client_record.transactions_month >= v_client_record.max_transactions_month THEN\r\n      RETURN json_build_object(\r\n        'status', 'erro', \r\n        'msg', 'Limite mensal de transa√ß√µes atingido (' || v_client_record.max_transactions_month || '). Considere fazer upgrade do seu plano.'\r\n      );\r\n    END IF;\r\n    \r\n    -- Verifica√ß√£o de duplicata (janela de 5 minutos para evitar registros acidentais duplicados)\r\n    IF EXISTS (\r\n      SELECT 1 FROM saas_finance_transactions\r\n      WHERE client_id = v_client_id\r\n        AND type = 'income'\r\n        AND LOWER(TRIM(description)) = LOWER(TRIM(p_descricao))\r\n        AND amount = p_valor\r\n        AND date = COALESCE(p_data, CURRENT_DATE)\r\n        AND created_at > NOW() - INTERVAL '5 minutes'\r\n    ) THEN\r\n      RETURN json_build_object(\r\n        'status', 'aviso',\r\n        'acao', 'duplicata_detectada',\r\n        'dados', json_build_object(\r\n          'tipo', 'receita',\r\n          'descricao', p_descricao,\r\n          'valor', p_valor,\r\n          'data', TO_CHAR(COALESCE(p_data, CURRENT_DATE), 'DD/MM/YYYY')\r\n        )\r\n      );\r\n    END IF;\r\n    \r\n    -- Insere a transa√ß√£o\r\n    INSERT INTO saas_finance_transactions (\r\n      client_id, \r\n      type, \r\n      description, \r\n      amount, \r\n      category, \r\n      payment_method, \r\n      date\r\n    )\r\n    VALUES (\r\n      v_client_id, \r\n      'income', \r\n      TRIM(p_descricao), \r\n      p_valor, \r\n      p_categoria, \r\n      p_forma_pagamento, \r\n      COALESCE(p_data, CURRENT_DATE)\r\n    )\r\n    RETURNING * INTO v_transaction_record;\r\n    \r\n    -- Incrementa contador mensal\r\n    UPDATE saas_clients \r\n    SET transactions_month = transactions_month + 1 \r\n    WHERE id = v_client_id;\r\n    \r\n    -- Retorna dados estruturados (sem template de mensagem)\r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'acao', 'registrar_receita',\r\n      'dados', json_build_object(\r\n        'id', v_transaction_record.id,\r\n        'tipo', 'receita',\r\n        'valor', v_transaction_record.amount,\r\n        'descricao', v_transaction_record.description,\r\n        'categoria', v_transaction_record.category,\r\n        'forma_pagamento', v_transaction_record.payment_method,\r\n        'data', TO_CHAR(v_transaction_record.date, 'DD/MM/YYYY'),\r\n        'created_at', v_transaction_record.created_at\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: REGISTRAR DESPESA\r\n  -- ============================================\r\n  IF p_acao = 'registrar_despesa' THEN\r\n    -- Valida√ß√µes de entrada\r\n    IF p_descricao IS NULL OR TRIM(p_descricao) = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Descri√ß√£o √© obrigat√≥ria para registrar despesa');\r\n    END IF;\r\n    \r\n    IF p_valor IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Valor √© obrigat√≥rio para registrar despesa');\r\n    END IF;\r\n    \r\n    IF p_valor <= 0 THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Valor deve ser maior que zero');\r\n    END IF;\r\n    \r\n    -- Verifica limite mensal do plano\r\n    IF v_client_record.transactions_month >= v_client_record.max_transactions_month THEN\r\n      RETURN json_build_object(\r\n        'status', 'erro', \r\n        'msg', 'Limite mensal de transa√ß√µes atingido (' || v_client_record.max_transactions_month || '). Considere fazer upgrade do seu plano.'\r\n      );\r\n    END IF;\r\n    \r\n    -- Verifica√ß√£o de duplicata (janela de 5 minutos)\r\n    IF EXISTS (\r\n      SELECT 1 FROM saas_finance_transactions\r\n      WHERE client_id = v_client_id\r\n        AND type = 'expense'\r\n        AND LOWER(TRIM(description)) = LOWER(TRIM(p_descricao))\r\n        AND amount = p_valor\r\n        AND date = COALESCE(p_data, CURRENT_DATE)\r\n        AND created_at > NOW() - INTERVAL '5 minutes'\r\n    ) THEN\r\n      RETURN json_build_object(\r\n        'status', 'aviso',\r\n        'acao', 'duplicata_detectada',\r\n        'dados', json_build_object(\r\n          'tipo', 'despesa',\r\n          'descricao', p_descricao,\r\n          'valor', p_valor,\r\n          'data', TO_CHAR(COALESCE(p_data, CURRENT_DATE), 'DD/MM/YYYY')\r\n        )\r\n      );\r\n    END IF;\r\n    \r\n    -- Insere a transa√ß√£o\r\n    INSERT INTO saas_finance_transactions (\r\n      client_id, \r\n      type, \r\n      description, \r\n      amount, \r\n      category, \r\n      payment_method, \r\n      date\r\n    )\r\n    VALUES (\r\n      v_client_id, \r\n      'expense', \r\n      TRIM(p_descricao), \r\n      p_valor, \r\n      p_categoria, \r\n      p_forma_pagamento, \r\n      COALESCE(p_data, CURRENT_DATE)\r\n    )\r\n    RETURNING * INTO v_transaction_record;\r\n    \r\n    -- Incrementa contador mensal\r\n    UPDATE saas_clients \r\n    SET transactions_month = transactions_month + 1 \r\n    WHERE id = v_client_id;\r\n    \r\n    -- Retorna dados estruturados (sem template de mensagem)\r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'acao', 'registrar_despesa',\r\n      'dados', json_build_object(\r\n        'id', v_transaction_record.id,\r\n        'tipo', 'despesa',\r\n        'valor', v_transaction_record.amount,\r\n        'descricao', v_transaction_record.description,\r\n        'categoria', v_transaction_record.category,\r\n        'forma_pagamento', v_transaction_record.payment_method,\r\n        'data', TO_CHAR(v_transaction_record.date, 'DD/MM/YYYY'),\r\n        'created_at', v_transaction_record.created_at\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: EDITAR TRANSA√á√ÉO\r\n  -- ============================================\r\n  IF p_acao = 'editar_transacao' THEN\r\n    -- Valida√ß√£o: ID obrigat√≥rio\r\n    IF p_transacao_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID da transa√ß√£o √© obrigat√≥rio para editar');\r\n    END IF;\r\n    \r\n    -- Verifica se a transa√ß√£o existe e pertence ao cliente\r\n    SELECT * INTO v_transaction_record\r\n    FROM saas_finance_transactions\r\n    WHERE id = p_transacao_id AND client_id = v_client_id;\r\n    \r\n    IF v_transaction_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Transa√ß√£o n√£o encontrada ou n√£o pertence a voc√™');\r\n    END IF;\r\n    \r\n    -- Valida√ß√£o: pelo menos um campo para atualizar\r\n    IF p_descricao IS NULL AND p_valor IS NULL AND p_categoria IS NULL AND p_forma_pagamento IS NULL AND p_data IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Informe ao menos um campo para atualizar (descri√ß√£o, valor, categoria, forma de pagamento ou data)');\r\n    END IF;\r\n    \r\n    -- Valida√ß√£o: valor > 0 se informado\r\n    IF p_valor IS NOT NULL AND p_valor <= 0 THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Valor deve ser maior que zero');\r\n    END IF;\r\n    \r\n    -- Atualiza a transa√ß√£o (apenas os campos informados)\r\n    UPDATE saas_finance_transactions\r\n    SET \r\n      description = COALESCE(NULLIF(TRIM(p_descricao), ''), description),\r\n      amount = COALESCE(p_valor, amount),\r\n      category = COALESCE(NULLIF(TRIM(p_categoria), ''), category),\r\n      payment_method = COALESCE(NULLIF(TRIM(p_forma_pagamento), ''), payment_method),\r\n      date = COALESCE(p_data, date)\r\n    WHERE id = p_transacao_id AND client_id = v_client_id\r\n    RETURNING * INTO v_transaction_record;\r\n    \r\n    -- Retorna dados estruturados\r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'acao', 'editar_transacao',\r\n      'dados', json_build_object(\r\n        'id', v_transaction_record.id,\r\n        'tipo', CASE WHEN v_transaction_record.type = 'income' THEN 'receita' ELSE 'despesa' END,\r\n        'descricao', v_transaction_record.description,\r\n        'valor', v_transaction_record.amount,\r\n        'categoria', v_transaction_record.category,\r\n        'forma_pagamento', v_transaction_record.payment_method,\r\n        'data', TO_CHAR(v_transaction_record.date, 'DD/MM/YYYY')\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: EXCLUIR TRANSA√á√ÉO\r\n  -- ============================================\r\n  IF p_acao = 'excluir_transacao' THEN\r\n    -- Valida√ß√£o: ID obrigat√≥rio\r\n    IF p_transacao_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID da transa√ß√£o √© obrigat√≥rio para excluir');\r\n    END IF;\r\n    \r\n    -- Verifica se a transa√ß√£o existe e pertence ao cliente\r\n    SELECT * INTO v_transaction_record\r\n    FROM saas_finance_transactions\r\n    WHERE id = p_transacao_id AND client_id = v_client_id;\r\n    \r\n    IF v_transaction_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Transa√ß√£o n√£o encontrada ou n√£o pertence a voc√™');\r\n    END IF;\r\n    \r\n    -- Exclui a transa√ß√£o\r\n    DELETE FROM saas_finance_transactions\r\n    WHERE id = p_transacao_id AND client_id = v_client_id;\r\n    \r\n    -- Decrementa o contador mensal (se a transa√ß√£o era do m√™s atual)\r\n    IF v_transaction_record.date >= DATE_TRUNC('month', CURRENT_DATE)::date THEN\r\n      UPDATE saas_clients \r\n      SET transactions_month = GREATEST(0, transactions_month - 1) \r\n      WHERE id = v_client_id;\r\n    END IF;\r\n    \r\n    -- Retorna dados estruturados\r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'acao', 'excluir_transacao',\r\n      'dados', json_build_object(\r\n        'id', v_transaction_record.id,\r\n        'tipo', CASE WHEN v_transaction_record.type = 'income' THEN 'receita' ELSE 'despesa' END,\r\n        'descricao', v_transaction_record.description,\r\n        'valor', v_transaction_record.amount,\r\n        'data', TO_CHAR(v_transaction_record.date, 'DD/MM/YYYY')\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: RELAT√ìRIO COMPLETO\r\n  -- ============================================\r\n  IF p_acao = 'relatorio' THEN\r\n    -- Define per√≠odo padr√£o (m√™s atual se n√£o informado)\r\n    IF p_data_inicio IS NULL THEN\r\n      p_data_inicio := DATE_TRUNC('month', CURRENT_DATE)::date;\r\n    END IF;\r\n    IF p_data_fim IS NULL THEN\r\n      p_data_fim := CURRENT_DATE;\r\n    END IF;\r\n    \r\n    -- Calcula resumo do per√≠odo\r\n    SELECT \r\n      COALESCE(SUM(amount) FILTER (WHERE type = 'income'), 0),\r\n      COALESCE(SUM(amount) FILTER (WHERE type = 'expense'), 0)\r\n    INTO v_receitas, v_despesas\r\n    FROM saas_finance_transactions\r\n    WHERE client_id = v_client_id \r\n    AND date BETWEEN p_data_inicio AND p_data_fim;\r\n    \r\n    v_saldo := v_receitas - v_despesas;\r\n    \r\n    -- Busca extrato detalhado\r\n    SELECT json_agg(\r\n      json_build_object(\r\n        'id', id,\r\n        'data', TO_CHAR(date, 'DD/MM/YYYY'),\r\n        'tipo', CASE WHEN type = 'income' THEN 'receita' ELSE 'despesa' END,\r\n        'descricao', description,\r\n        'valor', amount,\r\n        'categoria', category,\r\n        'forma_pagamento', payment_method\r\n      ) ORDER BY date DESC, id DESC\r\n    )\r\n    INTO v_extrato\r\n    FROM saas_finance_transactions\r\n    WHERE client_id = v_client_id \r\n    AND date BETWEEN p_data_inicio AND p_data_fim;\r\n    \r\n    -- Retorna dados estruturados\r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'acao', 'relatorio',\r\n      'dados', json_build_object(\r\n        'periodo', json_build_object(\r\n          'inicio', TO_CHAR(p_data_inicio, 'DD/MM/YYYY'),\r\n          'fim', TO_CHAR(p_data_fim, 'DD/MM/YYYY')\r\n        ),\r\n        'resumo', json_build_object(\r\n          'receitas', v_receitas,\r\n          'despesas', v_despesas,\r\n          'saldo', v_saldo\r\n        ),\r\n        'transacoes', COALESCE(v_extrato, '[]'::json)\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: SALDO R√ÅPIDO\r\n  -- ============================================\r\n  IF p_acao = 'saldo' THEN\r\n    -- Calcula saldo do m√™s atual\r\n    SELECT \r\n      COALESCE(SUM(amount) FILTER (WHERE type = 'income'), 0),\r\n      COALESCE(SUM(amount) FILTER (WHERE type = 'expense'), 0)\r\n    INTO v_receitas, v_despesas\r\n    FROM saas_finance_transactions\r\n    WHERE client_id = v_client_id \r\n    AND date >= DATE_TRUNC('month', CURRENT_DATE)::date;\r\n    \r\n    v_saldo := v_receitas - v_despesas;\r\n    \r\n    -- Retorna dados estruturados\r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'acao', 'saldo',\r\n      'dados', json_build_object(\r\n        'receitas', v_receitas,\r\n        'despesas', v_despesas,\r\n        'saldo', v_saldo,\r\n        'mes', TO_CHAR(CURRENT_DATE, 'MM/YYYY')\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO INV√ÅLIDA\r\n  -- ============================================\r\n  RETURN json_build_object(\r\n    'status', 'erro', \r\n    'msg', 'A√ß√£o inv√°lida. A√ß√µes dispon√≠veis: registrar_receita, registrar_despesa, editar_transacao, excluir_transacao, relatorio, saldo'\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "saas_gerenciar_lista",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_lista_id uuid;\r\n  v_itens_atuais jsonb;\r\nBEGIN\r\n  SELECT id INTO v_client_id FROM saas_clients WHERE whatsapp_id = p_whatsapp_id;\r\n  IF v_client_id IS NULL THEN RETURN json_build_object('status', 'erro'); END IF;\r\n\r\n  -- Busca Lista\r\n  SELECT id, items INTO v_lista_id, v_itens_atuais\r\n  FROM saas_lists\r\n  WHERE client_id = v_client_id AND LOWER(title) = LOWER(p_titulo_lista) AND is_archived = false\r\n  LIMIT 1;\r\n\r\n  -- 1. CRIAR\r\n  IF p_acao = 'criar' THEN\r\n    IF v_lista_id IS NOT NULL THEN RETURN json_build_object('msg', 'Lista j√° existe!'); END IF;\r\n    INSERT INTO saas_lists (client_id, title) VALUES (v_client_id, p_titulo_lista);\r\n    RETURN json_build_object('status', 'sucesso', 'msg', 'Lista criada!');\r\n  END IF;\r\n\r\n  IF v_lista_id IS NULL THEN RETURN json_build_object('msg', 'Lista n√£o encontrada.'); END IF;\r\n\r\n  -- 2. ADICIONAR ITEM\r\n  IF p_acao = 'adicionar' THEN\r\n    UPDATE saas_lists \r\n    SET items = items || jsonb_build_object('texto', p_item_texto, 'feito', false), updated_at = NOW()\r\n    WHERE id = v_lista_id;\r\n    RETURN json_build_object('status', 'sucesso', 'msg', 'Item adicionado!');\r\n  END IF;\r\n\r\n  -- 3. LISTAR\r\n  IF p_acao = 'listar' THEN\r\n    RETURN json_build_object('status', 'sucesso', 'lista', p_titulo_lista, 'itens', v_itens_atuais);\r\n  END IF;\r\n\r\n  RETURN json_build_object('status', 'erro');\r\nEND;\r\n"
  },
  {
    "function_name": "saas_lembretes",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_client_record RECORD;\r\n  v_remind_at timestamptz;\r\n  v_lembrete_record RECORD;\r\n  v_lembretes_hoje json;\r\n  v_lembretes_amanha json;\r\n  v_lembretes_futuros json;\r\n  v_limite_check jsonb;\r\nBEGIN\r\n  -- 1. Identifica Cliente\r\n  SELECT * INTO v_client_record FROM saas_clients WHERE whatsapp_id = p_whatsapp_id;\r\n  IF v_client_record IS NULL THEN \r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  v_client_id := v_client_record.id;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: CRIAR\r\n  -- ============================================\r\n  IF p_acao = 'criar' THEN\r\n    -- Valida√ß√µes\r\n    IF p_titulo IS NULL OR p_titulo = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'T√≠tulo √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    IF p_data IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Data √© obrigat√≥ria');\r\n    END IF;\r\n    \r\n    -- Usa fun√ß√£o verificar_limite\r\n    SELECT verificar_limite(p_whatsapp_id, 'lembrete') INTO v_limite_check;\r\n    \r\n    IF NOT (v_limite_check->>'permitido')::boolean THEN\r\n      RETURN json_build_object(\r\n        'status', 'erro', \r\n        'msg', v_limite_check->>'motivo'\r\n      );\r\n    END IF;\r\n    \r\n    -- Monta timestamp com timezone\r\n    v_remind_at := (p_data || ' ' || p_hora)::timestamp AT TIME ZONE v_client_record.timezone;\r\n    \r\n    -- ‚úÖ VALIDA√á√ÉO: Bloqueia lembretes no passado (margem de 5 min)\r\n    IF v_remind_at < NOW() - INTERVAL '5 minutes' THEN\r\n      RETURN json_build_object(\r\n        'status', 'erro', \r\n        'msg', 'N√£o √© poss√≠vel criar lembretes para datas no passado. Por favor, escolha uma data/hora futura.'\r\n      );\r\n    END IF;\r\n    \r\n    -- Cria lembrete\r\n    INSERT INTO saas_reminders (client_id, title, description, remind_at, priority, type)\r\n    VALUES (v_client_id, p_titulo, p_descricao, v_remind_at, p_prioridade, p_tipo)\r\n    RETURNING * INTO v_lembrete_record;\r\n    \r\n    -- Usa fun√ß√£o incrementar_contador\r\n    PERFORM incrementar_contador(p_whatsapp_id, 'lembrete');\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', 'Lembrete criado!',\r\n      'dados', json_build_object(\r\n        'id', v_lembrete_record.id,\r\n        'titulo', v_lembrete_record.title,\r\n        'data', TO_CHAR(v_lembrete_record.remind_at AT TIME ZONE v_client_record.timezone, 'DD/MM/YYYY'),\r\n        'hora', TO_CHAR(v_lembrete_record.remind_at AT TIME ZONE v_client_record.timezone, 'HH24:MI')\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: EDITAR\r\n  -- ============================================\r\n  IF p_acao = 'editar' THEN\r\n    IF p_lembrete_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID do lembrete √© obrigat√≥rio para editar');\r\n    END IF;\r\n    \r\n    -- Monta novo timestamp se data foi fornecida\r\n    IF p_data IS NOT NULL THEN\r\n      v_remind_at := (p_data || ' ' || COALESCE(p_hora, '09:00'))::timestamp AT TIME ZONE v_client_record.timezone;\r\n      \r\n      -- ‚úÖ VALIDA√á√ÉO: Bloqueia edi√ß√£o para datas no passado\r\n      IF v_remind_at < NOW() - INTERVAL '5 minutes' THEN\r\n        RETURN json_build_object(\r\n          'status', 'erro', \r\n          'msg', 'N√£o √© poss√≠vel alterar para uma data no passado. Por favor, escolha uma data/hora futura.'\r\n        );\r\n      END IF;\r\n    END IF;\r\n    \r\n    UPDATE saas_reminders \r\n    SET \r\n      title = COALESCE(NULLIF(p_titulo, ''), title),\r\n      description = COALESCE(NULLIF(p_descricao, ''), description),\r\n      remind_at = COALESCE(v_remind_at, remind_at),\r\n      priority = COALESCE(NULLIF(p_prioridade, 'media'), priority),\r\n      type = COALESCE(NULLIF(p_tipo, 'unico'), type)\r\n    WHERE id = p_lembrete_id AND client_id = v_client_id AND status = 'pending'\r\n    RETURNING * INTO v_lembrete_record;\r\n    \r\n    IF v_lembrete_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lembrete n√£o encontrado ou j√° processado');\r\n    END IF;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', 'Lembrete atualizado!',\r\n      'dados', json_build_object(\r\n        'id', v_lembrete_record.id,\r\n        'titulo', v_lembrete_record.title,\r\n        'data', TO_CHAR(v_lembrete_record.remind_at AT TIME ZONE v_client_record.timezone, 'DD/MM/YYYY'),\r\n        'hora', TO_CHAR(v_lembrete_record.remind_at AT TIME ZONE v_client_record.timezone, 'HH24:MI')\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: LISTAR\r\n  -- ============================================\r\n  IF p_acao = 'listar' THEN\r\n    -- Lembretes de hoje\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'descricao', description,\r\n      'hora', TO_CHAR(remind_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'prioridade', priority\r\n    ) ORDER BY remind_at)\r\n    INTO v_lembretes_hoje\r\n    FROM saas_reminders\r\n    WHERE client_id = v_client_id \r\n    AND status = 'pending' \r\n    AND (remind_at AT TIME ZONE v_client_record.timezone)::date = CURRENT_DATE;\r\n    \r\n    -- Lembretes de amanh√£\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'descricao', description,\r\n      'hora', TO_CHAR(remind_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'prioridade', priority\r\n    ) ORDER BY remind_at)\r\n    INTO v_lembretes_amanha\r\n    FROM saas_reminders\r\n    WHERE client_id = v_client_id \r\n    AND status = 'pending' \r\n    AND (remind_at AT TIME ZONE v_client_record.timezone)::date = CURRENT_DATE + 1;\r\n    \r\n    -- Pr√≥ximos 7 dias (exceto hoje e amanh√£)\r\n    SELECT json_agg(json_build_object(\r\n      'id', id,\r\n      'titulo', title,\r\n      'data', TO_CHAR(remind_at AT TIME ZONE v_client_record.timezone, 'DD/MM'),\r\n      'hora', TO_CHAR(remind_at AT TIME ZONE v_client_record.timezone, 'HH24:MI'),\r\n      'prioridade', priority\r\n    ) ORDER BY remind_at)\r\n    INTO v_lembretes_futuros\r\n    FROM saas_reminders\r\n    WHERE client_id = v_client_id \r\n    AND status = 'pending' \r\n    AND (remind_at AT TIME ZONE v_client_record.timezone)::date > CURRENT_DATE + 1\r\n    AND (remind_at AT TIME ZONE v_client_record.timezone)::date <= CURRENT_DATE + 7;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'dados', json_build_object(\r\n        'hoje', COALESCE(v_lembretes_hoje, '[]'::json),\r\n        'amanha', COALESCE(v_lembretes_amanha, '[]'::json),\r\n        'proximos', COALESCE(v_lembretes_futuros, '[]'::json)\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: CONCLUIR\r\n  -- ============================================\r\n  IF p_acao = 'concluir' THEN\r\n    IF p_lembrete_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID do lembrete √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    UPDATE saas_reminders \r\n    SET status = 'completed', completed_at = now()\r\n    WHERE id = p_lembrete_id AND client_id = v_client_id AND status = 'pending'\r\n    RETURNING * INTO v_lembrete_record;\r\n    \r\n    IF v_lembrete_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lembrete n√£o encontrado ou j√° conclu√≠do');\r\n    END IF;\r\n    \r\n    -- Usa fun√ß√£o decrementar_contador\r\n    PERFORM decrementar_contador(p_whatsapp_id, 'lembrete');\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', 'Lembrete conclu√≠do! üéâ',\r\n      'dados', json_build_object('titulo', v_lembrete_record.title)\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: CANCELAR\r\n  -- ============================================\r\n  IF p_acao = 'cancelar' THEN\r\n    IF p_lembrete_id IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'ID do lembrete √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    UPDATE saas_reminders \r\n    SET status = 'cancelled', cancelled_at = now()\r\n    WHERE id = p_lembrete_id AND client_id = v_client_id AND status = 'pending'\r\n    RETURNING * INTO v_lembrete_record;\r\n    \r\n    IF v_lembrete_record IS NULL THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lembrete n√£o encontrado ou j√° processado');\r\n    END IF;\r\n    \r\n    -- Usa fun√ß√£o decrementar_contador\r\n    PERFORM decrementar_contador(p_whatsapp_id, 'lembrete');\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', 'Lembrete cancelado!',\r\n      'dados', json_build_object('titulo', v_lembrete_record.title)\r\n    );\r\n  END IF;\r\n\r\n  RETURN json_build_object('status', 'erro', 'msg', 'A√ß√£o inv√°lida. Use: criar, listar, editar, concluir, cancelar');\r\nEND;\r\n"
  },
  {
    "function_name": "saas_limpar_documentos_inativos",
    "function_code": "\r\nDECLARE\r\n  affected integer;\r\nBEGIN\r\n  DELETE FROM saas_documents\r\n  WHERE active = false\r\n    AND updated_at < (NOW() - (p_dias_inativo || ' days')::interval)\r\n    AND (p_client_id IS NULL OR client_id = p_client_id);\r\n  \r\n  GET DIAGNOSTICS affected = ROW_COUNT;\r\n  RETURN affected;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_limpar_documentos_inativos",
    "function_code": "\r\nDECLARE\r\n  affected integer;\r\nBEGIN\r\n  DELETE FROM saas_documents\r\n  WHERE active = false\r\n    AND updated_at < (NOW() - (p_dias_inativo || ' days')::interval)\r\n    AND (p_whatsapp_id IS NULL OR whatsapp_id = p_whatsapp_id);\r\n  \r\n  GET DIAGNOSTICS affected = ROW_COUNT;\r\n  RETURN affected;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_listar_documentos",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    d.id,\r\n    d.titulo,\r\n    d.categoria,\r\n    d.fonte,\r\n    d.file_type,\r\n    d.created_at,\r\n    LEFT(d.content, 200) as conteudo_preview\r\n  FROM saas_documents d\r\n  WHERE d.client_id = p_client_id\r\n    AND d.active = true\r\n    AND (p_categoria IS NULL OR d.categoria = p_categoria)\r\n  ORDER BY d.created_at DESC\r\n  LIMIT p_limite\r\n  OFFSET p_offset;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_listar_documentos",
    "function_code": "\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    d.id,\r\n    d.titulo,\r\n    d.categoria,\r\n    d.fonte,\r\n    d.file_type,\r\n    d.created_at,\r\n    LEFT(d.content, 200) as conteudo_preview\r\n  FROM saas_documents d\r\n  WHERE d.whatsapp_id = p_whatsapp_id\r\n    AND d.active = true\r\n    AND (p_categoria IS NULL OR d.categoria = p_categoria)\r\n  ORDER BY d.created_at DESC\r\n  LIMIT p_limite\r\n  OFFSET p_offset;\r\nEND;\r\n"
  },
  {
    "function_name": "saas_listar_lembretes",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_lembretes_hoje JSON;\r\n  v_lembretes_amanha JSON;\r\nBEGIN\r\n  -- Descobre o cliente\r\n  SELECT id INTO v_client_id FROM saas_clients WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  IF v_client_id IS NULL THEN RETURN json_build_object('erro', 'Cliente n√£o encontrado'); END IF;\r\n\r\n  -- Busca Lembretes Hoje\r\n  SELECT json_agg(json_build_object('id', id, 'titulo', title, 'hora', TO_CHAR(remind_at, 'HH24:MI'))) \r\n  INTO v_lembretes_hoje\r\n  FROM saas_reminders\r\n  WHERE client_id = v_client_id AND status = 'pending' AND remind_at::date = CURRENT_DATE;\r\n\r\n  -- Busca Lembretes Amanh√£\r\n  SELECT json_agg(json_build_object('id', id, 'titulo', title, 'hora', TO_CHAR(remind_at, 'HH24:MI'))) \r\n  INTO v_lembretes_amanha\r\n  FROM saas_reminders\r\n  WHERE client_id = v_client_id AND status = 'pending' AND remind_at::date = (CURRENT_DATE + 1);\r\n\r\n  RETURN json_build_object('hoje', COALESCE(v_lembretes_hoje, '[]'::JSON), 'amanha', COALESCE(v_lembretes_amanha, '[]'::JSON));\r\nEND;\r\n"
  },
  {
    "function_name": "saas_listas",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_client_record RECORD;\r\n  v_lista_id uuid;\r\n  v_itens_atuais jsonb;\r\n  v_total_itens int;\r\n  v_limite_check jsonb;\r\n  v_todas_listas json;\r\n  v_item text;\r\n  v_novos_itens jsonb;\r\n  v_itens_marcados int;\r\nBEGIN\r\n  -- üÜï NORMALIZA A√á√ïES (aceita varia√ß√µes)\r\n  IF p_acao = 'marcar_concluido' THEN\r\n    p_acao := 'marcar_feito';\r\n  END IF;\r\n\r\n  -- 1. Identifica Cliente\r\n  SELECT * INTO v_client_record FROM saas_clients WHERE whatsapp_id = p_whatsapp_id;\r\n  IF v_client_record IS NULL THEN \r\n    RETURN json_build_object('status', 'erro', 'msg', 'Cliente n√£o encontrado');\r\n  END IF;\r\n  v_client_id := v_client_record.id;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: CRIAR\r\n  -- ============================================\r\n  IF p_acao = 'criar' THEN\r\n    IF p_titulo_lista IS NULL OR p_titulo_lista = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'T√≠tulo da lista √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    -- Verifica se j√° existe\r\n    SELECT id INTO v_lista_id\r\n    FROM saas_lists\r\n    WHERE client_id = v_client_id \r\n      AND LOWER(title) = LOWER(p_titulo_lista) \r\n      AND is_archived = false\r\n    LIMIT 1;\r\n    \r\n    IF v_lista_id IS NOT NULL THEN \r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lista j√° existe!'); \r\n    END IF;\r\n    \r\n    -- Verifica limite\r\n    SELECT verificar_limite(p_whatsapp_id, 'lista') INTO v_limite_check;\r\n    \r\n    IF NOT (v_limite_check->>'permitido')::boolean THEN\r\n      RETURN json_build_object(\r\n        'status', 'erro', \r\n        'msg', v_limite_check->>'motivo'\r\n      );\r\n    END IF;\r\n    \r\n    -- Cria lista\r\n    INSERT INTO saas_lists (client_id, title, items)\r\n    VALUES (v_client_id, p_titulo_lista, '[]'::jsonb)\r\n    RETURNING id INTO v_lista_id;\r\n    \r\n    -- Incrementa contador\r\n    PERFORM incrementar_contador(p_whatsapp_id, 'lista');\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso', \r\n      'msg', 'Lista criada!',\r\n      'dados', json_build_object('id', v_lista_id, 'titulo', p_titulo_lista)\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: ADICIONAR ITEM (COM SPLIT!)\r\n  -- ============================================\r\n  IF p_acao = 'adicionar' THEN\r\n    IF p_item_texto IS NULL OR p_item_texto = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Texto do item √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    -- Busca lista\r\n    SELECT id, items INTO v_lista_id, v_itens_atuais\r\n    FROM saas_lists\r\n    WHERE client_id = v_client_id \r\n      AND LOWER(title) = LOWER(p_titulo_lista) \r\n      AND is_archived = false\r\n    LIMIT 1;\r\n    \r\n    IF v_lista_id IS NULL THEN \r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lista n√£o encontrada'); \r\n    END IF;\r\n    \r\n    -- SPLIT DOS ITENS (separa por v√≠rgula e trata \"e\" no final)\r\n    v_novos_itens := '[]'::jsonb;\r\n    \r\n    -- Substitui \" e \" no final por v√≠rgula (ex: \"arroz, feij√£o e farinha\")\r\n    p_item_texto := regexp_replace(p_item_texto, '\\s+e\\s+', ', ', 'gi');\r\n    \r\n    -- Loop pelos itens separados por v√≠rgula\r\n    FOR v_item IN \r\n      SELECT TRIM(unnest(string_to_array(p_item_texto, ',')))\r\n    LOOP\r\n      IF LENGTH(v_item) > 0 THEN\r\n        v_novos_itens := v_novos_itens || jsonb_build_object(\r\n          'texto', v_item,\r\n          'feito', false,\r\n          'adicionado_em', NOW()\r\n        );\r\n      END IF;\r\n    END LOOP;\r\n    \r\n    -- Adiciona todos os itens de uma vez\r\n    UPDATE saas_lists \r\n    SET \r\n      items = items || v_novos_itens,\r\n      updated_at = NOW()\r\n    WHERE id = v_lista_id\r\n    RETURNING jsonb_array_length(items) INTO v_total_itens;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso', \r\n      'msg', 'Itens adicionados!',\r\n      'dados', json_build_object(\r\n        'total_itens', v_total_itens,\r\n        'itens_adicionados', jsonb_array_length(v_novos_itens)\r\n      )\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: LISTAR\r\n  -- ============================================\r\n  IF p_acao = 'listar' THEN\r\n    -- Se tem t√≠tulo espec√≠fico, lista s√≥ essa\r\n    IF p_titulo_lista IS NOT NULL AND p_titulo_lista != '' THEN\r\n      SELECT id, items INTO v_lista_id, v_itens_atuais\r\n      FROM saas_lists\r\n      WHERE client_id = v_client_id \r\n        AND LOWER(title) = LOWER(p_titulo_lista) \r\n        AND is_archived = false\r\n      LIMIT 1;\r\n      \r\n      IF v_lista_id IS NULL THEN \r\n        RETURN json_build_object('status', 'erro', 'msg', 'Lista n√£o encontrada'); \r\n      END IF;\r\n      \r\n      RETURN json_build_object(\r\n        'status', 'sucesso', \r\n        'lista', p_titulo_lista, \r\n        'itens', v_itens_atuais\r\n      );\r\n    END IF;\r\n    \r\n    -- Lista todas\r\n    SELECT json_agg(\r\n      json_build_object(\r\n        'id', id,\r\n        'titulo', title,\r\n        'total_itens', jsonb_array_length(items),\r\n        'itens', items\r\n      ) ORDER BY created_at DESC\r\n    ) INTO v_todas_listas\r\n    FROM saas_lists\r\n    WHERE client_id = v_client_id \r\n      AND is_archived = false;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'dados', COALESCE(v_todas_listas, '[]'::json)\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: MARCAR_FEITO (üÜï CORRIGIDO - SPLIT + LISTA ATUALIZADA)\r\n  -- ============================================\r\n  IF p_acao = 'marcar_feito' THEN\r\n    IF p_item_texto IS NULL OR p_item_texto = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Texto do item √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    -- Busca lista\r\n    SELECT id, items, title INTO v_lista_id, v_itens_atuais, p_titulo_lista\r\n    FROM saas_lists\r\n    WHERE client_id = v_client_id \r\n      AND LOWER(title) = LOWER(p_titulo_lista) \r\n      AND is_archived = false\r\n    LIMIT 1;\r\n    \r\n    IF v_lista_id IS NULL THEN \r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lista n√£o encontrada'); \r\n    END IF;\r\n    \r\n    -- SPLIT DOS ITENS (marca m√∫ltiplos de uma vez)\r\n    v_itens_marcados := 0;\r\n    \r\n    -- Split por v√≠rgula e marca cada um\r\n    FOR v_item IN \r\n      SELECT TRIM(unnest(string_to_array(p_item_texto, ',')))\r\n    LOOP\r\n      IF LENGTH(v_item) > 0 THEN\r\n        -- Marca o item espec√≠fico\r\n        UPDATE saas_lists\r\n        SET \r\n          items = (\r\n            SELECT jsonb_agg(\r\n              CASE \r\n                WHEN LOWER(elem->>'texto') = LOWER(v_item)\r\n                THEN jsonb_set(elem, '{feito}', 'true'::jsonb)\r\n                ELSE elem\r\n              END\r\n            )\r\n            FROM jsonb_array_elements(items) AS elem\r\n          ),\r\n          updated_at = NOW()\r\n        WHERE id = v_lista_id;\r\n        \r\n        v_itens_marcados := v_itens_marcados + 1;\r\n      END IF;\r\n    END LOOP;\r\n    \r\n    -- Busca a lista atualizada para retornar\r\n    SELECT items INTO v_itens_atuais\r\n    FROM saas_lists\r\n    WHERE id = v_lista_id;\r\n    \r\n    -- RETORNA A LISTA COMPLETA ATUALIZADA\r\n    RETURN json_build_object(\r\n      'status', 'sucesso',\r\n      'msg', CASE \r\n        WHEN v_itens_marcados > 1 THEN v_itens_marcados || ' itens marcados como feitos! ‚úÖ'\r\n        ELSE 'Item marcado como feito! ‚úÖ'\r\n      END,\r\n      'lista', p_titulo_lista,\r\n      'itens', v_itens_atuais,\r\n      'itens_marcados', v_itens_marcados\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: REMOVER_ITEM\r\n  -- ============================================\r\n  IF p_acao = 'remover_item' THEN\r\n    IF p_item_texto IS NULL OR p_item_texto = '' THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Texto do item √© obrigat√≥rio');\r\n    END IF;\r\n    \r\n    -- Busca lista\r\n    SELECT id, items INTO v_lista_id, v_itens_atuais\r\n    FROM saas_lists\r\n    WHERE client_id = v_client_id \r\n      AND LOWER(title) = LOWER(p_titulo_lista) \r\n      AND is_archived = false\r\n    LIMIT 1;\r\n    \r\n    IF v_lista_id IS NULL THEN \r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lista n√£o encontrada'); \r\n    END IF;\r\n    \r\n    -- Remove item\r\n    UPDATE saas_lists\r\n    SET \r\n      items = (\r\n        SELECT jsonb_agg(elem)\r\n        FROM jsonb_array_elements(items) AS elem\r\n        WHERE LOWER(elem->>'texto') != LOWER(p_item_texto)\r\n      ),\r\n      updated_at = NOW()\r\n    WHERE id = v_lista_id\r\n    RETURNING jsonb_array_length(items) INTO v_total_itens;\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso', \r\n      'msg', 'Item removido!',\r\n      'dados', json_build_object('total_itens', v_total_itens)\r\n    );\r\n  END IF;\r\n\r\n  -- ============================================\r\n  -- A√á√ÉO: EXCLUIR_LISTA\r\n  -- ============================================\r\n  IF p_acao = 'excluir_lista' THEN\r\n    -- Busca lista (pode usar ID ou t√≠tulo)\r\n    IF p_list_id IS NOT NULL AND p_list_id != '' THEN\r\n      v_lista_id := p_list_id::uuid;\r\n    ELSE\r\n      SELECT id INTO v_lista_id\r\n      FROM saas_lists\r\n      WHERE client_id = v_client_id \r\n        AND LOWER(title) = LOWER(p_titulo_lista) \r\n        AND is_archived = false\r\n      LIMIT 1;\r\n    END IF;\r\n    \r\n    IF v_lista_id IS NULL THEN \r\n      RETURN json_build_object('status', 'erro', 'msg', 'Lista n√£o encontrada'); \r\n    END IF;\r\n    \r\n    -- Deleta lista\r\n    DELETE FROM saas_lists\r\n    WHERE id = v_lista_id AND client_id = v_client_id\r\n    RETURNING title INTO p_titulo_lista;\r\n    \r\n    IF NOT FOUND THEN\r\n      RETURN json_build_object('status', 'erro', 'msg', 'Erro ao excluir lista');\r\n    END IF;\r\n    \r\n    -- Decrementa contador\r\n    PERFORM decrementar_contador(p_whatsapp_id, 'lista');\r\n    \r\n    RETURN json_build_object(\r\n      'status', 'sucesso', \r\n      'msg', 'Lista \"' || p_titulo_lista || '\" exclu√≠da!',\r\n      'dados', json_build_object('titulo', p_titulo_lista)\r\n    );\r\n  END IF;\r\n\r\n  RETURN json_build_object('status', 'erro', 'msg', 'A√ß√£o inv√°lida. Use: criar, adicionar, listar, marcar_feito, remover_item, excluir_lista');\r\nEND;\r\n"
  },
  {
    "function_name": "saas_log_compromisso_enviado",
    "function_code": "\r\nDECLARE\r\n    v_client_id uuid;\r\nBEGIN\r\n    -- Busca o client_id pelo whatsapp_id\r\n    SELECT id INTO v_client_id \r\n    FROM saas_clients \r\n    WHERE whatsapp_id = p_whatsapp_id;\r\n    \r\n    -- Registra no hist√≥rico de chat\r\n    INSERT INTO saas_n8n_chat_histories (client_id, session_id, message)\r\n    VALUES (\r\n        v_client_id,\r\n        p_whatsapp_id,\r\n        jsonb_build_object(\r\n            'type', 'ai',\r\n            'content', 'üìÖ COMPROMISSO - ' || p_compromisso_titulo,\r\n            'additional_kwargs', jsonb_build_object(\r\n                'compromisso_id', p_compromisso_id,\r\n                'compromisso_titulo', p_compromisso_titulo,\r\n                'tipo', 'compromisso_notificado'\r\n            ),\r\n            'response_metadata', '{}'::jsonb\r\n        )\r\n    );\r\n    \r\n    -- Marca o compromisso como notificado\r\n    UPDATE saas_appointments \r\n    SET notified_at = NOW()\r\n    WHERE id = p_compromisso_id;\r\n    \r\nEND;\r\n"
  },
  {
    "function_name": "saas_log_lembrete_enviado",
    "function_code": "\r\nBEGIN\r\n  -- Insere o registro no hist√≥rico SEM additional_kwargs\r\n  INSERT INTO saas_n8n_chat_histories (\r\n    session_id,\r\n    message\r\n  ) VALUES (\r\n    p_session_id,\r\n    jsonb_build_object(\r\n      'type', 'ai',\r\n      'content', '‚è∞ LEMBRETE - ' || p_lembrete_titulo || ' (ID: ' || p_lembrete_id || ')'\r\n    )\r\n  );\r\n\r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'msg', 'Lembrete registrado no hist√≥rico',\r\n    'lembrete_id', p_lembrete_id\r\n  );\r\n\r\nEXCEPTION WHEN OTHERS THEN\r\n  RETURN json_build_object(\r\n    'status', 'erro',\r\n    'msg', SQLERRM\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "saas_marcar_resumo_enviado",
    "function_code": "\r\nBEGIN\r\n  UPDATE saas_clients \r\n  SET morning_summary_last_sent = CURRENT_DATE\r\n  WHERE id = p_client_id;\r\n  \r\n  RETURN json_build_object('status', 'sucesso');\r\nEND;\r\n"
  },
  {
    "function_name": "saas_onboarding",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_client_record RECORD;\r\n  v_is_new boolean := false;\r\nBEGIN\r\n  -- Busca cliente existente\r\n  SELECT * INTO v_client_record \r\n  FROM saas_clients \r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  -- Se n√£o existe, cria novo\r\n  IF v_client_record IS NULL THEN\r\n    INSERT INTO saas_clients (whatsapp_id, name, first_interaction_at)\r\n    VALUES (\r\n      p_whatsapp_id,\r\n      COALESCE(p_name, 'Usu√°rio'),\r\n      now()\r\n    )\r\n    RETURNING * INTO v_client_record;\r\n    \r\n    v_is_new := true;\r\n  ELSE\r\n    -- Atualiza nome se fornecido e diferente\r\n    IF p_name IS NOT NULL AND p_name != v_client_record.name THEN\r\n      UPDATE saas_clients \r\n      SET name = p_name, updated_at = now()\r\n      WHERE id = v_client_record.id;\r\n    END IF;\r\n  END IF;\r\n  \r\n  RETURN json_build_object(\r\n    'status', 'sucesso',\r\n    'is_new', v_is_new,\r\n    'dados', json_build_object(\r\n      'id', v_client_record.id,\r\n      'name', COALESCE(p_name, v_client_record.name),\r\n      'bot_name', v_client_record.bot_name,\r\n      'bot_personality', v_client_record.bot_personality,\r\n      'custom_instructions', v_client_record.custom_instructions,\r\n      'plan', v_client_record.plan,\r\n      'status', v_client_record.status,\r\n      'onboarding_completed', v_client_record.onboarding_completed,\r\n      'response_mode', v_client_record.response_mode\r\n    )\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "saas_onboarding_flow",
    "function_code": "\r\nDECLARE\r\n  v_client_id uuid;\r\n  v_step text;\r\n  v_name text;\r\n  v_apelido text;\r\n  v_subscription_step text;\r\n  v_subscription_plan text;\r\n  v_result jsonb;\r\nBEGIN\r\n\r\n  -- Buscar cliente existente\r\n  SELECT\r\n    id,\r\n    onboarding_step,\r\n    name,\r\n    apelido,\r\n    subscription_flow_step,\r\n    subscription_flow_plan\r\n  INTO\r\n    v_client_id,\r\n    v_step,\r\n    v_name,\r\n    v_apelido,\r\n    v_subscription_step,\r\n    v_subscription_plan\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: verificar_status\r\n  -- ========================================\r\n  IF p_acao = 'verificar_status' THEN\r\n    IF v_client_id IS NULL THEN\r\n      -- Novo usu√°rio - come√ßa em 'welcome'\r\n      INSERT INTO saas_clients (whatsapp_id, name, status, plan, onboarding_step)\r\n      VALUES (p_whatsapp_id, 'Novo Usu√°rio', 'trial', 'free', 'welcome')\r\n      RETURNING id, onboarding_step INTO v_client_id, v_step;\r\n\r\n      RETURN jsonb_build_object(\r\n        'status', 'novo_usuario',\r\n        'step', 'welcome',\r\n        'client_id', v_client_id,\r\n        'msg', 'Usu√°rio criado, mostrando boas-vindas'\r\n      );\r\n    ELSE\r\n      -- Usu√°rio existente\r\n      RETURN jsonb_build_object(\r\n        'status', CASE WHEN v_step = 'completed' THEN 'ativo' ELSE 'onboarding' END,\r\n        'step', v_step,\r\n        'client_id', v_client_id,\r\n        'name', v_name,\r\n        'apelido', v_apelido,\r\n        'subscription_flow_step', v_subscription_step,\r\n        'subscription_flow_plan', v_subscription_plan,\r\n        'msg', CASE WHEN v_step = 'completed' THEN 'Usu√°rio ativo' ELSE 'Onboarding em andamento' END\r\n      );\r\n    END IF;\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: avancar_para_lgpd\r\n  -- ========================================\r\n  IF p_acao = 'avancar_para_lgpd' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    UPDATE saas_clients\r\n    SET onboarding_step = 'lgpd',\r\n        updated_at = NOW()\r\n    WHERE id = v_client_id;\r\n\r\n    RETURN jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'step', 'lgpd',\r\n      'client_id', v_client_id,\r\n      'msg', 'Avan√ßou para etapa de LGPD'\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: aceitar_lgpd\r\n  -- ========================================\r\n  IF p_acao = 'aceitar_lgpd' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    UPDATE saas_clients\r\n    SET lgpd_accepted_at = NOW(),\r\n        onboarding_step = 'name',\r\n        updated_at = NOW()\r\n    WHERE id = v_client_id;\r\n\r\n    RETURN jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'step', 'name',\r\n      'client_id', v_client_id,\r\n      'msg', 'LGPD aceita com sucesso'\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: avancar_welcome\r\n  -- ========================================\r\n  IF p_acao = 'avancar_welcome' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    UPDATE saas_clients\r\n    SET onboarding_step = 'name',\r\n        updated_at = NOW()\r\n    WHERE id = v_client_id;\r\n\r\n    RETURN jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'step', 'name',\r\n      'client_id', v_client_id,\r\n      'msg', 'Avan√ßou para etapa de nome'\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: salvar_nome\r\n  -- ========================================\r\n  IF p_acao = 'salvar_nome' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    IF p_valor IS NULL OR trim(p_valor) = '' THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Nome n√£o informado');\r\n    END IF;\r\n\r\n    UPDATE saas_clients\r\n    SET name = trim(p_valor),\r\n        onboarding_step = 'apelido',\r\n        updated_at = NOW()\r\n    WHERE id = v_client_id;\r\n\r\n    RETURN jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'step', 'apelido',\r\n      'client_id', v_client_id,\r\n      'name', trim(p_valor),\r\n      'msg', 'Nome salvo com sucesso'\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: salvar_apelido\r\n  -- ========================================\r\n  IF p_acao = 'salvar_apelido' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    -- Se n√£o informar apelido, usa primeiro nome\r\n    IF p_valor IS NULL OR trim(p_valor) = '' OR lower(trim(p_valor)) IN ('n√£o', 'nao', 'n', 'pular', 'nenhum') THEN\r\n      SELECT split_part(name, ' ', 1) INTO p_valor FROM saas_clients WHERE id = v_client_id;\r\n    END IF;\r\n\r\n    UPDATE saas_clients\r\n    SET apelido = trim(p_valor),\r\n        onboarding_step = 'cidade',\r\n        updated_at = NOW()\r\n    WHERE id = v_client_id;\r\n\r\n    RETURN jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'step', 'cidade',\r\n      'client_id', v_client_id,\r\n      'apelido', trim(p_valor),\r\n      'msg', 'Apelido salvo com sucesso'\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: salvar_cidade\r\n  -- ========================================\r\n  IF p_acao = 'salvar_cidade' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    -- Extrai cidade e UF\r\n    DECLARE\r\n      v_cidade text;\r\n      v_uf text := NULL;\r\n      v_input text := trim(p_valor);\r\n    BEGIN\r\n      -- Tenta extrair UF se tiver separador\r\n      IF v_input ~ '[-/,]\\s*[A-Za-z]{2}\\s*$' THEN\r\n        v_uf := upper(trim(substring(v_input from '[-/,]\\s*([A-Za-z]{2})\\s*$')));\r\n        v_cidade := trim(regexp_replace(v_input, '[-/,]\\s*[A-Za-z]{2}\\s*$', ''));\r\n      ELSE\r\n        v_cidade := v_input;\r\n      END IF;\r\n\r\n      -- Capitaliza a cidade\r\n      v_cidade := initcap(v_cidade);\r\n\r\n      UPDATE saas_clients\r\n      SET cidade = v_cidade,\r\n          uf = COALESCE(v_uf, uf),\r\n          onboarding_step = 'email',\r\n          updated_at = NOW()\r\n      WHERE id = v_client_id;\r\n\r\n      RETURN jsonb_build_object(\r\n        'status', 'sucesso',\r\n        'step', 'email',\r\n        'client_id', v_client_id,\r\n        'cidade', v_cidade,\r\n        'uf', v_uf,\r\n        'msg', 'Cidade salva com sucesso'\r\n      );\r\n    END;\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: salvar_email (NOVA!)\r\n  -- ========================================\r\n  IF p_acao = 'salvar_email' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    IF p_valor IS NULL OR trim(p_valor) = '' THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Email n√£o informado');\r\n    END IF;\r\n\r\n    UPDATE saas_clients\r\n    SET email = lower(trim(p_valor)),\r\n        onboarding_step = 'plans',\r\n        updated_at = NOW()\r\n    WHERE id = v_client_id;\r\n\r\n    RETURN jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'step', 'plans',\r\n      'client_id', v_client_id,\r\n      'email', lower(trim(p_valor)),\r\n      'msg', 'Email salvo com sucesso'\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: finalizar_onboarding\r\n  -- ========================================\r\n  IF p_acao = 'finalizar_onboarding' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    UPDATE saas_clients\r\n    SET onboarding_step = 'completed',\r\n        first_interaction_at = COALESCE(first_interaction_at, NOW()),\r\n        trial_ends_at = NOW() + INTERVAL '7 days',\r\n        updated_at = NOW()\r\n    WHERE id = v_client_id;\r\n\r\n    SELECT name, apelido INTO v_name, v_apelido\r\n    FROM saas_clients WHERE id = v_client_id;\r\n\r\n    RETURN jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'step', 'completed',\r\n      'client_id', v_client_id,\r\n      'name', v_name,\r\n      'apelido', v_apelido,\r\n      'trial_days', 7,\r\n      'msg', 'Onboarding finalizado com sucesso!'\r\n    );\r\n  END IF;\r\n\r\n  -- ========================================\r\n  -- A√á√ÉO: obter_dados_cliente\r\n  -- ========================================\r\n  IF p_acao = 'obter_dados_cliente' THEN\r\n    IF v_client_id IS NULL THEN\r\n      RETURN jsonb_build_object('status', 'erro', 'msg', 'Usu√°rio n√£o encontrado');\r\n    END IF;\r\n\r\n    SELECT jsonb_build_object(\r\n      'status', 'sucesso',\r\n      'client_id', id,\r\n      'name', name,\r\n      'apelido', apelido,\r\n      'whatsapp_id', whatsapp_id,\r\n      'plan', plan,\r\n      'status', status,\r\n      'timezone', timezone,\r\n      'cidade', cidade,\r\n      'uf', uf,\r\n      'bot_name', bot_name,\r\n      'bot_personality', bot_personality,\r\n      'onboarding_step', onboarding_step,\r\n      'trial_ends_at', trial_ends_at,\r\n      'max_reminders', max_reminders,\r\n      'max_lists', max_lists,\r\n      'max_transactions_month', max_transactions_month,\r\n      'subscription_flow_step', subscription_flow_step,\r\n      'subscription_flow_plan', subscription_flow_plan\r\n    ) INTO v_result\r\n    FROM saas_clients\r\n    WHERE id = v_client_id;\r\n\r\n    RETURN v_result;\r\n  END IF;\r\n\r\n  -- A√ß√£o n√£o reconhecida\r\n  RETURN jsonb_build_object(\r\n    'status', 'erro',\r\n    'msg', 'A√ß√£o n√£o reconhecida: ' || p_acao\r\n  );\r\n\r\nEND;\r\n"
  },
  {
    "function_name": "saas_verificar_documento_duplicado",
    "function_code": "\r\nBEGIN\r\n    RETURN QUERY\r\n    SELECT \r\n        d.id,\r\n        d.whatsapp_id,\r\n        d.content,\r\n        d.document_hash,\r\n        d.created_at\r\n    FROM public.saas_documents d\r\n    WHERE d.whatsapp_id = p_whatsapp_id\r\n      AND d.document_hash = p_document_hash\r\n      AND d.active = true\r\n    ORDER BY d.created_at DESC\r\n    LIMIT 1;\r\nEND;\r\n"
  },
  {
    "function_name": "saldo_rapido",
    "function_code": "\r\nDECLARE\r\n  v_ano INTEGER := EXTRACT(YEAR FROM CURRENT_DATE);\r\n  v_mes INTEGER := EXTRACT(MONTH FROM CURRENT_DATE);\r\n  v_cache RECORD;\r\nBEGIN\r\n  -- Busca saldo total (cache)\r\n  SELECT current_balance\r\n  INTO saldo_total\r\n  FROM saas_clients\r\n  WHERE id = p_client_id;\r\n  \r\n  -- Busca dados do m√™s (cache)\r\n  SELECT receitas, despesas, saldo\r\n  INTO v_cache\r\n  FROM saas_finance_monthly_cache\r\n  WHERE client_id = p_client_id\r\n    AND ano = v_ano\r\n    AND mes = v_mes;\r\n  \r\n  IF FOUND THEN\r\n    receitas_mes := v_cache.receitas;\r\n    despesas_mes := v_cache.despesas;\r\n    saldo_mes := v_cache.saldo;\r\n  ELSE\r\n    -- Se n√£o tem cache, calcula\r\n    SELECT \r\n      COALESCE(SUM(amount) FILTER (WHERE type = 'income'), 0),\r\n      COALESCE(SUM(amount) FILTER (WHERE type = 'expense'), 0)\r\n    INTO receitas_mes, despesas_mes\r\n    FROM saas_finance_transactions\r\n    WHERE client_id = p_client_id\r\n      AND date >= DATE_TRUNC('month', CURRENT_DATE)::date;\r\n    \r\n    saldo_mes := receitas_mes - despesas_mes;\r\n    \r\n    -- Cria cache\r\n    PERFORM atualizar_cache_mensal(p_client_id, v_ano, v_mes);\r\n  END IF;\r\n  \r\n  RETURN NEXT;\r\nEND;\r\n"
  },
  {
    "function_name": "search_notes",
    "function_code": "\r\nDECLARE\r\n    v_client_id UUID;\r\nBEGIN\r\n    v_client_id := get_current_client_id();\r\n    \r\n    RETURN QUERY\r\n    SELECT *\r\n    FROM saas_client_notes\r\n    WHERE client_id = v_client_id\r\n      AND is_archived = false\r\n      AND (\r\n          title ILIKE '%' || p_search || '%'\r\n          OR content ILIKE '%' || p_search || '%'\r\n      )\r\n    ORDER BY is_pinned DESC, updated_at DESC;\r\nEND;\r\n"
  },
  {
    "function_name": "set_updated_at",
    "function_code": "\r\nBEGIN\r\n  NEW.updated_at = now();\r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "sincronizar_limites_plano",
    "function_code": "\r\nBEGIN\r\n  -- Se o plano mudou, atualiza os limites\r\n  IF OLD.plan IS DISTINCT FROM NEW.plan THEN\r\n    UPDATE saas_clients c\r\n    SET \r\n      max_reminders = p.max_reminders,\r\n      max_lists = p.max_lists,\r\n      max_list_items = p.max_list_items,\r\n      max_transactions_month = p.max_transactions_month,\r\n      max_rag_queries_month = p.max_rag_queries_month,\r\n      max_documents = p.max_documents,\r\n      max_web_searches_month = p.max_web_searches_month,\r\n      updated_at = NOW()\r\n    FROM saas_plans p\r\n    WHERE c.id = NEW.id\r\n      AND p.id = NEW.plan;\r\n  END IF;\r\n  \r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "sincronizar_metadados_saas_documents",
    "function_code": "\r\nBEGIN\r\n  -- Se o n8n enviar whatsapp_id dentro do metadata, copia para a coluna f√≠sica\r\n  IF NEW.metadata ? 'whatsapp_id' THEN\r\n    NEW.whatsapp_id := NEW.metadata->>'whatsapp_id';\r\n  END IF;\r\n  -- Se o n8n enviar document_hash dentro do metadata, copia para a coluna f√≠sica\r\n  IF NEW.metadata ? 'document_hash' THEN\r\n    NEW.document_hash := NEW.metadata->>'document_hash';\r\n  END IF;\r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "sparsevec",
    "function_code": "sparsevec"
  },
  {
    "function_name": "sparsevec_cmp",
    "function_code": "sparsevec_cmp"
  },
  {
    "function_name": "sparsevec_eq",
    "function_code": "sparsevec_eq"
  },
  {
    "function_name": "sparsevec_ge",
    "function_code": "sparsevec_ge"
  },
  {
    "function_name": "sparsevec_gt",
    "function_code": "sparsevec_gt"
  },
  {
    "function_name": "sparsevec_in",
    "function_code": "sparsevec_in"
  },
  {
    "function_name": "sparsevec_l2_squared_distance",
    "function_code": "sparsevec_l2_squared_distance"
  },
  {
    "function_name": "sparsevec_le",
    "function_code": "sparsevec_le"
  },
  {
    "function_name": "sparsevec_lt",
    "function_code": "sparsevec_lt"
  },
  {
    "function_name": "sparsevec_ne",
    "function_code": "sparsevec_ne"
  },
  {
    "function_name": "sparsevec_negative_inner_product",
    "function_code": "sparsevec_negative_inner_product"
  },
  {
    "function_name": "sparsevec_out",
    "function_code": "sparsevec_out"
  },
  {
    "function_name": "sparsevec_recv",
    "function_code": "sparsevec_recv"
  },
  {
    "function_name": "sparsevec_send",
    "function_code": "sparsevec_send"
  },
  {
    "function_name": "sparsevec_to_halfvec",
    "function_code": "sparsevec_to_halfvec"
  },
  {
    "function_name": "sparsevec_to_vector",
    "function_code": "sparsevec_to_vector"
  },
  {
    "function_name": "sparsevec_typmod_in",
    "function_code": "sparsevec_typmod_in"
  },
  {
    "function_name": "subvector",
    "function_code": "halfvec_subvector"
  },
  {
    "function_name": "subvector",
    "function_code": "subvector"
  },
  {
    "function_name": "sugerir_categoria",
    "function_code": "\r\nDECLARE\r\n  v_categoria TEXT;\r\n  v_descricao_clean TEXT;\r\nBEGIN\r\n  -- Remove acentos e converte pra min√∫sculo\r\n  v_descricao_clean := LOWER(unaccent(TRIM(p_descricao)));\r\n  \r\n  -- Busca categoria por palavra-chave (sem acentos)\r\n  SELECT nome INTO v_categoria\r\n  FROM saas_finance_categories\r\n  WHERE ativa = true\r\n    AND (tipo = p_tipo OR tipo = 'ambos')\r\n    AND EXISTS (\r\n      SELECT 1 FROM unnest(palavras_chave) AS palavra\r\n      WHERE v_descricao_clean ~ ('\\y' || LOWER(unaccent(palavra)) || '\\y')\r\n    )\r\n  ORDER BY \r\n    -- Prioriza matches mais espec√≠ficos (palavras mais longas)\r\n    (SELECT LENGTH(palavra) FROM unnest(palavras_chave) AS palavra \r\n     WHERE v_descricao_clean ~ ('\\y' || LOWER(unaccent(palavra)) || '\\y')\r\n     ORDER BY LENGTH(palavra) DESC LIMIT 1) DESC,\r\n    ordem\r\n  LIMIT 1;\r\n  \r\n  -- Se n√£o encontrou, retorna \"Outros\" (CORRIGIDO)\r\n  IF v_categoria IS NULL THEN\r\n    SELECT nome INTO v_categoria\r\n    FROM saas_finance_categories\r\n    WHERE (tipo = p_tipo OR tipo = 'ambos') \r\n      AND nome ILIKE '%outros%'\r\n    ORDER BY tipo = p_tipo DESC -- Prioriza tipo exato\r\n    LIMIT 1;\r\n  END IF;\r\n  \r\n  -- Garantia final (nunca retornar NULL)\r\n  RETURN COALESCE(v_categoria, 'Outros');\r\nEND;\r\n"
  },
  {
    "function_name": "sugerir_categoria_personalizada",
    "function_code": "\r\nDECLARE\r\n  v_categoria TEXT;\r\n  v_descricao_clean TEXT;\r\nBEGIN\r\n  v_descricao_clean := LOWER(unaccent(TRIM(p_descricao)));\r\n  \r\n  -- 1. Tenta hist√≥rico exato do usu√°rio (sem acento)\r\n  SELECT categoria_escolhida INTO v_categoria\r\n  FROM saas_client_category_preferences\r\n  WHERE client_id = p_client_id\r\n    AND LOWER(unaccent(descricao_original)) = v_descricao_clean\r\n  ORDER BY ultima_vez DESC\r\n  LIMIT 1;\r\n  \r\n  IF v_categoria IS NOT NULL THEN\r\n    RETURN v_categoria || ' (baseado no seu hist√≥rico)';\r\n  END IF;\r\n  \r\n  -- 2. Tenta hist√≥rico parcial (descri√ß√µes similares, sem acento)\r\n  SELECT categoria_escolhida INTO v_categoria\r\n  FROM saas_client_category_preferences\r\n  WHERE client_id = p_client_id\r\n    AND tipo = p_tipo\r\n    AND (\r\n      v_descricao_clean LIKE '%' || LOWER(unaccent(descricao_original)) || '%' OR\r\n      LOWER(unaccent(descricao_original)) LIKE '%' || v_descricao_clean || '%'\r\n    )\r\n  ORDER BY frequencia DESC, ultima_vez DESC\r\n  LIMIT 1;\r\n  \r\n  IF v_categoria IS NOT NULL THEN\r\n    RETURN v_categoria || ' (baseado em registros similares)';\r\n  END IF;\r\n  \r\n  -- 3. Usa sugest√£o padr√£o\r\n  RETURN sugerir_categoria(p_descricao, p_tipo);\r\nEND;\r\n"
  },
  {
    "function_name": "trigger_atualizar_saldo",
    "function_code": "\r\nDECLARE\r\n  v_delta NUMERIC;\r\nBEGIN\r\n  IF TG_OP = 'INSERT' THEN\r\n    -- Adiciona ao saldo\r\n    v_delta := CASE WHEN NEW.type = 'income' THEN NEW.amount ELSE -NEW.amount END;\r\n    \r\n    UPDATE saas_clients\r\n    SET \r\n      current_balance = current_balance + v_delta,\r\n      balance_updated_at = NOW()\r\n    WHERE id = NEW.client_id;\r\n    \r\n  ELSIF TG_OP = 'UPDATE' THEN\r\n    -- Recalcula diferen√ßa\r\n    v_delta := \r\n      CASE WHEN NEW.type = 'income' THEN NEW.amount ELSE -NEW.amount END -\r\n      CASE WHEN OLD.type = 'income' THEN OLD.amount ELSE -OLD.amount END;\r\n    \r\n    UPDATE saas_clients\r\n    SET \r\n      current_balance = current_balance + v_delta,\r\n      balance_updated_at = NOW()\r\n    WHERE id = NEW.client_id;\r\n    \r\n  ELSIF TG_OP = 'DELETE' THEN\r\n    -- Remove do saldo\r\n    v_delta := CASE WHEN OLD.type = 'income' THEN -OLD.amount ELSE OLD.amount END;\r\n    \r\n    UPDATE saas_clients\r\n    SET \r\n      current_balance = current_balance + v_delta,\r\n      balance_updated_at = NOW()\r\n    WHERE id = OLD.client_id;\r\n  END IF;\r\n  \r\n  RETURN NULL;\r\nEND;\r\n"
  },
  {
    "function_name": "trigger_invalidar_cache_mensal",
    "function_code": "\r\nBEGIN\r\n  IF TG_OP = 'INSERT' THEN\r\n    PERFORM atualizar_cache_mensal(\r\n      NEW.client_id,\r\n      EXTRACT(YEAR FROM NEW.date)::INTEGER,\r\n      EXTRACT(MONTH FROM NEW.date)::INTEGER\r\n    );\r\n  ELSIF TG_OP = 'UPDATE' THEN\r\n    -- Atualiza m√™s antigo e novo (se mudou)\r\n    PERFORM atualizar_cache_mensal(\r\n      OLD.client_id,\r\n      EXTRACT(YEAR FROM OLD.date)::INTEGER,\r\n      EXTRACT(MONTH FROM OLD.date)::INTEGER\r\n    );\r\n    IF NEW.date != OLD.date THEN\r\n      PERFORM atualizar_cache_mensal(\r\n        NEW.client_id,\r\n        EXTRACT(YEAR FROM NEW.date)::INTEGER,\r\n        EXTRACT(MONTH FROM NEW.date)::INTEGER\r\n      );\r\n    END IF;\r\n  ELSIF TG_OP = 'DELETE' THEN\r\n    PERFORM atualizar_cache_mensal(\r\n      OLD.client_id,\r\n      EXTRACT(YEAR FROM OLD.date)::INTEGER,\r\n      EXTRACT(MONTH FROM OLD.date)::INTEGER\r\n    );\r\n  END IF;\r\n  \r\n  RETURN NULL;\r\nEND;\r\n"
  },
  {
    "function_name": "unaccent",
    "function_code": "unaccent_dict"
  },
  {
    "function_name": "unaccent",
    "function_code": "unaccent_dict"
  },
  {
    "function_name": "unaccent_init",
    "function_code": "unaccent_init"
  },
  {
    "function_name": "unaccent_lexize",
    "function_code": "unaccent_lexize"
  },
  {
    "function_name": "update_appointments_timestamp",
    "function_code": "\r\nBEGIN\r\n  NEW.updated_at = NOW();\r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "update_client_notes_updated_at",
    "function_code": "\r\nBEGIN\r\n    NEW.updated_at = NOW();\r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "update_client_preferences_updated_at",
    "function_code": "\r\nBEGIN\r\n    NEW.updated_at = NOW();\r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "update_saas_documents_updated_at",
    "function_code": "\r\nBEGIN\r\n  NEW.updated_at = NOW();\r\n  RETURN NEW;\r\nEND;\r\n"
  },
  {
    "function_name": "update_session_activity",
    "function_code": "\r\nBEGIN\r\n    UPDATE saas_client_sessions\r\n    SET last_active_at = NOW()\r\n    WHERE id = p_session_id\r\n      AND auth_user_id = auth.uid();\r\nEND;\r\n"
  },
  {
    "function_name": "validar_cnpj",
    "function_code": "\r\nDECLARE\r\n  v_cnpj TEXT;\r\n  v_soma INT;\r\n  v_resto INT;\r\n  v_digito1 INT;\r\n  v_digito2 INT;\r\n  v_pesos1 INT[] := ARRAY[5,4,3,2,9,8,7,6,5,4,3,2];\r\n  v_pesos2 INT[] := ARRAY[6,5,4,3,2,9,8,7,6,5,4,3,2];\r\n  i INT;\r\nBEGIN\r\n  -- Limpar para ter apenas n√∫meros\r\n  v_cnpj := REGEXP_REPLACE(p_cnpj, '[^0-9]', '', 'g');\r\n  \r\n  -- Verificar se tem 14 d√≠gitos\r\n  IF LENGTH(v_cnpj) <> 14 THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  -- Verificar se todos os d√≠gitos s√£o iguais (CNPJ inv√°lido)\r\n  IF v_cnpj ~ '^(\\d)\\1{13}$' THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  -- Calcular primeiro d√≠gito verificador\r\n  v_soma := 0;\r\n  FOR i IN 1..12 LOOP\r\n    v_soma := v_soma + (SUBSTRING(v_cnpj, i, 1)::INT * v_pesos1[i]);\r\n  END LOOP;\r\n  v_resto := v_soma % 11;\r\n  v_digito1 := CASE WHEN v_resto < 2 THEN 0 ELSE 11 - v_resto END;\r\n  \r\n  -- Verificar primeiro d√≠gito\r\n  IF SUBSTRING(v_cnpj, 13, 1)::INT <> v_digito1 THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  -- Calcular segundo d√≠gito verificador\r\n  v_soma := 0;\r\n  FOR i IN 1..13 LOOP\r\n    v_soma := v_soma + (SUBSTRING(v_cnpj, i, 1)::INT * v_pesos2[i]);\r\n  END LOOP;\r\n  v_resto := v_soma % 11;\r\n  v_digito2 := CASE WHEN v_resto < 2 THEN 0 ELSE 11 - v_resto END;\r\n  \r\n  -- Verificar segundo d√≠gito\r\n  IF SUBSTRING(v_cnpj, 14, 1)::INT <> v_digito2 THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  RETURN TRUE;\r\nEND;\r\n"
  },
  {
    "function_name": "validar_cpf",
    "function_code": "\r\nDECLARE\r\n  v_cpf TEXT;\r\n  v_soma INT;\r\n  v_resto INT;\r\n  v_digito1 INT;\r\n  v_digito2 INT;\r\n  i INT;\r\nBEGIN\r\n  -- Limpar para ter apenas n√∫meros\r\n  v_cpf := REGEXP_REPLACE(p_cpf, '[^0-9]', '', 'g');\r\n  \r\n  -- Verificar se tem 11 d√≠gitos\r\n  IF LENGTH(v_cpf) <> 11 THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  -- Verificar se todos os d√≠gitos s√£o iguais (CPF inv√°lido)\r\n  IF v_cpf ~ '^(\\d)\\1{10}$' THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  -- Calcular primeiro d√≠gito verificador\r\n  v_soma := 0;\r\n  FOR i IN 1..9 LOOP\r\n    v_soma := v_soma + (SUBSTRING(v_cpf, i, 1)::INT * (11 - i));\r\n  END LOOP;\r\n  v_resto := v_soma % 11;\r\n  v_digito1 := CASE WHEN v_resto < 2 THEN 0 ELSE 11 - v_resto END;\r\n  \r\n  -- Verificar primeiro d√≠gito\r\n  IF SUBSTRING(v_cpf, 10, 1)::INT <> v_digito1 THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  -- Calcular segundo d√≠gito verificador\r\n  v_soma := 0;\r\n  FOR i IN 1..10 LOOP\r\n    v_soma := v_soma + (SUBSTRING(v_cpf, i, 1)::INT * (12 - i));\r\n  END LOOP;\r\n  v_resto := v_soma % 11;\r\n  v_digito2 := CASE WHEN v_resto < 2 THEN 0 ELSE 11 - v_resto END;\r\n  \r\n  -- Verificar segundo d√≠gito\r\n  IF SUBSTRING(v_cpf, 11, 1)::INT <> v_digito2 THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  RETURN TRUE;\r\nEND;\r\n"
  },
  {
    "function_name": "vector",
    "function_code": "vector"
  },
  {
    "function_name": "vector_accum",
    "function_code": "vector_accum"
  },
  {
    "function_name": "vector_add",
    "function_code": "vector_add"
  },
  {
    "function_name": "vector_avg",
    "function_code": "vector_avg"
  },
  {
    "function_name": "vector_cmp",
    "function_code": "vector_cmp"
  },
  {
    "function_name": "vector_combine",
    "function_code": "vector_combine"
  },
  {
    "function_name": "vector_concat",
    "function_code": "vector_concat"
  },
  {
    "function_name": "vector_dims",
    "function_code": "halfvec_vector_dims"
  },
  {
    "function_name": "vector_dims",
    "function_code": "vector_dims"
  },
  {
    "function_name": "vector_eq",
    "function_code": "vector_eq"
  },
  {
    "function_name": "vector_ge",
    "function_code": "vector_ge"
  },
  {
    "function_name": "vector_gt",
    "function_code": "vector_gt"
  },
  {
    "function_name": "vector_in",
    "function_code": "vector_in"
  },
  {
    "function_name": "vector_l2_squared_distance",
    "function_code": "vector_l2_squared_distance"
  },
  {
    "function_name": "vector_le",
    "function_code": "vector_le"
  },
  {
    "function_name": "vector_lt",
    "function_code": "vector_lt"
  },
  {
    "function_name": "vector_mul",
    "function_code": "vector_mul"
  },
  {
    "function_name": "vector_ne",
    "function_code": "vector_ne"
  },
  {
    "function_name": "vector_negative_inner_product",
    "function_code": "vector_negative_inner_product"
  },
  {
    "function_name": "vector_norm",
    "function_code": "vector_norm"
  },
  {
    "function_name": "vector_out",
    "function_code": "vector_out"
  },
  {
    "function_name": "vector_recv",
    "function_code": "vector_recv"
  },
  {
    "function_name": "vector_send",
    "function_code": "vector_send"
  },
  {
    "function_name": "vector_spherical_distance",
    "function_code": "vector_spherical_distance"
  },
  {
    "function_name": "vector_sub",
    "function_code": "vector_sub"
  },
  {
    "function_name": "vector_to_float4",
    "function_code": "vector_to_float4"
  },
  {
    "function_name": "vector_to_halfvec",
    "function_code": "vector_to_halfvec"
  },
  {
    "function_name": "vector_to_sparsevec",
    "function_code": "vector_to_sparsevec"
  },
  {
    "function_name": "vector_typmod_in",
    "function_code": "vector_typmod_in"
  },
  {
    "function_name": "verificar_duplicata",
    "function_code": "\r\nBEGIN\r\n  RETURN EXISTS (\r\n    SELECT 1 FROM zero_documents_thiago \r\n    WHERE content_hash = p_content_hash AND active = true\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "verificar_duplicata",
    "function_code": "\r\nBEGIN\r\n  RETURN EXISTS (\r\n    SELECT 1 FROM saas_documents \r\n    WHERE document_hash = p_content_hash \r\n      AND whatsapp_id = p_whatsapp_id \r\n      AND active = true\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "verificar_limite",
    "function_code": "\r\nDECLARE\r\n  v_client record;\r\n  v_resultado jsonb;\r\nBEGIN\r\n  -- Busca dados do cliente\r\n  SELECT \r\n    status,\r\n    plan,\r\n    trial_ends_at,\r\n    max_reminders,\r\n    max_lists,\r\n    max_transactions_month,\r\n    reminders_count,\r\n    lists_count,\r\n    transactions_month\r\n  INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  -- Cliente n√£o encontrado\r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Cliente n√£o cadastrado'\r\n    );\r\n  END IF;\r\n  \r\n  -- Cliente suspenso ou cancelado\r\n  IF v_client.status IN ('suspended', 'cancelled') THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Conta ' || v_client.status\r\n    );\r\n  END IF;\r\n  \r\n  -- Trial expirado\r\n  IF v_client.status = 'trial' AND v_client.trial_ends_at < NOW() THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Trial expirado. Atualize seu plano.'\r\n    );\r\n  END IF;\r\n  \r\n  -- Verifica√ß√£o por tipo de a√ß√£o\r\n  CASE p_tipo_acao\r\n    \r\n    -- LEMBRETE\r\n    WHEN 'lembrete' THEN\r\n      IF v_client.reminders_count >= v_client.max_reminders THEN\r\n        RETURN jsonb_build_object(\r\n          'permitido', false,\r\n          'motivo', format('Limite de %s lembretes atingido. Plano atual: %s', \r\n                          v_client.max_reminders, v_client.plan)\r\n        );\r\n      END IF;\r\n    \r\n    -- LISTA\r\n    WHEN 'lista' THEN\r\n      IF v_client.lists_count >= v_client.max_lists THEN\r\n        RETURN jsonb_build_object(\r\n          'permitido', false,\r\n          'motivo', format('Limite de %s listas atingido. Plano atual: %s', \r\n                          v_client.max_lists, v_client.plan)\r\n        );\r\n      END IF;\r\n    \r\n    -- TRANSA√á√ÉO FINANCEIRA\r\n    WHEN 'transacao' THEN\r\n      IF v_client.transactions_month >= v_client.max_transactions_month THEN\r\n        RETURN jsonb_build_object(\r\n          'permitido', false,\r\n          'motivo', format('Limite de %s transa√ß√µes/m√™s atingido. Plano atual: %s', \r\n                          v_client.max_transactions_month, v_client.plan)\r\n        );\r\n      END IF;\r\n    \r\n    ELSE\r\n      RETURN jsonb_build_object(\r\n        'permitido', false,\r\n        'motivo', 'Tipo de a√ß√£o inv√°lido'\r\n      );\r\n  END CASE;\r\n  \r\n  -- Tudo OK - permitido\r\n  RETURN jsonb_build_object(\r\n    'permitido', true,\r\n    'motivo', 'OK'\r\n  );\r\n  \r\nEND;\r\n"
  },
  {
    "function_name": "verificar_limite_pesquisa",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\nBEGIN\r\n  -- Busca dados do cliente\r\n  SELECT \r\n    id,\r\n    status,\r\n    plan,\r\n    trial_ends_at,\r\n    max_web_searches_month,\r\n    web_searches_month\r\n  INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  -- Cliente n√£o encontrado\r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Cliente n√£o cadastrado'\r\n    );\r\n  END IF;\r\n  \r\n  -- Cliente suspenso ou cancelado\r\n  IF v_client.status IN ('suspended', 'cancelled') THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Conta ' || v_client.status\r\n    );\r\n  END IF;\r\n  \r\n  -- Trial expirado\r\n  IF v_client.status = 'trial' AND v_client.trial_ends_at < NOW() THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Trial expirado. Atualize seu plano.'\r\n    );\r\n  END IF;\r\n  \r\n  -- Verifica limite de pesquisas (se n√£o for ilimitado)\r\n  IF v_client.max_web_searches_month > 0 AND \r\n     v_client.web_searches_month >= v_client.max_web_searches_month THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', format('Limite de %s pesquisas web/m√™s atingido. Plano: %s', \r\n                      v_client.max_web_searches_month, v_client.plan),\r\n      'limite', v_client.max_web_searches_month,\r\n      'usado', v_client.web_searches_month\r\n    );\r\n  END IF;\r\n  \r\n  -- Permitido\r\n  RETURN jsonb_build_object(\r\n    'permitido', true,\r\n    'motivo', 'OK',\r\n    'limite', v_client.max_web_searches_month,\r\n    'usado', v_client.web_searches_month,\r\n    'disponivel', CASE \r\n      WHEN v_client.max_web_searches_month <= 0 THEN -1\r\n      ELSE v_client.max_web_searches_month - v_client.web_searches_month\r\n    END\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "verificar_limite_rag",
    "function_code": "\r\nDECLARE\r\n  v_client RECORD;\r\nBEGIN\r\n  -- Busca dados do cliente\r\n  SELECT \r\n    id,\r\n    status,\r\n    plan,\r\n    trial_ends_at,\r\n    max_rag_queries_month,\r\n    rag_queries_month,\r\n    max_documents,\r\n    documents_count\r\n  INTO v_client\r\n  FROM saas_clients\r\n  WHERE whatsapp_id = p_whatsapp_id;\r\n  \r\n  -- Cliente n√£o encontrado\r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Cliente n√£o cadastrado'\r\n    );\r\n  END IF;\r\n  \r\n  -- Cliente suspenso ou cancelado\r\n  IF v_client.status IN ('suspended', 'cancelled') THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Conta ' || v_client.status\r\n    );\r\n  END IF;\r\n  \r\n  -- Trial expirado\r\n  IF v_client.status = 'trial' AND v_client.trial_ends_at < NOW() THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', 'Trial expirado. Atualize seu plano.'\r\n    );\r\n  END IF;\r\n  \r\n  -- Verifica limite de consultas RAG (se n√£o for ilimitado)\r\n  IF v_client.max_rag_queries_month > 0 AND \r\n     v_client.rag_queries_month >= v_client.max_rag_queries_month THEN\r\n    RETURN jsonb_build_object(\r\n      'permitido', false,\r\n      'motivo', format('Limite de %s consultas RAG/m√™s atingido. Plano: %s', \r\n                      v_client.max_rag_queries_month, v_client.plan),\r\n      'limite', v_client.max_rag_queries_month,\r\n      'usado', v_client.rag_queries_month\r\n    );\r\n  END IF;\r\n  \r\n  -- Permitido\r\n  RETURN jsonb_build_object(\r\n    'permitido', true,\r\n    'motivo', 'OK',\r\n    'limite', v_client.max_rag_queries_month,\r\n    'usado', v_client.rag_queries_month,\r\n    'disponivel', CASE \r\n      WHEN v_client.max_rag_queries_month <= 0 THEN -1\r\n      ELSE v_client.max_rag_queries_month - v_client.rag_queries_month\r\n    END\r\n  );\r\nEND;\r\n"
  },
  {
    "function_name": "verify_code_and_link_whatsapp",
    "function_code": "\r\nDECLARE\r\n    v_record RECORD;\r\n    v_whatsapp_id TEXT;\r\n    v_existing_client_id UUID;\r\nBEGIN\r\n    -- Normaliza n√∫mero do WhatsApp\r\n    v_whatsapp_id := REGEXP_REPLACE(p_whatsapp_number, '[^0-9]', '', 'g');\r\n    IF NOT v_whatsapp_id LIKE '%@s.whatsapp.net' THEN\r\n        v_whatsapp_id := v_whatsapp_id || '@s.whatsapp.net';\r\n    END IF;\r\n    \r\n    -- Busca c√≥digo v√°lido\r\n    SELECT vc.*, sc.id as client_id, sc.whatsapp_id as current_whatsapp\r\n    INTO v_record\r\n    FROM saas_verification_codes vc\r\n    JOIN saas_clients sc ON sc.id = vc.client_id\r\n    WHERE vc.code = p_code\r\n      AND vc.purpose = 'link_whatsapp'\r\n      AND vc.used_at IS NULL\r\n      AND vc.expires_at > NOW()\r\n      AND vc.attempts < vc.max_attempts;\r\n    \r\n    IF v_record IS NULL THEN\r\n        -- Incrementa tentativas se c√≥digo existe mas √© inv√°lido\r\n        UPDATE saas_verification_codes\r\n        SET attempts = attempts + 1\r\n        WHERE code = p_code AND purpose = 'link_whatsapp';\r\n        \r\n        RETURN jsonb_build_object(\r\n            'success', false,\r\n            'error', 'C√≥digo inv√°lido, expirado ou excedeu tentativas'\r\n        );\r\n    END IF;\r\n    \r\n    -- Verifica se o n√∫mero confere\r\n    IF v_record.target_value != v_whatsapp_id \r\n       AND v_record.target_value != REGEXP_REPLACE(p_whatsapp_number, '[^0-9]', '', 'g') THEN\r\n        UPDATE saas_verification_codes\r\n        SET attempts = attempts + 1\r\n        WHERE id = v_record.id;\r\n        \r\n        RETURN jsonb_build_object(\r\n            'success', false,\r\n            'error', 'N√∫mero n√£o confere com o solicitado'\r\n        );\r\n    END IF;\r\n    \r\n    -- Verifica se WhatsApp j√° est√° vinculado a outro cliente\r\n    SELECT id INTO v_existing_client_id\r\n    FROM saas_clients\r\n    WHERE whatsapp_id = v_whatsapp_id\r\n      AND id != v_record.client_id;\r\n    \r\n    IF v_existing_client_id IS NOT NULL THEN\r\n        RETURN jsonb_build_object(\r\n            'success', false,\r\n            'error', 'Este WhatsApp j√° est√° vinculado a outra conta',\r\n            'existing_client_id', v_existing_client_id\r\n        );\r\n    END IF;\r\n    \r\n    -- Marca c√≥digo como usado\r\n    UPDATE saas_verification_codes\r\n    SET used_at = NOW()\r\n    WHERE id = v_record.id;\r\n    \r\n    -- Vincula WhatsApp ao cliente\r\n    UPDATE saas_clients\r\n    SET \r\n        whatsapp_id = v_whatsapp_id,\r\n        status = CASE WHEN status = 'pending_whatsapp' THEN 'active' ELSE status END,\r\n        onboarding_step = CASE WHEN onboarding_step = 'link_whatsapp' THEN 'completed' ELSE onboarding_step END,\r\n        onboarding_completed = CASE WHEN onboarding_step = 'link_whatsapp' THEN true ELSE onboarding_completed END,\r\n        updated_at = NOW()\r\n    WHERE id = v_record.client_id;\r\n    \r\n    -- Log\r\n    INSERT INTO saas_activity_log (client_id, action, details, source)\r\n    VALUES (\r\n        v_record.client_id,\r\n        'whatsapp_linked',\r\n        jsonb_build_object('whatsapp_id', v_whatsapp_id),\r\n        'portal'\r\n    );\r\n    \r\n    RETURN jsonb_build_object(\r\n        'success', true,\r\n        'message', 'WhatsApp vinculado com sucesso!',\r\n        'client_id', v_record.client_id\r\n    );\r\nEND;\r\n"
  }
]