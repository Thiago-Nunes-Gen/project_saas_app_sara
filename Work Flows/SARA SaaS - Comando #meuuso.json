{
  "name": "SARA SaaS - Comando #meuuso",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT obter_info_uso('{{ $json.whatsapp_id }}') as obter_info_uso;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -16,
        0
      ],
      "id": "d54e1c3c-62f9-4179-98e3-0f01771df5e4",
      "name": "Buscar Info Uso",
      "credentials": {
        "postgres": {
          "id": "2xQBC6Q6FS0TLYyI",
          "name": "Postgres_Zero"
        }
      }
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "whatsapp_id"
            },
            {
              "name": "client_id"
            },
            {
              "name": "telefone"
            },
            {
              "name": "mensagem"
            },
            {
              "name": "instancia"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -224,
        0
      ],
      "id": "18a34528-1f66-424e-b4db-ab7ae8cab127",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('Execute Workflow Trigger').item.json.instancia }}",
        "remoteJid": "={{ $json.telefone }}",
        "messageText": "={{ $json.mensagem_formatada }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        368,
        0
      ],
      "id": "859c95bd-35e6-4c8d-84eb-f8247abe834c",
      "name": "Mensagem #meuuso",
      "credentials": {
        "evolutionApi": {
          "id": "U78J5QaTvwO0ynKA",
          "name": "Evolution SARA_SaaS"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// PARSER #MEUUSO - FORMATADOR DE INFORMAÃ‡ÃƒO DE PLANO\n// VersÃ£o: 1.2 - IncluÃ­do RAG e Pesquisa Web\n// =====================================================\n\n// ===============================\n// 1. BUSCAR DADOS DO TRIGGER E SQL\n// ===============================\nconst triggerData = $('Execute Workflow Trigger').item.json;\nconst sqlResult = $input.first().json;\nconst dados = sqlResult.obter_info_uso || sqlResult;\n\n// Se houve erro no SQL\nif (!dados || dados.status === 'erro') {\n  return [{\n    json: {\n      whatsapp_id: triggerData.whatsapp_id,\n      telefone: triggerData.telefone,\n      mensagem_formatada: 'âŒ NÃ£o consegui buscar informaÃ§Ãµes do seu plano. Tente novamente.'\n    }\n  }];\n}\n\n// ===============================\n// 2. EXTRAIR DADOS\n// ===============================\nconst plano = dados.plano || {};\nconst uso = dados.uso || {};\nconst renovacao = dados.renovacao || {};\nconst alerta = dados.alerta || {};\n\nconst lembretes = uso.lembretes || {};\nconst listas = uso.listas || {};\nconst transacoes = uso.transacoes || {};\nconst rag = uso.rag || {};\nconst pesquisa = uso.pesquisa || {};\n\n// ===============================\n// 3. FUNÃ‡ÃƒO PARA GERAR BARRA DE PROGRESSO\n// ===============================\nfunction gerarBarra(percentual, largura = 10) {\n  if (percentual === null || percentual === undefined) return 'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘';\n  \n  const cheios = Math.round((percentual / 100) * largura);\n  const vazios = largura - cheios;\n  \n  let emoji = 'ğŸŸ©'; // Verde (ok)\n  if (percentual >= 90) emoji = 'ğŸŸ¥'; // Vermelho (crÃ­tico)\n  else if (percentual >= 80) emoji = 'ğŸŸ¨'; // Amarelo (atenÃ§Ã£o)\n  \n  return emoji.repeat(cheios) + 'â¬œ'.repeat(vazios);\n}\n\n// ===============================\n// 4. FUNÃ‡ÃƒO PARA FORMATAR NÃšMERO\n// ===============================\nfunction formatarUso(usado, limite, ilimitado) {\n  if (ilimitado) return `${usado}/âˆ`;\n  return `${usado}/${limite}`;\n}\n\n// ===============================\n// 5. MONTAR MENSAGEM PRINCIPAL\n// ===============================\n\nlet msg = '';\n\n// CabeÃ§alho\nmsg += `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\\n`;\nmsg += `  ğŸ“Š *MEU PLANO - ${plano.nome}*\\n`;\nmsg += `â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n\\n`;\n\n// Status do plano\nmsg += `Status: _${plano.status}_\\n`;\nmsg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// ===============================\n// SEÃ‡ÃƒO: LEMBRETES\n// ===============================\nmsg += `ğŸ“ *Lembretes*\\n`;\nif (lembretes.ilimitado) {\n  msg += `âˆ Ilimitado\\n`;\n  msg += `VocÃª criou ${lembretes.usado} lembretes\\n`;\n} else {\n  msg += `${formatarUso(lembretes.usado, lembretes.limite, lembretes.ilimitado)} (${lembretes.percentual}%)\\n`;\n  msg += `${gerarBarra(lembretes.percentual)}\\n`;\n  msg += `_DisponÃ­vel: ${lembretes.disponivel}_\\n`;\n}\nmsg += `\\n`;\n\n// ===============================\n// SEÃ‡ÃƒO: LISTAS\n// ===============================\nmsg += `ğŸ“‹ *Listas*\\n`;\nif (listas.ilimitado) {\n  msg += `âˆ Ilimitado\\n`;\n  msg += `VocÃª criou ${listas.usado} listas\\n`;\n} else {\n  msg += `${formatarUso(listas.usado, listas.limite, listas.ilimitado)} (${listas.percentual}%)\\n`;\n  msg += `${gerarBarra(listas.percentual)}\\n`;\n  msg += `_DisponÃ­vel: ${listas.disponivel}_\\n`;\n}\nmsg += `\\n`;\n\n// ===============================\n// SEÃ‡ÃƒO: TRANSAÃ‡Ã•ES\n// ===============================\nmsg += `ğŸ’° *TransaÃ§Ãµes (Este MÃªs)*\\n`;\nif (transacoes.ilimitado) {\n  msg += `âˆ Ilimitado\\n`;\n  msg += `VocÃª registrou ${transacoes.usado} transaÃ§Ãµes\\n`;\n} else {\n  msg += `${formatarUso(transacoes.usado, transacoes.limite, transacoes.ilimitado)} (${transacoes.percentual}%)\\n`;\n  msg += `${gerarBarra(transacoes.percentual)}\\n`;\n  msg += `_DisponÃ­vel: ${transacoes.disponivel}_\\n`;\n}\nmsg += `\\n`;\n\n// ===============================\n// SEÃ‡ÃƒO: RAG (DOCUMENTOS)\n// ===============================\nmsg += `ğŸ“š *Consultas em Documentos*\\n`;\nif (rag.ilimitado) {\n  msg += `âˆ Ilimitado\\n`;\n  msg += `VocÃª fez ${rag.consultas_usado} consultas\\n`;\n  msg += `Documentos: ${rag.documentos_usado}/${rag.documentos_limite <= 0 ? 'âˆ' : rag.documentos_limite}\\n`;\n} else {\n  msg += `${formatarUso(rag.consultas_usado, rag.consultas_limite, rag.ilimitado)} (${rag.consultas_percentual}%)\\n`;\n  msg += `${gerarBarra(rag.consultas_percentual)}\\n`;\n  msg += `_DisponÃ­vel: ${rag.consultas_disponivel}_\\n`;\n  msg += `_Docs salvos: ${rag.documentos_usado}/${rag.documentos_limite}_\\n`;\n}\nmsg += `\\n`;\n\n// ===============================\n// SEÃ‡ÃƒO: PESQUISA WEB\n// ===============================\nmsg += `ğŸ” *Pesquisas na Web*\\n`;\nif (pesquisa.ilimitado) {\n  msg += `âˆ Ilimitado\\n`;\n  msg += `VocÃª fez ${pesquisa.usado} pesquisas\\n`;\n} else {\n  msg += `${formatarUso(pesquisa.usado, pesquisa.limite, pesquisa.ilimitado)} (${pesquisa.percentual}%)\\n`;\n  msg += `${gerarBarra(pesquisa.percentual)}\\n`;\n  msg += `_DisponÃ­vel: ${pesquisa.disponivel}_\\n`;\n}\n\nmsg += `\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// ===============================\n// SEÃ‡ÃƒO: RENOVAÃ‡ÃƒO\n// ===============================\nmsg += `ğŸ”„ *RenovaÃ§Ã£o*\\n`;\nmsg += `Data: ${renovacao.data}\\n`;\n\nif (renovacao.dias_restantes > 0) {\n  msg += `â° Faltam ${renovacao.dias_restantes} dia${renovacao.dias_restantes > 1 ? 's' : ''}\\n`;\n} else if (renovacao.dias_restantes === 0) {\n  msg += `â° Renova hoje!\\n`;\n} else {\n  msg += `â° Vencido hÃ¡ ${Math.abs(renovacao.dias_restantes)} dia${Math.abs(renovacao.dias_restantes) > 1 ? 's' : ''}\\n`;\n}\n\nmsg += `\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n`;\n\n// ===============================\n// SEÃ‡ÃƒO: ALERTAS\n// ===============================\n\nif (alerta.nivel === 'critico') {\n  msg += `ğŸš¨ *ALERTA CRÃTICO*\\n`;\n  msg += `VocÃª estÃ¡ perto do limite!\\n`;\n  msg += `Considere fazer upgrade.\\n`;\n  msg += `Digite *#planos* para ver opÃ§Ãµes.\\n\\n`;\n  \n} else if (alerta.nivel === 'atencao') {\n  msg += `âš ï¸ *ATENÃ‡ÃƒO*\\n`;\n  msg += `${alerta.mensagem}\\n`;\n  msg += `Digite *#planos* para ver opÃ§Ãµes.\\n\\n`;\n  \n} else if (plano.nome === 'FREE') {\n  msg += `ğŸ’¡ *Dica*\\n`;\n  msg += `Quer mais recursos?\\n`;\n  msg += `Upgrade para *STARTER* por apenas R$ 19,90/mÃªs!\\n`;\n  msg += `Digite *#planos* para saber mais.\\n\\n`;\n}\n\n// ===============================\n// RODAPÃ‰\n// ===============================\nmsg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n`;\nmsg += `ğŸ’¬ Precisa de ajuda? Estou aqui!`;\n\n// ===============================\n// 6. RETORNAR RESULTADO\n// ===============================\nreturn [{\n  json: {\n    whatsapp_id: triggerData.whatsapp_id,\n    telefone: triggerData.telefone,\n    client_id: triggerData.client_id,\n    mensagem_formatada: msg,\n    dados_brutos: dados // Para debug\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        0
      ],
      "id": "a4cda556-3319-479e-b1a3-f00a2acba92c",
      "name": "Parser Mensagem"
    }
  ],
  "pinData": {
    "Execute Workflow Trigger": [
      {
        "json": {
          "whatsapp_id": "5516997515087",
          "client_id": "fb90a55c-c784-47a1-ab94-4348f65e3a4b",
          "telefone": "5516997515087@s.whatsapp.net",
          "mensagem": "#meuuso",
          "instancia": "SARA_SaaS"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Buscar Info Uso": {
      "main": [
        [
          {
            "node": "Parser Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Buscar Info Uso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser Mensagem": {
      "main": [
        [
          {
            "node": "Mensagem #meuuso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "ce58c754-2c3d-45e2-b533-313ba3713caa",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2162172325255cd265a19f3178f77abb9ab7ec9c7a1d869ba2d2925c11389625"
  },
  "id": "31kGFp87eBrxsrEYNi7-K",
  "tags": []
}